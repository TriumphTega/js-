<!DOCTYPE html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Console - Role Selection</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel="stylesheet" type="text/css" href="/Learning JS/index.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap" rel="stylesheet">
</head>
<body>
    <!-- ============================================
         HEADER SECTION
         Shows user info and navigation
    ============================================ -->
    <div id="my-button">
        <button id="backButton">
            <a href="/index.html">Back</a>
        </button>
    </div>

    <!-- Welcome message for new users -->
    <div id="counter">
        <h1 id="welcomeMessage">Welcome to Mission Control</h1>
        <p id="userGreeting" style="color: #FFCC00; font-size: 1.2rem;"></p>
    </div>

    <!-- Current role display (hidden until role is selected) -->
    <div id="roleDisplay" style="display: none; text-align: center; margin: 30px auto; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 10px; max-width: 600px;">
        <h2 style="color: #FFCC00;">Your Role</h2>
        <h3 id="currentRoleName" style="color: white; margin: 10px 0;"></h3>
        <p id="currentRoleLore" style="color: rgba(255,255,255,0.8); font-style: italic;"></p>
        <p id="roleLockMessage" style="color: #FFCC00; margin-top: 10px; font-size: 0.9rem;">üîí Role permanently locked</p>
        <button id="progressBtn" style="margin-top: 20px; padding: 15px 40px; background-color: #FFCC00; color: #1e5128; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.1rem; font-family: 'Orbitron', sans-serif;">Continue to Instructions ‚Üí</button>
    </div>

    <button id="openModalBtn" style="display: block; margin: 20px auto; background-color: green; color: white; padding: 15px 30px; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; font-family: 'Orbitron', sans-serif;">Select Your Role</button>

    <!-- ============================================
         ROLE SELECTION MODAL
         Modal for choosing colony role
    ============================================ -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Choose Your Colony Role:</h2>
            <div class="options-container">
                <label>
                    <input type="radio" name="choice" value="option1">
                    <div class="mainsflex">1. Base Engineer üîß
                        <ul><li><strong>Lore:</strong> Responsible for keeping habitats safe, air systems running, and power online.</li></ul>
                        <ul><li><strong>Perks:</strong> +10% efficiency when upgrading base structures (spends fewer tokens).</li></ul>
                        <ul><li>Daily check-ins give an extra oxygen resource.</li></ul>
                        <ul><li>Unlocks exclusive "Habitat Module" skins.</li></ul>
                    </div>
                </label>

                <label>
                    <input type="radio" name="choice" value="option2">
                    <div class="mainsflex">2. Exploratory Engineer üõ∞Ô∏è
                        <ul><li><strong>Lore:</strong> Specialists who adapt rovers, drones, and equipment for expeditions.</li></ul>
                        <ul><li><strong>Perks:</strong> +5% Lunaris earned from exploration tasks (walking, outdoor activities).</li></ul>
                        <ul><li>Unlocks early access to the Red Dunes Zone.</li></ul>
                        <ul><li>Rare chance of finding bonus "Martian Mineral NFTs" on quests.</li></ul>
                    </div>
                </label>

                <label>
                    <input type="radio" name="choice" value="option3">
                    <div class="mainsflex">3. Food Tech & Survival Skills Expert üå±
                        <ul><li><strong>Lore:</strong> Masters of hydroponics, rationing, and making Martian soil fertile.</li></ul>
                        <ul><li><strong>Perks:</strong> +10% yield from food/habit tasks (hydration, journaling, sleep).</li></ul>
                        <ul><li>Daily bonus: Hydroponics Tokens (used to trade at Crater Nexus).</li></ul>
                        <ul><li>Special recipes (NFTs) to grow rare crops with token benefits.</li></ul>
                    </div>
                </label>

                <label>
                    <input type="radio" name="choice" value="option4">
                    <div class="mainsflex">4. Comms Specialist üì°
                        <ul><li><strong>Lore:</strong> Maintains communication networks between colonists and Earth.</li></ul>
                        <ul><li><strong>Perks:</strong> +5% staking rewards (better efficiency in DAO/community missions)</li></ul>
                        <ul><li>Ability to broadcast colony-wide boosts (mini-events).</li></ul>
                        <ul><li>Exclusive cosmetic perks: animated holographic badges.</li></ul>
                    </div>
                </label>

                <label>
                    <input type="radio" name="choice" value="option5">
                    <div class="mainsflex">5. Resource Miner ‚õèÔ∏è
                        <ul><li><strong>Lore:</strong> Extracts raw materials from Martian crust for colony use.</li></ul>
                        <ul><li><strong>Perks:</strong> +15% efficiency when gathering rare resources.</li></ul>
                        <ul><li>Bonus NFT drops when participating in mining missions.</li></ul>
                        <ul><li>Unlocks special trade deals at Crater Nexus.</li></ul>
                    </div>
                </label>

                <label>
                    <input type="radio" name="choice" value="option6">
                    <div class="mainsflex">6. Medical Officer ü©∫
                        <ul><li><strong>Lore:</strong> Ensures colonists remain healthy and fit for survival.</li></ul>
                        <ul><li><strong>Perks:</strong> +5% daily token boost when logging wellness tasks (sleep, hydration).</li></ul>
                        <ul><li>Ability to "heal" other colonists in co-op missions (share buffs).</li></ul>
                        <ul><li>Special gear: medical pods that double as collectibles.</li></ul>
                    </div>
                </label>

                <label>
                    <input type="radio" name="choice" value="option7">
                    <div class="mainsflex">7. Navigator üåå
                        <ul><li><strong>Lore:</strong> Charts safe paths across dunes, craters, and ice caps.</li></ul>
                        <ul><li><strong>Perks:</strong> Shortens time/requirements for exploration quests.</li></ul>
                        <ul><li>Unlocks fast travel between colony zones.</li></ul>
                        <ul><li>Extra bonus tokens for completing streaks.</li></ul>
                    </div>
                </label>
            </div>
            <button id="confirmChoiceBtn">Confirm Selection</button>
        </div>
    </div>

    <!-- ============================================
         INSTRUCTIONS MODAL
         Explains how the app works
    ============================================ -->
    <div id="instructionsModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-instructions">&times;</span>
            <h2 style="color: #FFCC00; text-align: center;">üöÄ How Lunaris Works</h2>

            <div style="text-align: left; padding: 20px; line-height: 1.8;">
                <h3 style="color: #FFCC00; margin-top: 20px;">üìã Your Mission</h3>
                <p>Lunaris is a productivity and to-do app with a Mars colony theme. Your role determines the bonuses and perks you receive as you complete tasks and build your colony.</p>

                <h3 style="color: #FFCC00; margin-top: 20px;">üéØ Core Features</h3>
                <ul style="margin-left: 20px;">
                    <li><strong>Task Management:</strong> Create and complete daily missions (to-dos)</li>
                    <li><strong>Role-Based Perks:</strong> Your selected role gives you unique bonuses</li>
                    <li><strong>Progress Tracking:</strong> Track streaks, earn rewards, and level up</li>
                    <li><strong>Colony Building:</strong> Unlock new zones and upgrades as you progress</li>
                </ul>

                <h3 style="color: #FFCC00; margin-top: 20px;">‚ö° How Your Role Works</h3>
                <p id="roleInstructions">Your role is now <strong>permanently locked</strong>. Each time you complete tasks, your role's perks will automatically apply bonus rewards and efficiency boosts.</p>

                <h3 style="color: #FFCC00; margin-top: 20px;">üéÆ Getting Started</h3>
                <ol style="margin-left: 20px;">
                    <li>Create your first mission task below</li>
                    <li>Complete tasks to earn Lunaris tokens</li>
                    <li>Track your daily streaks for bonus multipliers</li>
                    <li>Unlock new colony zones and features</li>
                </ol>

                <h3 style="color: #FFCC00; margin-top: 20px;">üí° Pro Tips</h3>
                <ul style="margin-left: 20px;">
                    <li>Daily check-ins maximize your role's bonus rewards</li>
                    <li>Completing task streaks unlocks special perks</li>
                    <li>Your role's lore adds flavor to your experience</li>
                    <li>Notes page available for journaling and planning</li>
                </ul>

                <div style="text-align: center; margin-top: 30px;">
                    <button id="startMissionsBtn" style="padding: 15px 40px; background-color: #FFCC00; color: #1e5128; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.2rem; font-family: 'Orbitron', sans-serif;">üöÄ Start Your Missions!</button>
                </div>
            </div>
        </div>
    </div>


    <!-- ============================================
         FIREBASE SDK & ROLE MANAGEMENT
         Handles role selection and storage
    ============================================ -->
    <script type="module">
        /* =============================================
           üìã CODE SECTIONS QUICK REFERENCE
           =============================================

           Line 186-235:  FIREBASE CONFIG - Firebase initialization
           Line 237-312:  ROLE DATA - All 7 roles with perks defined
           Line 314-382:  USER SESSION - Detects new users & existing roles
           Line 384-454:  MODAL MANAGEMENT - Role selection & instructions modals
           Line 456-521:  ROLE SELECTION HANDLER - Saves & locks role permanently
           Line 523-548:  DISPLAY FUNCTIONS - Shows role info on page
           Line 550-574:  GLOBAL FUNCTIONS - Access role data from other pages

           üîë KEY FEATURES:
           - Roles are PERMANENTLY LOCKED after selection
           - Progress button opens instructions modal
           - Instructions explain how the app works
           - "Start Your Missions!" button redirects to dashboard.html
           - Role perks accessible via window.getUserRole()
           - Colony dashboard moved to separate dashboard.html page
        */

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // ============================================
        // FIREBASE CONFIGURATION
        // Connects to Firebase services
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyClPgII54QDvJB3kiV1dWbqm1et_lHasvs",
            authDomain: "lunaris-45d84.firebaseapp.com",
            projectId: "lunaris-45d84",
            storageBucket: "lunaris-45d84.firebasestorage.app",
            messagingSenderId: "74359858445",
            appId: "1:74359858445:web:37772cebcbb0d71d707c44",
            measurementId: "G-ETRK2NL1N2",
            databaseURL: "https://lunaris-45d84-default-rtdb.firebaseio.com"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // ============================================
        // ROLE DATA CONFIGURATION
        // Defines all available roles and their properties
        // ============================================
        const ROLES = {
            'option1': {
                name: 'Base Engineer',
                emoji: 'üîß',
                lore: 'Responsible for keeping habitats safe, air systems running, and power online.',
                perks: {
                    efficiency: 1.10,  // +10% efficiency
                    dailyBonus: 'oxygen',
                    specialUnlock: 'Habitat Module Skins'
                }
            },
            'option2': {
                name: 'Exploratory Engineer',
                emoji: 'üõ∞Ô∏è',
                lore: 'Specialists who adapt rovers, drones, and equipment for expeditions.',
                perks: {
                    earningBoost: 1.05,  // +5% Lunaris earned
                    zoneAccess: 'Red Dunes Zone',
                    specialUnlock: 'Martian Mineral NFTs'
                }
            },
            'option3': {
                name: 'Food Tech & Survival Expert',
                emoji: 'üå±',
                lore: 'Masters of hydroponics, rationing, and making Martian soil fertile.',
                perks: {
                    taskYield: 1.10,  // +10% yield from tasks
                    dailyBonus: 'hydroponics',
                    specialUnlock: 'Rare Crop Recipes'
                }
            },
            'option4': {
                name: 'Comms Specialist',
                emoji: 'üì°',
                lore: 'Maintains communication networks between colonists and Earth.',
                perks: {
                    stakingBonus: 1.05,  // +5% staking rewards
                    specialAbility: 'Colony Broadcasts',
                    specialUnlock: 'Holographic Badges'
                }
            },
            'option5': {
                name: 'Resource Miner',
                emoji: '‚õèÔ∏è',
                lore: 'Extracts raw materials from Martian crust for colony use.',
                perks: {
                    miningEfficiency: 1.15,  // +15% efficiency
                    specialUnlock: 'Mining NFT Drops',
                    tradingBonus: 'Crater Nexus Deals'
                }
            },
            'option6': {
                name: 'Medical Officer',
                emoji: 'ü©∫',
                lore: 'Ensures colonists remain healthy and fit for survival.',
                perks: {
                    wellnessBonus: 1.05,  // +5% wellness task bonus
                    specialAbility: 'Heal Others',
                    specialUnlock: 'Medical Pods'
                }
            },
            'option7': {
                name: 'Navigator',
                emoji: 'üåå',
                lore: 'Charts safe paths across dunes, craters, and ice caps.',
                perks: {
                    questSpeed: 0.85,  // 15% faster quests
                    fastTravel: true,
                    streakBonus: 1.10  // +10% streak bonus
                }
            }
        };

        // ============================================
        // USER SESSION MANAGEMENT
        // Handles user data from sign-up or existing session
        // ============================================
        let currentUser = null;
        let currentRole = null;

        // Check if user just signed up
        const newUserData = localStorage.getItem('newUserSignup');
        if (newUserData) {
            currentUser = JSON.parse(newUserData);
            document.getElementById('userGreeting').textContent = `Welcome, ${currentUser.name}! üöÄ`;
            document.getElementById('welcomeMessage').textContent = 'Mission Control - Choose Your Role';
        }

        // Check if user already has a role
        const existingRole = localStorage.getItem('userRole');
        if (existingRole) {
            currentRole = JSON.parse(existingRole);
            displayCurrentRole();
        }

        // ============================================
        // MODAL MANAGEMENT
        // Controls opening/closing role selection modal
        // ============================================
        const openBtn = document.getElementById('openModalBtn');
        const modal = document.getElementById('myModal');
        const closeBtn = document.querySelector('.close-btn');
        const confirmBtn = document.getElementById('confirmChoiceBtn');

        // Instructions modal elements
        const instructionsModal = document.getElementById('instructionsModal');
        const closeInstructions = document.querySelector('.close-instructions');
        const progressBtn = document.getElementById('progressBtn');
        const startMissionsBtn = document.getElementById('startMissionsBtn');

        // Auto-open modal for new users
        if (newUserData && !existingRole) {
            setTimeout(() => {
                modal.style.display = 'block';
            }, 500);
        }

        // Open modal on button click (only if role not locked)
        openBtn.addEventListener('click', () => {
            if (currentRole && currentRole.locked) {
                alert('üîí Your role is permanently locked! Role changes are not available at this time.');
                return;
            }
            modal.style.display = 'block';
        });

        // Close modal on X click
        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        // ============================================
        // INSTRUCTIONS MODAL MANAGEMENT
        // Handles instructions/explanation modal
        // ============================================

        // Open instructions when Progress button is clicked
        progressBtn.addEventListener('click', () => {
            instructionsModal.style.display = 'block';

            // Customize instructions with user's role
            const roleInstructionsText = document.getElementById('roleInstructions');
            if (currentRole) {
                roleInstructionsText.innerHTML = `As a <strong>${currentRole.emoji} ${currentRole.name}</strong>, your perks are now <strong>permanently locked</strong>. ${currentRole.lore}<br><br>Each time you complete tasks, your role's perks will automatically apply bonus rewards and efficiency boosts.`;
            }
        });

        // Close instructions modal
        closeInstructions.addEventListener('click', () => {
            instructionsModal.style.display = 'none';
        });

        // Start missions button - redirects to dashboard page
        startMissionsBtn.addEventListener('click', () => {
            instructionsModal.style.display = 'none';
            // Redirect to the new dashboard page
            window.location.href = '/Learning JS/dashboard.html';
        });

        // Close modal on outside click
        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
            if (event.target === instructionsModal) {
                instructionsModal.style.display = 'none';
            }
        });

        // ============================================
        // ROLE SELECTION HANDLER
        // Saves selected role to Firebase and localStorage
        // ============================================
        confirmBtn.addEventListener('click', async () => {
            const selected = document.querySelector('input[name="choice"]:checked');

            if (!selected) {
                alert('Please select a role!');
                return;
            }

            const roleValue = selected.value;
            const roleData = ROLES[roleValue];

            if (!roleData) {
                alert('Invalid role selected!');
                return;
            }

            try {
                // ============================================
                // PERMANENT ROLE LOCK
                // Role is saved to Firebase and can't be changed
                // ============================================

                // Save role to Firebase if user signed up
                if (currentUser && currentUser.signupId) {
                    const userRef = ref(database, `colony-signups/${currentUser.signupId}`);
                    await update(userRef, {
                        role: roleValue,
                        roleName: roleData.name,
                        roleSelectedAt: Date.now(),
                        roleLocked: true  // Permanent lock
                    });
                    console.log('Role permanently saved to Firebase!');
                }

                // Save role to localStorage for quick access
                const roleInfo = {
                    value: roleValue,
                    name: roleData.name,
                    emoji: roleData.emoji,
                    lore: roleData.lore,
                    perks: roleData.perks,
                    selectedAt: Date.now(),
                    locked: true  // Permanent lock flag
                };

                localStorage.setItem('userRole', JSON.stringify(roleInfo));
                currentRole = roleInfo;

                // Clear new user flag
                if (newUserData) {
                    localStorage.removeItem('newUserSignup');
                    // Keep user data in a permanent location
                    localStorage.setItem('userData', newUserData);
                }

                // Success message with role-specific greeting
                alert(`üéâ Role confirmed! You are now a ${roleData.name} ${roleData.emoji}\n\n${roleData.lore}`);

                // Close modal and display role
                modal.style.display = 'none';
                displayCurrentRole();

            } catch (error) {
                console.error('Error saving role:', error);
                alert('Error saving role: ' + error.message);
            }
        });

        // ============================================
        // DISPLAY CURRENT ROLE
        // Shows user's selected role and perks
        // ============================================
        function displayCurrentRole() {
            if (!currentRole) return;

            const roleDisplay = document.getElementById('roleDisplay');
            const roleName = document.getElementById('currentRoleName');
            const roleLore = document.getElementById('currentRoleLore');

            roleName.textContent = `${currentRole.emoji} ${currentRole.name}`;
            roleLore.textContent = currentRole.lore;

            roleDisplay.style.display = 'block';
            document.getElementById('openModalBtn').style.display = 'none';
        }

        // ============================================
        // GLOBAL ROLE ACCESS
        // Makes role and perks available to other pages
        // ============================================
        window.getUserRole = function() {
            return currentRole;
        };

        window.applyRolePerks = function(baseValue, perkType) {
            if (!currentRole || !currentRole.perks) return baseValue;

            const perk = currentRole.perks[perkType];
            if (typeof perk === 'number') {
                return baseValue * perk;  // Apply multiplier
            }
            return baseValue;
        };

        // Log role for debugging
        if (currentRole) {
            console.log('Current Role:', currentRole);
            console.log('Available Perks:', currentRole.perks);
        }

    </script>

    <!-- Original index.js for any existing functionality -->
    <script src='/Learning JS/index.js'></script>
</body>
</html>
