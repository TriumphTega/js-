<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Console - Role Selection</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel="stylesheet" href="/Learning JS/console.css">
</head>
<body>
    <div id="app-container">
        <!-- Header Section -->
        <div class="header-section">
            <h1 class="page-title">🎯 Mission Control</h1>
            <p class="user-greeting" id="userGreeting"></p>

            <!-- User Profile Section -->
            <div class="user-profile-section" id="userProfileSection" style="display: none;">
                <div class="profile-display">
                    <div class="profile-info">
                        <div class="profile-name" id="profileDisplayName"></div>
                        <div class="profile-email" id="profileEmail"></div>
                    </div>
                    <button class="edit-name-btn" id="editNameBtn">✏️ Edit Name</button>
                </div>
            </div>

            <a href="/index.html" class="nav-btn">← Back to Home</a>
        </div>

        <!-- Role Display (shown after role selection) -->
        <div class="role-display" id="roleDisplay">
            <h2>Your Role</h2>
            <div class="role-name" id="currentRoleName"></div>
            <p class="role-lore" id="currentRoleLore"></p>
            <p class="role-lock-message">🔒 Role permanently locked</p>
            <button id="progressBtn" class="btn">Continue to Instructions →</button>
        </div>

        <!-- Select Role Button (hidden after role is selected) -->
        <div style="text-align: center;">
            <button id="openModalBtn" class="btn btn-secondary">🚀 Select Your Role</button>
        </div>
    </div>

    <!-- Role Selection Modal -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-btn" id="closeModal">&times;</span>
                <h2>Choose Your Colony Role</h2>
            </div>
            <div class="modal-body">
                <div class="options-container">
                    <label class="role-option">
                        <input type="radio" name="choice" value="option1">
                        <div class="role-content">
                            <div class="role-title">🔧 Base Engineer</div>
                            <ul>
                                <li><strong>Lore:</strong> Responsible for keeping habitats safe, air systems running, and power online.</li>
                                <li><strong>Perks:</strong> +10% efficiency when upgrading base structures.</li>
                                <li>Daily check-ins give extra oxygen resource.</li>
                                <li>Unlocks exclusive "Habitat Module" skins.</li>
                            </ul>
                        </div>
                    </label>

                    <label class="role-option">
                        <input type="radio" name="choice" value="option2">
                        <div class="role-content">
                            <div class="role-title">🛰️ Exploratory Engineer</div>
                            <ul>
                                <li><strong>Lore:</strong> Specialists who adapt rovers, drones, and equipment for expeditions.</li>
                                <li><strong>Perks:</strong> +5% Lunaris earned from exploration tasks.</li>
                                <li>Unlocks early access to the Red Dunes Zone.</li>
                                <li>Rare chance of finding bonus "Martian Mineral NFTs".</li>
                            </ul>
                        </div>
                    </label>

                    <label class="role-option">
                        <input type="radio" name="choice" value="option3">
                        <div class="role-content">
                            <div class="role-title">🌱 Food Tech & Survival Expert</div>
                            <ul>
                                <li><strong>Lore:</strong> Masters of hydroponics, rationing, and making Martian soil fertile.</li>
                                <li><strong>Perks:</strong> +10% yield from food/habit tasks.</li>
                                <li>Daily bonus: Hydroponics Tokens.</li>
                                <li>Special recipes (NFTs) to grow rare crops.</li>
                            </ul>
                        </div>
                    </label>

                    <label class="role-option">
                        <input type="radio" name="choice" value="option4">
                        <div class="role-content">
                            <div class="role-title">📡 Comms Specialist</div>
                            <ul>
                                <li><strong>Lore:</strong> Maintains communication networks between colonists and Earth.</li>
                                <li><strong>Perks:</strong> +5% staking rewards.</li>
                                <li>Ability to broadcast colony-wide boosts.</li>
                                <li>Exclusive holographic badges.</li>
                            </ul>
                        </div>
                    </label>

                    <label class="role-option">
                        <input type="radio" name="choice" value="option5">
                        <div class="role-content">
                            <div class="role-title">⛏️ Resource Miner</div>
                            <ul>
                                <li><strong>Lore:</strong> Extracts raw materials from Martian crust for colony use.</li>
                                <li><strong>Perks:</strong> +15% efficiency gathering rare resources.</li>
                                <li>Bonus NFT drops on mining missions.</li>
                                <li>Unlocks special trade deals at Crater Nexus.</li>
                            </ul>
                        </div>
                    </label>

                    <label class="role-option">
                        <input type="radio" name="choice" value="option6">
                        <div class="role-content">
                            <div class="role-title">🩺 Medical Officer</div>
                            <ul>
                                <li><strong>Lore:</strong> Ensures colonists remain healthy and fit for survival.</li>
                                <li><strong>Perks:</strong> +5% daily boost logging wellness tasks.</li>
                                <li>Ability to "heal" other colonists in co-op missions.</li>
                                <li>Special gear: medical pods as collectibles.</li>
                            </ul>
                        </div>
                    </label>

                    <label class="role-option">
                        <input type="radio" name="choice" value="option7">
                        <div class="role-content">
                            <div class="role-title">🌌 Navigator</div>
                            <ul>
                                <li><strong>Lore:</strong> Charts safe paths across dunes, craters, and ice caps.</li>
                                <li><strong>Perks:</strong> Shortens time for exploration quests.</li>
                                <li>Unlocks fast travel between colony zones.</li>
                                <li>Extra bonus tokens for completing streaks.</li>
                            </ul>
                        </div>
                    </label>
                </div>

                <button id="confirmChoiceBtn" class="confirm-btn">✓ Confirm Selection</button>
            </div>
        </div>
    </div>

    <!-- Instructions Modal -->
    <div id="instructionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-btn" id="closeInstructions">&times;</span>
                <h2>🚀 How Lunaris Works</h2>
            </div>
            <div class="modal-body">
                <div class="instructions-section">
                    <h3>📋 Your Mission</h3>
                    <p>Lunaris is a productivity and to-do app with a Mars colony theme. Your role determines the bonuses and perks you receive as you complete tasks and build your colony.</p>

                    <h3>🎯 Core Features</h3>
                    <ul>
                        <li><strong>Task Management:</strong> Create and complete daily missions (to-dos)</li>
                        <li><strong>Role-Based Perks:</strong> Your selected role gives you unique bonuses</li>
                        <li><strong>Progress Tracking:</strong> Track streaks, earn rewards, and level up</li>
                        <li><strong>Colony Building:</strong> Unlock new zones and upgrades as you progress</li>
                    </ul>

                    <h3>⚡ How Your Role Works</h3>
                    <p id="roleInstructions">Your role is now <strong>permanently locked</strong>. Each time you complete tasks, your role's perks will automatically apply bonus rewards and efficiency boosts.</p>

                    <h3>🎮 Getting Started</h3>
                    <ol>
                        <li>Create your first mission task</li>
                        <li>Complete tasks to earn Lunaris tokens</li>
                        <li>Track your daily streaks for bonus multipliers</li>
                        <li>Unlock new colony zones and features</li>
                    </ol>

                    <h3>💡 Pro Tips</h3>
                    <ul>
                        <li>Daily check-ins maximize your role's bonus rewards</li>
                        <li>Completing task streaks unlocks special perks</li>
                        <li>Your role's lore adds flavor to your experience</li>
                        <li>Notes page available for journaling and planning</li>
                    </ul>

                    <div style="text-align: center; margin-top: 30px;">
                        <button id="startMissionsBtn" class="btn">🚀 Start Your Missions!</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Name Modal -->
    <div id="editNameModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-btn" id="closeEditName">&times;</span>
                <h2>✏️ Edit Your Name</h2>
            </div>
            <div class="modal-body">
                <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 20px; text-align: center;">
                    Change how your name appears in Lunaris
                </p>
                <div style="margin-bottom: 15px;">
                    <label style="color: #FFCC00; font-weight: bold; display: block; margin-bottom: 8px;">Display Name:</label>
                    <input type="text" id="newDisplayName" placeholder="Enter your new name" class="form-input" style="width: 100%; padding: 12px; border: 2px solid #FFCC00; border-radius: 8px; background: rgba(255, 255, 255, 0.95); color: #1e5128; font-family: 'Courier New', Courier, monospace; font-size: 1rem;">
                </div>
                <button id="saveNameBtn" class="confirm-btn">💾 Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Firebase & JavaScript -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyClPgII54QDvJB3kiV1dWbqm1et_lHasvs",
            authDomain: "lunaris-45d84.firebaseapp.com",
            projectId: "lunaris-45d84",
            storageBucket: "lunaris-45d84.firebasestorage.app",
            messagingSenderId: "74359858445",
            appId: "1:74359858445:web:37772cebcbb0d71d707c44",
            measurementId: "G-ETRK2NL1N2",
            databaseURL: "https://lunaris-45d84-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Role data
        const ROLES = {
            'option1': {
                name: 'Base Engineer',
                emoji: '🔧',
                lore: 'Responsible for keeping habitats safe, air systems running, and power online.',
                perks: {
                    efficiency: 1.10,
                    dailyBonus: 'oxygen',
                    specialUnlock: 'Habitat Module Skins'
                }
            },
            'option2': {
                name: 'Exploratory Engineer',
                emoji: '🛰️',
                lore: 'Specialists who adapt rovers, drones, and equipment for expeditions.',
                perks: {
                    earningBoost: 1.05,
                    zoneAccess: 'Red Dunes Zone',
                    specialUnlock: 'Martian Mineral NFTs'
                }
            },
            'option3': {
                name: 'Food Tech & Survival Expert',
                emoji: '🌱',
                lore: 'Masters of hydroponics, rationing, and making Martian soil fertile.',
                perks: {
                    taskYield: 1.10,
                    dailyBonus: 'hydroponics',
                    specialUnlock: 'Rare Crop Recipes'
                }
            },
            'option4': {
                name: 'Comms Specialist',
                emoji: '📡',
                lore: 'Maintains communication networks between colonists and Earth.',
                perks: {
                    stakingBonus: 1.05,
                    colonyBoosts: true,
                    specialUnlock: 'Holographic Badges'
                }
            },
            'option5': {
                name: 'Resource Miner',
                emoji: '⛏️',
                lore: 'Extracts raw materials from Martian crust for colony use.',
                perks: {
                    miningEfficiency: 1.15,
                    nftDrops: true,
                    specialUnlock: 'Crater Nexus Deals'
                }
            },
            'option6': {
                name: 'Medical Officer',
                emoji: '🩺',
                lore: 'Ensures colonists remain healthy and fit for survival.',
                perks: {
                    wellnessBonus: 1.05,
                    healAbility: true,
                    specialUnlock: 'Medical Pods'
                }
            },
            'option7': {
                name: 'Navigator',
                emoji: '🌌',
                lore: 'Charts safe paths across dunes, craters, and ice caps.',
                perks: {
                    questSpeed: 0.85,
                    fastTravel: true,
                    streakBonus: 1.10
                }
            }
        };

        // Check for existing role or new user
        let currentUser = null;
        let currentRole = null;

        const savedRole = localStorage.getItem('userRole');
        const newUserSignup = localStorage.getItem('newUserSignup');

        if (savedRole) {
            currentRole = JSON.parse(savedRole);
            displayExistingRole();
        } else if (newUserSignup) {
            currentUser = JSON.parse(newUserSignup);
            document.getElementById('userGreeting').textContent = `Welcome, ${currentUser.name}! Select your role to begin.`;
        }

        // Modal management
        const modal = document.getElementById('myModal');
        const instructionsModal = document.getElementById('instructionsModal');
        const openModalBtn = document.getElementById('openModalBtn');
        const closeModal = document.getElementById('closeModal');
        const closeInstructions = document.getElementById('closeInstructions');
        const confirmBtn = document.getElementById('confirmChoiceBtn');
        const progressBtn = document.getElementById('progressBtn');
        const startMissionsBtn = document.getElementById('startMissionsBtn');

        openModalBtn.addEventListener('click', () => {
            modal.style.display = 'block';
        });

        closeModal.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        closeInstructions.addEventListener('click', () => {
            instructionsModal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === modal) modal.style.display = 'none';
            if (e.target === instructionsModal) instructionsModal.style.display = 'none';
        });

        // Role selection
        confirmBtn.addEventListener('click', () => {
            const selected = document.querySelector('input[name="choice"]:checked');
            if (!selected) {
                alert('Please select a role first!');
                return;
            }

            const roleValue = selected.value;
            const roleData = ROLES[roleValue];

            saveRole(roleValue, roleData);
        });

        async function saveRole(roleValue, roleData) {
            const roleInfo = {
                value: roleValue,
                name: roleData.name,
                emoji: roleData.emoji,
                lore: roleData.lore,
                perks: roleData.perks,
                selectedAt: Date.now(),
                locked: true
            };

            localStorage.setItem('userRole', JSON.stringify(roleInfo));

            if (currentUser && currentUser.signupId) {
                const userRef = ref(database, `colony-signups/${currentUser.signupId}`);
                await update(userRef, {
                    role: roleValue,
                    roleName: roleData.name,
                    roleSelectedAt: Date.now(),
                    roleLocked: true
                });
            }

            localStorage.removeItem('newUserSignup');
            currentRole = roleInfo;
            modal.style.display = 'none';
            displayExistingRole();
        }

        function displayExistingRole() {
            document.getElementById('openModalBtn').style.display = 'none';
            document.getElementById('roleDisplay').style.display = 'block';
            document.getElementById('currentRoleName').textContent = `${currentRole.emoji} ${currentRole.name}`;
            document.getElementById('currentRoleLore').textContent = currentRole.lore;
        }

        progressBtn.addEventListener('click', () => {
            instructionsModal.style.display = 'block';
        });

        startMissionsBtn.addEventListener('click', () => {
            instructionsModal.style.display = 'none';
            window.location.href = '/Learning JS/dashboard.html';
        });

        // ============================================
        // USER PROFILE & NAME EDITING
        // ============================================

        let authenticatedUser = null;

        // Monitor auth state and load user data
        onAuthStateChanged(auth, (user) => {
            if (user) {
                authenticatedUser = user;
                loadUserProfile(user);
            }
        });

        // Load user profile from localStorage/Firebase
        function loadUserProfile(user) {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                const userData = JSON.parse(savedUser);

                // Display profile section
                document.getElementById('userProfileSection').style.display = 'block';
                document.getElementById('profileDisplayName').textContent = userData.displayName || user.displayName || user.email;
                document.getElementById('profileEmail').textContent = user.email;
            }
        }

        // Edit Name Modal
        const editNameModal = document.getElementById('editNameModal');
        const editNameBtn = document.getElementById('editNameBtn');
        const closeEditName = document.getElementById('closeEditName');
        const saveNameBtn = document.getElementById('saveNameBtn');
        const newDisplayNameInput = document.getElementById('newDisplayName');

        editNameBtn.addEventListener('click', () => {
            // Pre-fill current name
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                newDisplayNameInput.value = userData.displayName || authenticatedUser?.displayName || '';
            }
            editNameModal.style.display = 'block';
        });

        closeEditName.addEventListener('click', () => {
            editNameModal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === editNameModal) {
                editNameModal.style.display = 'none';
            }
        });

        saveNameBtn.addEventListener('click', async () => {
            const newName = newDisplayNameInput.value.trim();

            if (!newName) {
                alert('Please enter a valid name!');
                return;
            }

            if (!authenticatedUser) {
                alert('You must be signed in to change your name.');
                return;
            }

            try {
                // Update localStorage
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    const userData = JSON.parse(savedUser);
                    userData.displayName = newName;
                    localStorage.setItem('currentUser', JSON.stringify(userData));
                }

                // Update Firebase user-profiles node
                const userProfileRef = ref(database, `user-profiles/${authenticatedUser.uid}`);
                await update(userProfileRef, {
                    displayName: newName,
                    email: authenticatedUser.email,
                    updatedAt: Date.now()
                });

                // Update display
                document.getElementById('profileDisplayName').textContent = newName;

                // Close modal
                editNameModal.style.display = 'none';

                alert(`✅ Name updated to "${newName}"!`);
            } catch (error) {
                console.error('Error updating name:', error);
                alert('Failed to update name. Please try again.');
            }
        });

        // Global functions for other pages
        window.getUserRole = function() {
            const role = localStorage.getItem('userRole');
            return role ? JSON.parse(role) : null;
        };

        window.applyRolePerks = function(baseValue, perkType) {
            const role = window.getUserRole();
            if (role && role.perks[perkType]) {
                return baseValue * role.perks[perkType];
            }
            return baseValue;
        };
    </script>
</body>
</html>
