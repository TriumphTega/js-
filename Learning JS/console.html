<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Console - Role Selection</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel="stylesheet" href="/Learning JS/console.css">
</head>
<body>
    <div id="app-container">
        <!-- Header Section -->
        <div class="header-section">
            <h1 class="page-title">üéØ Mission Control</h1>
            <p class="user-greeting" id="userGreeting"></p>

            <!-- User Profile Section -->
            <div class="user-profile-section" id="userProfileSection" style="display: none;">
                <div class="profile-display">
                    <div class="profile-info">
                        <div class="profile-name" id="profileDisplayName"></div>
                        <div class="profile-email" id="profileEmail"></div>
                    </div>
                    <button class="edit-name-btn" id="editNameBtn">‚úèÔ∏è Edit Name</button>
                </div>
            </div>

            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <a href="/Learning JS/roadmap.html" class="nav-btn">üó∫Ô∏è Roadmap</a>
                <a href="/Learning JS/chatroom.html" class="nav-btn">üí¨ Chat</a>
                <a href="/Learning JS/dashboard.html" class="nav-btn">üöÄ Dashboard</a>
                <a href="/index.html" class="nav-btn">‚Üê Back to Home</a>
            </div>
        </div>

        <!-- Role Display (shown after role selection) -->
        <div class="role-display" id="roleDisplay">
            <h2>Your Role</h2>
            <div class="role-name" id="currentRoleName"></div>
            <p class="role-lore" id="currentRoleLore"></p>
            <p class="role-lock-message">üîí Role permanently locked</p>

            <!-- XP & Progress Section -->
            <div class="xp-section">
                <div class="xp-header">
                    <div class="level-badge">
                        <span class="level-label">LEVEL</span>
                        <span class="level-number" id="currentLevel">1</span>
                    </div>
                    <div class="xp-info">
                        <span id="xpText">0 / 100 XP</span>
                    </div>
                </div>

                <div class="xp-bar-container">
                    <div class="xp-bar-fill" id="xpBarFill" style="width: 0%"></div>
                    <div class="xp-bar-glow" id="xpBarGlow" style="width: 0%"></div>
                </div>

                <div class="progress-milestones">
                    <div class="milestone-item">
                        <div class="milestone-icon">üìÖ</div>
                        <div class="milestone-details">
                            <div class="milestone-label">Login Days</div>
                            <div class="milestone-value" id="loginDaysText">0 / 30 days</div>
                        </div>
                    </div>
                    <div class="milestone-item">
                        <div class="milestone-icon">üèóÔ∏è</div>
                        <div class="milestone-details">
                            <div class="milestone-label">Next Base</div>
                            <div class="milestone-value" id="nextBaseText">Crater Nexus (Lvl 10)</div>
                        </div>
                    </div>
                </div>

                <div class="unlock-progress" id="unlockProgress">
                    <div class="unlock-message">
                        <span id="unlockStatusText">üîí Complete requirements to unlock Crater Nexus</span>
                    </div>
                    <div class="requirements-checklist">
                        <div class="requirement-item" id="req-level">
                            <span class="req-icon">‚≠ê</span>
                            <span class="req-text">Reach Level 10</span>
                            <span class="req-status" id="req-level-status">0/10</span>
                        </div>
                        <div class="requirement-item" id="req-days">
                            <span class="req-icon">üìÖ</span>
                            <span class="req-text">Login for 30 total days</span>
                            <span class="req-status" id="req-days-status">0/30</span>
                        </div>
                    </div>
                </div>
            </div>

            <button id="progressBtn" class="btn">Continue to Instructions ‚Üí</button>
        </div>

        <!-- Select Role Button (hidden after role is selected) -->
        <div style="text-align: center;">
            <button id="openModalBtn" class="btn btn-secondary">üöÄ Select Your Role</button>
        </div>
    </div>

    <!-- Role Selection Modal -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-btn" id="closeModal">&times;</span>
                <h2>Choose Your Colony Role</h2>
            </div>
            <div class="modal-body">
                <div class="options-container">
                    <label class="role-option">
                        <input type="radio" name="choice" value="option1">
                        <div class="role-content">
                            <div class="role-title">üîß Base Engineer</div>
                            <ul>
                                <li><strong>Lore:</strong> Responsible for keeping habitats safe, air systems running, and power online.</li>
                                <li><strong>Perks:</strong> +10% efficiency when upgrading base structures.</li>
                                <li>Daily check-ins give extra oxygen resource.</li>
                                <li>Unlocks exclusive "Habitat Module" skins.</li>
                            </ul>
                        </div>
                    </label>

                    <label class="role-option">
                        <input type="radio" name="choice" value="option2">
                        <div class="role-content">
                            <div class="role-title">üõ∞Ô∏è Exploratory Engineer</div>
                            <ul>
                                <li><strong>Lore:</strong> Specialists who adapt rovers, drones, and equipment for expeditions.</li>
                                <li><strong>Perks:</strong> +5% Lunaris earned from exploration tasks.</li>
                                <li>Unlocks early access to the Red Dunes Zone.</li>
                                <li>Rare chance of finding bonus "Martian Mineral NFTs".</li>
                            </ul>
                        </div>
                    </label>

                    <label class="role-option">
                        <input type="radio" name="choice" value="option3">
                        <div class="role-content">
                            <div class="role-title">üå± Food Tech & Survival Expert</div>
                            <ul>
                                <li><strong>Lore:</strong> Masters of hydroponics, rationing, and making Martian soil fertile.</li>
                                <li><strong>Perks:</strong> +10% yield from food/habit tasks.</li>
                                <li>Daily bonus: Hydroponics Tokens.</li>
                                <li>Special recipes (NFTs) to grow rare crops.</li>
                            </ul>
                        </div>
                    </label>

                    <label class="role-option">
                        <input type="radio" name="choice" value="option4">
                        <div class="role-content">
                            <div class="role-title">üì° Comms Specialist</div>
                            <ul>
                                <li><strong>Lore:</strong> Maintains communication networks between colonists and Earth.</li>
                                <li><strong>Perks:</strong> +5% staking rewards.</li>
                                <li>Ability to broadcast colony-wide boosts.</li>
                                <li>Exclusive holographic badges.</li>
                            </ul>
                        </div>
                    </label>

                    <label class="role-option">
                        <input type="radio" name="choice" value="option5">
                        <div class="role-content">
                            <div class="role-title">‚õèÔ∏è Resource Miner</div>
                            <ul>
                                <li><strong>Lore:</strong> Extracts raw materials from Martian crust for colony use.</li>
                                <li><strong>Perks:</strong> +15% efficiency gathering rare resources.</li>
                                <li>Bonus NFT drops on mining missions.</li>
                                <li>Unlocks special trade deals at Crater Nexus.</li>
                            </ul>
                        </div>
                    </label>

                    <label class="role-option">
                        <input type="radio" name="choice" value="option6">
                        <div class="role-content">
                            <div class="role-title">ü©∫ Medical Officer</div>
                            <ul>
                                <li><strong>Lore:</strong> Ensures colonists remain healthy and fit for survival.</li>
                                <li><strong>Perks:</strong> +5% daily boost logging wellness tasks.</li>
                                <li>Ability to "heal" other colonists in co-op missions.</li>
                                <li>Special gear: medical pods as collectibles.</li>
                            </ul>
                        </div>
                    </label>

                    <label class="role-option">
                        <input type="radio" name="choice" value="option7">
                        <div class="role-content">
                            <div class="role-title">üåå Navigator</div>
                            <ul>
                                <li><strong>Lore:</strong> Charts safe paths across dunes, craters, and ice caps.</li>
                                <li><strong>Perks:</strong> Shortens time for exploration quests.</li>
                                <li>Unlocks fast travel between colony zones.</li>
                                <li>Extra bonus tokens for completing streaks.</li>
                            </ul>
                        </div>
                    </label>
                </div>

                <button id="confirmChoiceBtn" class="confirm-btn">‚úì Confirm Selection</button>
            </div>
        </div>
    </div>

    <!-- Instructions Modal -->
    <div id="instructionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-btn" id="closeInstructions">&times;</span>
                <h2>üöÄ How Lunaris Works</h2>
            </div>
            <div class="modal-body">
                <div class="instructions-section">
                    <h3>üìã Your Mission</h3>
                    <p>Lunaris is a productivity and to-do app with a Mars colony theme. Your role determines the bonuses and perks you receive as you complete tasks and build your colony.</p>

                    <h3>üéØ Core Features</h3>
                    <ul>
                        <li><strong>Task Management:</strong> Create and complete daily missions (to-dos)</li>
                        <li><strong>Role-Based Perks:</strong> Your selected role gives you unique bonuses</li>
                        <li><strong>Progress Tracking:</strong> Track streaks, earn rewards, and level up</li>
                        <li><strong>Colony Building:</strong> Unlock new zones and upgrades as you progress</li>
                    </ul>

                    <h3>‚ö° How Your Role Works</h3>
                    <p id="roleInstructions">Your role is now <strong>permanently locked</strong>. Each time you complete tasks, your role's perks will automatically apply bonus rewards and efficiency boosts.</p>

                    <h3>üéÆ Getting Started</h3>
                    <ol>
                        <li>Create your first mission task</li>
                        <li>Complete tasks to earn Lunaris tokens</li>
                        <li>Track your daily streaks for bonus multipliers</li>
                        <li>Unlock new colony zones and features</li>
                    </ol>

                    <h3>üí° Pro Tips</h3>
                    <ul>
                        <li>Daily check-ins maximize your role's bonus rewards</li>
                        <li>Completing task streaks unlocks special perks</li>
                        <li>Your role's lore adds flavor to your experience</li>
                        <li>Notes page available for journaling and planning</li>
                    </ul>

                    <div style="text-align: center; margin-top: 30px;">
                        <button id="startMissionsBtn" class="btn">üöÄ Start Your Missions!</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Name Modal -->
    <div id="editNameModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-btn" id="closeEditName">&times;</span>
                <h2>‚úèÔ∏è Edit Your Name</h2>
            </div>
            <div class="modal-body">
                <p class="modal-description">
                    Change how your name appears in Lunaris
                </p>
                <div class="form-group">
                    <label class="form-label">Display Name:</label>
                    <input type="text" id="newDisplayName" placeholder="Enter your new name" class="form-input">
                </div>
                <button id="saveNameBtn" class="confirm-btn">üíæ Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Alerts -->
    <div id="custom-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-btn" id="closeCustomModal">&times;</span>
                <h2 id="modal-title"></h2>
            </div>
            <div class="modal-body">
                <div id="modal-icon" style="font-size: 48px; text-align: center; margin-bottom: 20px;"></div>
                <div id="modal-message" style="text-align: center; margin-bottom: 20px;"></div>
                <div style="text-align: center;">
                    <button id="modal-ok-btn" class="confirm-btn">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Floating Button -->
    <a href="/Learning JS/admin.html" class="admin-float-btn" id="admin-btn" title="Admin Dashboard">
        ‚öôÔ∏è
    </a>

    <!-- Firebase & JavaScript -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, update, get, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyClPgII54QDvJB3kiV1dWbqm1et_lHasvs",
            authDomain: "lunaris-45d84.firebaseapp.com",
            projectId: "lunaris-45d84",
            storageBucket: "lunaris-45d84.firebasestorage.app",
            messagingSenderId: "74359858445",
            appId: "1:74359858445:web:37772cebcbb0d71d707c44",
            measurementId: "G-ETRK2NL1N2",
            databaseURL: "https://lunaris-45d84-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Role data
        const ROLES = {
            'option1': {
                name: 'Base Engineer',
                emoji: 'üîß',
                lore: 'Responsible for keeping habitats safe, air systems running, and power online.',
                perks: {
                    efficiency: 1.10,
                    dailyBonus: 'oxygen',
                    specialUnlock: 'Habitat Module Skins'
                }
            },
            'option2': {
                name: 'Exploratory Engineer',
                emoji: 'üõ∞Ô∏è',
                lore: 'Specialists who adapt rovers, drones, and equipment for expeditions.',
                perks: {
                    earningBoost: 1.05,
                    zoneAccess: 'Red Dunes Zone',
                    specialUnlock: 'Martian Mineral NFTs'
                }
            },
            'option3': {
                name: 'Food Tech & Survival Expert',
                emoji: 'üå±',
                lore: 'Masters of hydroponics, rationing, and making Martian soil fertile.',
                perks: {
                    taskYield: 1.10,
                    dailyBonus: 'hydroponics',
                    specialUnlock: 'Rare Crop Recipes'
                }
            },
            'option4': {
                name: 'Comms Specialist',
                emoji: 'üì°',
                lore: 'Maintains communication networks between colonists and Earth.',
                perks: {
                    stakingBonus: 1.05,
                    colonyBoosts: true,
                    specialUnlock: 'Holographic Badges'
                }
            },
            'option5': {
                name: 'Resource Miner',
                emoji: '‚õèÔ∏è',
                lore: 'Extracts raw materials from Martian crust for colony use.',
                perks: {
                    miningEfficiency: 1.15,
                    nftDrops: true,
                    specialUnlock: 'Crater Nexus Deals'
                }
            },
            'option6': {
                name: 'Medical Officer',
                emoji: 'ü©∫',
                lore: 'Ensures colonists remain healthy and fit for survival.',
                perks: {
                    wellnessBonus: 1.05,
                    healAbility: true,
                    specialUnlock: 'Medical Pods'
                }
            },
            'option7': {
                name: 'Navigator',
                emoji: 'üåå',
                lore: 'Charts safe paths across dunes, craters, and ice caps.',
                perks: {
                    questSpeed: 0.85,
                    fastTravel: true,
                    streakBonus: 1.10
                }
            }
        };

        // Check for existing role or new user
        let currentUser = null;
        let currentRole = null;

        const savedRole = localStorage.getItem('userRole');
        const newUserSignup = localStorage.getItem('newUserSignup');

        if (savedRole) {
            currentRole = JSON.parse(savedRole);
            displayExistingRole();
        } else if (newUserSignup) {
            currentUser = JSON.parse(newUserSignup);
            document.getElementById('userGreeting').textContent = `Welcome, ${currentUser.name}! Select your role to begin.`;
        }

        // Modal management
        const modal = document.getElementById('myModal');
        const instructionsModal = document.getElementById('instructionsModal');
        const openModalBtn = document.getElementById('openModalBtn');
        const closeModal = document.getElementById('closeModal');
        const closeInstructions = document.getElementById('closeInstructions');
        const confirmBtn = document.getElementById('confirmChoiceBtn');
        const progressBtn = document.getElementById('progressBtn');
        const startMissionsBtn = document.getElementById('startMissionsBtn');

        openModalBtn.addEventListener('click', () => {
            modal.style.display = 'block';
        });

        closeModal.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        closeInstructions.addEventListener('click', () => {
            instructionsModal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === modal) modal.style.display = 'none';
            if (e.target === instructionsModal) instructionsModal.style.display = 'none';
        });

        // Role selection
        confirmBtn.addEventListener('click', () => {
            const selected = document.querySelector('input[name="choice"]:checked');
            if (!selected) {
                alert('Please select a role first!');
                return;
            }

            const roleValue = selected.value;
            const roleData = ROLES[roleValue];

            saveRole(roleValue, roleData);
        });

        async function saveRole(roleValue, roleData) {
            const roleInfo = {
                value: roleValue,
                name: roleData.name,
                emoji: roleData.emoji,
                lore: roleData.lore,
                perks: roleData.perks,
                selectedAt: Date.now(),
                locked: true
            };

            localStorage.setItem('userRole', JSON.stringify(roleInfo));

            // Save to Firebase - handle both old signups and authenticated users
            try {
                // Get userId from authenticated user or saved user data
                const userId = authenticatedUser?.uid || currentUser?.uid || currentUser?.signupId;

                if (userId) {
                    // Save to user-profiles (new location)
                    const profileRef = ref(database, `user-profiles/${userId}`);
                    const existingProfile = await get(profileRef);

                    const profileData = existingProfile.exists() ? existingProfile.val() : {};
                    await set(profileRef, {
                        ...profileData,
                        role: roleValue,
                        roleName: roleData.name,
                        roleEmoji: roleData.emoji,
                        roleSelectedAt: Date.now(),
                        roleLocked: true,
                        uid: userId
                    });

                    console.log('‚úÖ Role saved to Firebase user-profiles');

                    // Also save to colony-signups if it exists (for backward compatibility)
                    if (currentUser && currentUser.signupId) {
                        const userRef = ref(database, `colony-signups/${currentUser.signupId}`);
                        await update(userRef, {
                            role: roleValue,
                            roleName: roleData.name,
                            roleSelectedAt: Date.now(),
                            roleLocked: true
                        });
                        console.log('‚úÖ Role saved to Firebase colony-signups');
                    }
                }
            } catch (error) {
                console.error('Error saving role to Firebase:', error);
            }

            localStorage.removeItem('newUserSignup');
            currentRole = roleInfo;
            modal.style.display = 'none';
            displayExistingRole();
        }

        function displayExistingRole() {
            document.getElementById('openModalBtn').style.display = 'none';
            document.getElementById('roleDisplay').style.display = 'block';
            document.getElementById('currentRoleName').textContent = `${currentRole.emoji} ${currentRole.name}`;
            document.getElementById('currentRoleLore').textContent = currentRole.lore;

            // Load and display XP progress
            loadXPProgress();
        }

        // ============================================
        // XP & PROGRESSION SYSTEM
        // ============================================

        const XP_LEVELS = [
            { level: 1, xpRequired: 0 },
            { level: 2, xpRequired: 100 },
            { level: 3, xpRequired: 250 },
            { level: 4, xpRequired: 450 },
            { level: 5, xpRequired: 700 },
            { level: 6, xpRequired: 1000 },
            { level: 7, xpRequired: 1350 },
            { level: 8, xpRequired: 1750 },
            { level: 9, xpRequired: 2200 },
            { level: 10, xpRequired: 2700 }, // Crater Nexus unlock
            { level: 15, xpRequired: 4500 },
            { level: 20, xpRequired: 7000 },
            { level: 25, xpRequired: 10000 }, // Red Dunes unlock
            { level: 30, xpRequired: 13500 },
            { level: 35, xpRequired: 17500 },
            { level: 40, xpRequired: 22000 }, // Arctic Station unlock
            { level: 50, xpRequired: 32000 },
            { level: 60, xpRequired: 44000 },
            { level: 75, xpRequired: 60000 }, // Olympus Summit unlock
            { level: 100, xpRequired: 100000 }
        ];

        const BASE_UNLOCKS = [
            { level: 1, days: 0, name: 'Base Camp Alpha', unlocked: true },
            { level: 10, days: 30, name: 'Crater Nexus', unlocked: false },
            { level: 25, days: 60, name: 'Red Dunes Outpost', unlocked: false },
            { level: 40, days: 90, name: 'Arctic Research Station', unlocked: false },
            { level: 75, days: 180, name: 'Olympus Summit', unlocked: false }
        ];

        async function loadXPProgress() {
            try {
                const userId = authenticatedUser?.uid || currentUser?.uid || currentUser?.walletAddress;
                if (!userId) return;

                const progressRef = ref(database, `user-progress/${userId}`);
                const snapshot = await get(progressRef);

                let xpData = {
                    totalXP: 0,
                    level: 1,
                    loginDays: []
                };

                if (snapshot.exists()) {
                    xpData = snapshot.val();
                }

                updateXPDisplay(xpData);
            } catch (error) {
                console.error('Error loading XP progress:', error);
            }
        }

        function updateXPDisplay(xpData) {
            const totalXP = xpData.totalXP || 0;
            const loginDays = xpData.loginDays || [];

            // Calculate current level
            let currentLevel = 1;
            let currentLevelXP = 0;
            let nextLevelXP = 100;

            for (let i = XP_LEVELS.length - 1; i >= 0; i--) {
                if (totalXP >= XP_LEVELS[i].xpRequired) {
                    currentLevel = XP_LEVELS[i].level;
                    currentLevelXP = XP_LEVELS[i].xpRequired;

                    // Find next level XP
                    if (i < XP_LEVELS.length - 1) {
                        nextLevelXP = XP_LEVELS[i + 1].xpRequired;
                    } else {
                        nextLevelXP = currentLevelXP; // Max level
                    }
                    break;
                }
            }

            // Calculate XP progress within current level
            const xpInLevel = totalXP - currentLevelXP;
            const xpNeededForNext = nextLevelXP - currentLevelXP;
            const xpPercent = currentLevel === 100 ? 100 : (xpInLevel / xpNeededForNext) * 100;

            // Update UI
            document.getElementById('currentLevel').textContent = currentLevel;
            document.getElementById('xpText').textContent = `${totalXP} / ${nextLevelXP} XP`;
            document.getElementById('xpBarFill').style.width = xpPercent + '%';
            document.getElementById('xpBarGlow').style.width = xpPercent + '%';

            // Update login days
            const uniqueLoginDays = [...new Set(loginDays)].length;
            document.getElementById('loginDaysText').textContent = `${uniqueLoginDays} / 30 days`;

            // Determine next base unlock
            let nextBase = null;
            for (const base of BASE_UNLOCKS) {
                if (!base.unlocked && (currentLevel < base.level || uniqueLoginDays < base.days)) {
                    nextBase = base;
                    break;
                }
            }

            if (nextBase) {
                document.getElementById('nextBaseText').textContent = `${nextBase.name} (Lvl ${nextBase.level})`;
                document.getElementById('unlockStatusText').textContent = `üîí Complete requirements to unlock ${nextBase.name}`;

                // Update requirement statuses
                const reqLevel = document.getElementById('req-level');
                const reqDays = document.getElementById('req-days');
                const levelStatus = document.getElementById('req-level-status');
                const daysStatus = document.getElementById('req-days-status');

                levelStatus.textContent = `${currentLevel}/${nextBase.level}`;
                daysStatus.textContent = `${uniqueLoginDays}/${nextBase.days}`;

                if (currentLevel >= nextBase.level) {
                    reqLevel.classList.add('completed');
                } else {
                    reqLevel.classList.remove('completed');
                }

                if (uniqueLoginDays >= nextBase.days) {
                    reqDays.classList.add('completed');
                } else {
                    reqDays.classList.remove('completed');
                }

                // Check if both requirements are met
                if (currentLevel >= nextBase.level && uniqueLoginDays >= nextBase.days) {
                    document.getElementById('unlockStatusText').textContent = `üéâ ${nextBase.name} is now unlocked!`;
                    // You can add logic here to actually unlock the base
                }
            } else {
                document.getElementById('unlockStatusText').textContent = `‚úÖ All bases unlocked!`;
                document.getElementById('unlockProgress').style.display = 'none';
            }
        }

        // Make loadXPProgress available globally for other pages
        window.loadXPProgress = loadXPProgress;
        window.updateXPDisplay = updateXPDisplay;

        progressBtn.addEventListener('click', () => {
            instructionsModal.style.display = 'block';
        });

        startMissionsBtn.addEventListener('click', () => {
            instructionsModal.style.display = 'none';
            window.location.href = '/Learning JS/dashboard.html';
        });

        // ============================================
        // USER PROFILE & NAME EDITING
        // ============================================

        let authenticatedUser = null;

        // Monitor auth state and load user data
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                authenticatedUser = user;
                loadUserProfile(user);

                // Check if user is admin and show admin button
                await checkAdminStatus(user);

                // Check if user has a role saved in Firebase
                await loadUserRoleFromFirebase(user.uid);
            } else {
                // Check for wallet users (not Google auth)
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    const userData = JSON.parse(savedUser);
                    if (userData.walletAddress) {
                        loadUserProfile(null);
                        // Check admin status for wallet users
                        await checkAdminStatusByUserId(userData.uid || userData.walletAddress);
                        // Check for saved role
                        await loadUserRoleFromFirebase(userData.uid || userData.walletAddress);
                    }
                }
            }
        });

        // Load user role from Firebase
        async function loadUserRoleFromFirebase(userId) {
            try {
                console.log('Checking for saved role in Firebase for user:', userId);

                // First check colony-signups (old location)
                const signupRef = ref(database, `colony-signups/${userId}`);
                const signupSnapshot = await get(signupRef);

                if (signupSnapshot.exists() && signupSnapshot.val().role) {
                    const userData = signupSnapshot.val();
                    const roleValue = userData.role;
                    const roleData = ROLES[roleValue];

                    if (roleData) {
                        const roleInfo = {
                            value: roleValue,
                            name: roleData.name,
                            emoji: roleData.emoji,
                            lore: roleData.lore,
                            perks: roleData.perks,
                            selectedAt: userData.roleSelectedAt || Date.now(),
                            locked: true
                        };

                        localStorage.setItem('userRole', JSON.stringify(roleInfo));
                        currentRole = roleInfo;
                        displayExistingRole();
                        console.log('‚úÖ Loaded role from Firebase (colony-signups):', roleData.name);
                        return;
                    }
                }

                // Also check user-profiles (new location)
                const profileRef = ref(database, `user-profiles/${userId}`);
                const profileSnapshot = await get(profileRef);

                if (profileSnapshot.exists() && profileSnapshot.val().role) {
                    const userData = profileSnapshot.val();
                    const roleValue = userData.role;
                    const roleData = ROLES[roleValue];

                    if (roleData) {
                        const roleInfo = {
                            value: roleValue,
                            name: roleData.name,
                            emoji: roleData.emoji,
                            lore: roleData.lore,
                            perks: roleData.perks,
                            selectedAt: userData.roleSelectedAt || Date.now(),
                            locked: true
                        };

                        localStorage.setItem('userRole', JSON.stringify(roleInfo));
                        currentRole = roleInfo;
                        displayExistingRole();
                        console.log('‚úÖ Loaded role from Firebase (user-profiles):', roleData.name);
                        return;
                    }
                }

                console.log('No saved role found in Firebase for this user');
            } catch (error) {
                console.error('Error loading role from Firebase:', error);
            }
        }

        // Load user profile from localStorage/Firebase
        function loadUserProfile(user) {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                const userData = JSON.parse(savedUser);

                // Display profile section
                document.getElementById('userProfileSection').style.display = 'block';
                document.getElementById('profileDisplayName').textContent = userData.displayName || user?.displayName || user?.email || 'User';
                document.getElementById('profileEmail').textContent = user?.email || userData.walletAddress || 'Wallet User';
            }
        }

        // Check admin status and show button if admin
        async function checkAdminStatus(user) {
            await checkAdminStatusByUserId(user.uid);
        }

        async function checkAdminStatusByUserId(userId) {
            try {
                console.log('Checking admin status for user:', userId);
                const adminRef = ref(database, `admins/${userId}`);
                const snapshot = await get(adminRef);

                if (snapshot.exists() && snapshot.val() === true) {
                    // User is admin - show admin button
                    document.getElementById('admin-btn').style.display = 'flex';
                    console.log('‚úÖ Admin access granted for user:', userId);
                } else {
                    console.log('‚ùå User is not an admin. Add this UID to Firebase admins node:', userId);
                }
            } catch (error) {
                console.error('Error checking admin status:', error);
            }
        }

        // Edit Name Modal
        const editNameModal = document.getElementById('editNameModal');
        const editNameBtn = document.getElementById('editNameBtn');
        const closeEditName = document.getElementById('closeEditName');
        const saveNameBtn = document.getElementById('saveNameBtn');
        const newDisplayNameInput = document.getElementById('newDisplayName');

        editNameBtn.addEventListener('click', () => {
            // Pre-fill current name
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                newDisplayNameInput.value = userData.displayName || authenticatedUser?.displayName || '';
            }
            editNameModal.style.display = 'block';
        });

        closeEditName.addEventListener('click', () => {
            editNameModal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === editNameModal) {
                editNameModal.style.display = 'none';
            }
        });

        saveNameBtn.addEventListener('click', async () => {
            const newName = newDisplayNameInput.value.trim();

            if (!newName) {
                showModal('warning', '‚ö†Ô∏è Invalid Name', 'Please enter a valid name!');
                return;
            }

            try {
                // Update localStorage
                const savedUser = localStorage.getItem('currentUser');
                if (!savedUser) {
                    showModal('error', '‚ùå Not Signed In', 'You must be signed in to change your name.');
                    return;
                }

                const userData = JSON.parse(savedUser);
                console.log('Current user data:', userData);

                userData.displayName = newName;
                localStorage.setItem('currentUser', JSON.stringify(userData));
                console.log('‚úÖ localStorage updated with new name');

                // Update Firebase - handle both Google and wallet users
                const userId = authenticatedUser?.uid || userData.uid || userData.walletAddress;
                console.log('Attempting to save to Firebase with userId:', userId);

                if (!userId) {
                    console.error('‚ùå No userId found!');
                    showModal('error', '‚ùå Error', 'Could not find user ID. Please sign out and sign in again.');
                    return;
                }

                if (userId) {
                    const userProfileRef = ref(database, `user-profiles/${userId}`);
                    console.log('Firebase ref path:', `user-profiles/${userId}`);

                    await set(userProfileRef, {
                        displayName: newName,
                        email: userData.email || null,
                        walletAddress: userData.walletAddress || null,
                        uid: userId,
                        updatedAt: Date.now()
                    });
                    console.log('‚úÖ Name updated successfully in Firebase');
                }

                // Update display
                document.getElementById('profileDisplayName').textContent = newName;

                // Close modal
                editNameModal.style.display = 'none';

                showModal('success', '‚úÖ Success!', `Name updated to "${newName}"!`);
            } catch (error) {
                console.error('‚ùå Error updating name:', error);
                console.error('Error details:', error.message, error.code);
                showModal('error', '‚ùå Failed to Update', `Error: ${error.message || 'Unknown error'}<br><br>Check the browser console for details.`);
            }
        });

        // ============================================
        // CUSTOM MODAL SYSTEM
        // ============================================

        function showModal(type, title, message) {
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalIcon = document.getElementById('modal-icon');
            const modalMessage = document.getElementById('modal-message');
            const okBtn = document.getElementById('modal-ok-btn');
            const closeBtn = document.getElementById('closeCustomModal');

            modalTitle.textContent = title;
            modalMessage.innerHTML = message;

            // Set icon based on type
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            modalIcon.textContent = icons[type] || 'üí¨';

            modal.style.display = 'block';

            okBtn.onclick = () => {
                modal.style.display = 'none';
            };

            closeBtn.onclick = () => {
                modal.style.display = 'none';
            };

            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Global functions for other pages
        window.getUserRole = function() {
            const role = localStorage.getItem('userRole');
            return role ? JSON.parse(role) : null;
        };

        window.applyRolePerks = function(baseValue, perkType) {
            const role = window.getUserRole();
            if (role && role.perks[perkType]) {
                return baseValue * role.perks[perkType];
            }
            return baseValue;
        };
    </script>
</body>
</html>
