<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Colony Dashboard - Lunaris</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel="stylesheet" href="/Learning JS/dashboard.css">
</head>
<body>
    <div id="app-container">
        <!-- Header -->
        <div id="page-header">
            <h1 id="page-title">üöÄ Colony Dashboard</h1>
            <div id="nav-buttons">
                <button id="walletBtn" class="nav-btn wallet-btn">üëõ Wallet</button>
                <a href="/Learning JS/roadmap.html" class="nav-btn">üó∫Ô∏è Roadmap</a>
                <a href="/Learning JS/chatroom.html" class="nav-btn">üí¨ Chat</a>
                <a href="/Learning JS/notes.html" class="nav-btn">üìù Notes</a>
                <a href="/Learning JS/console.html" class="nav-btn">‚öôÔ∏è Console</a>
                <a href="/index.html" class="nav-btn secondary">‚Üê Home</a>
            </div>
        </div>

        <!-- User Role Display -->
        <div id="user-role-header" style="display: none;">
            <span>Your Role:</span>
            <span id="header-role-name"></span>
        </div>

        <!-- Resource Dashboard -->
        <div class="dashboard-section">
            <h2 class="section-title">üè† Base Camp Alpha - Resource Status</h2>

            <div class="resource-grid">
                <div class="resource-card lunaris">
                    <div class="resource-icon">üí∞</div>
                    <div class="resource-label">Lunaris Tokens</div>
                    <div class="resource-value" id="lunaris-display">0</div>
                </div>

                <div class="resource-card oxygen">
                    <div class="resource-icon">üí®</div>
                    <div class="resource-label">Oxygen</div>
                    <div class="resource-value" id="oxygen-display">100%</div>
                </div>

                <div class="resource-card hydroponics">
                    <div class="resource-icon">üå±</div>
                    <div class="resource-label">Hydroponics</div>
                    <div class="resource-value" id="hydroponics-display">100%</div>
                </div>

                <div class="resource-card energy">
                    <div class="resource-icon">‚ö°</div>
                    <div class="resource-label">Energy</div>
                    <div class="resource-value" id="energy-display">100%</div>
                </div>
            </div>

            <div class="streak-display">
                <span>üî• Current Streak:</span>
                <span class="streak-value" id="streak-display">0 days</span>
            </div>
        </div>

        <!-- Daily Check-in -->
        <div class="dashboard-section">
            <h2 class="section-title">üìã Morning Colony Report</h2>

            <div id="check-in-status" style="text-align: center;">
                <button id="daily-check-in-btn" class="btn">üåÖ Complete Daily Check-In</button>
                <p id="check-in-message" style="color: rgba(255,255,255,0.7); margin-top: 15px;">Start your day and earn bonus tokens!</p>
            </div>

            <div id="check-in-options">
                <p style="color: #FFCC00; text-align: center; margin-bottom: 15px;">Select your priority task for today:</p>
                <div class="check-in-grid">
                    <button class="check-in-option oxygen" data-resource="oxygen">üí® Check Oxygen Systems</button>
                    <button class="check-in-option hydroponics" data-resource="hydroponics">üå± Water Hydroponics</button>
                    <button class="check-in-option energy" data-resource="energy">‚ö° Inspect Energy Grid</button>
                </div>
            </div>
        </div>

        <!-- Task Management -->
        <div class="dashboard-section">
            <h2 class="section-title">üéØ Daily Colony Missions</h2>

            <!-- Create Task Form -->
            <div style="background: rgba(255,204,0,0.1); border-radius: 10px; padding: 25px; margin-bottom: 25px; border: 2px solid rgba(255,204,0,0.2);">
                <h3 style="color: #FFCC00; margin-bottom: 20px;">Create New Mission</h3>

                <div class="form-group">
                    <select id="task-type-select" class="form-select">
                        <option value="">-- Select Mission Type --</option>
                        <option value="hydration">üíß Water Hydroponics (Drink Water)</option>
                        <option value="exploration">üö∂ Collect Geological Samples (Go for Walk)</option>
                        <option value="logging">üìù File Colony Log (Journal/Note)</option>
                        <option value="energy">üò¥ Restore Energy (Sleep Early)</option>
                        <option value="maintenance">üîß Base Maintenance (Clean/Organize)</option>
                        <option value="research">üî¨ Research Project (Study/Learn)</option>
                        <option value="communication">üì° Communications Check (Social Connection)</option>
                        <option value="fitness">üí™ Gravity Adaptation Training (Gym/Exercise)</option>
                        <option value="custom">‚úèÔ∏è Custom Mission</option>
                    </select>
                </div>

                <div class="form-group">
                    <input type="text" id="task-desc-input" placeholder="Mission details (optional)" class="form-input">
                </div>

                <div class="form-group">
                    <label class="form-label">‚è±Ô∏è Time Commitment (minutes):</label>
                    <input type="number" id="time-commitment" min="1" max="240" value="25" class="form-input">
                    <p class="form-hint">Focus Mode will activate for this duration. Leave early = penalties!</p>
                </div>

                <button id="create-task-btn" class="btn" style="width: 100%;">+ Create Mission</button>
            </div>

            <!-- Active Tasks -->
            <div>
                <h3 style="color: #FFCC00; margin-bottom: 15px;">Active Missions</h3>
                <div id="tasks-list" class="tasks-list">
                    <p class="empty-message">No active missions. Create your first mission above!</p>
                </div>
            </div>

            <!-- Completed Tasks -->
            <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid rgba(255,204,0,0.3);">
                <h3 style="color: #FFCC00; margin-bottom: 15px;">‚úÖ Completed Today</h3>
                <div id="completed-tasks-list" class="tasks-list">
                    <p class="empty-message">No missions completed yet today.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Focus Mode Screen -->
    <div id="focus-mode-screen">
        <div class="focus-container">
            <h1 class="focus-title">üîí FOCUS MODE ACTIVE</h1>

            <div id="focus-task-name" class="focus-task-name"></div>

            <div class="timer-display">
                <div class="time-remaining" id="time-remaining">00:00</div>
                <div class="timer-label">Time Remaining</div>
            </div>

            <div class="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>

            <div class="focus-warning" id="focus-warning">
                <p class="warning-title">‚ö†Ô∏è TAB CHANGE DETECTED!</p>
                <p class="warning-text">Return to this tab or face penalties!</p>
            </div>

            <p class="focus-instructions">
                Stay focused, colonist. Leaving early will result in:<br>
                <span class="penalty-text">-10 Lunaris | Mission Failed | Streak Reset</span>
            </p>

            <button id="emergency-exit" class="emergency-exit">‚ùå Emergency Exit (Penalties Apply)</button>
        </div>
    </div>

    <!-- Custom Modal -->
    <div id="custom-modal" class="custom-modal">
        <div class="modal-dialog">
            <div class="modal-content-custom">
                <div class="modal-header-custom">
                    <h2 class="modal-title-custom" id="modal-title"></h2>
                </div>
                <div class="modal-body-custom">
                    <div class="modal-icon" id="modal-icon"></div>
                    <div class="modal-message" id="modal-message"></div>
                    <div class="modal-buttons" id="modal-buttons"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Wallet Modal -->
    <div id="walletModal" class="modal">
        <div class="modal-content wallet-modal-content">
            <div class="modal-header">
                <span class="close-btn" id="closeWallet">&times;</span>
                <h2>üëõ Your Wallet</h2>
            </div>
            <div class="modal-body">
                <!-- Wallet Address Section -->
                <div class="wallet-section">
                    <div class="wallet-address-container">
                        <label class="form-label">Wallet Address:</label>
                        <div class="address-display">
                            <span id="walletAddressDisplay">Loading...</span>
                            <button id="copyAddressBtn" class="icon-btn" title="Copy Address">üìã</button>
                        </div>
                    </div>
                </div>

                <!-- Balance Section -->
                <div class="wallet-section">
                    <div class="balance-display">
                        <div class="balance-label">SOL Balance</div>
                        <div class="balance-value" id="solBalanceDisplay">0.00</div>
                        <button id="refreshBalanceBtn" class="refresh-btn">üîÑ Refresh</button>
                    </div>
                </div>

                <!-- Tabs for Send/Receive -->
                <div class="wallet-tabs">
                    <button class="wallet-tab active" data-tab="send">üì§ Send</button>
                    <button class="wallet-tab" data-tab="receive">üì• Receive</button>
                </div>

                <!-- Send Tab Content -->
                <div id="sendTab" class="tab-content active">
                    <div class="form-group">
                        <label class="form-label">Recipient Address:</label>
                        <input type="text" id="recipientAddress" placeholder="Enter Solana address" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount (SOL):</label>
                        <input type="number" id="sendAmount" placeholder="0.00" step="0.01" min="0" class="form-input">
                    </div>
                    <button id="sendTokenBtn" class="confirm-btn">üì§ Send SOL</button>
                </div>

                <!-- Receive Tab Content -->
                <div id="receiveTab" class="tab-content">
                    <div class="receive-section">
                        <p class="modal-description">Share this address to receive SOL and tokens</p>
                        <div class="qr-code-container" id="qrCodeContainer">
                            <!-- QR code will be generated here -->
                        </div>
                        <div class="address-display large">
                            <span id="receiveAddressDisplay">Loading...</span>
                            <button id="copyReceiveAddressBtn" class="icon-btn" title="Copy Address">üìã</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Floating Button -->
    <a href="/Learning JS/admin.html" class="admin-float-btn" id="admin-btn" title="Admin Dashboard">
        ‚öôÔ∏è
    </a>

    <!-- Solana Web3.js -->
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@latest/lib/index.iife.min.js"></script>

    <!-- Firebase & Dashboard Logic -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, update, get, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyClPgII54QDvJB3kiV1dWbqm1et_lHasvs",
            authDomain: "lunaris-45d84.firebaseapp.com",
            projectId: "lunaris-45d84",
            storageBucket: "lunaris-45d84.firebasestorage.app",
            messagingSenderId: "74359858445",
            appId: "1:74359858445:web:37772cebcbb0d71d707c44",
            measurementId: "G-ETRK2NL1N2",
            databaseURL: "https://lunaris-45d84-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Load user role and data
        let currentRole = null;
        let currentUser = null;
        let userUID = null;

        const savedRole = localStorage.getItem('userRole');
        if (savedRole) {
            currentRole = JSON.parse(savedRole);
            document.getElementById('user-role-header').style.display = 'block';
            document.getElementById('header-role-name').textContent = `${currentRole.emoji} ${currentRole.name}`;
        }

        // Get current authenticated user
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            userUID = currentUser.uid;
        }

        // Monitor auth state to ensure user is authenticated
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userUID = user.uid;

                // Load custom display name from Firebase
                const customName = await loadCustomDisplayName(user.uid);

                currentUser = {
                    uid: user.uid,
                    email: user.email,
                    displayName: customName || user.displayName,
                    photoURL: user.photoURL
                };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                console.log('User authenticated:', user.email);
                console.log('Display name:', currentUser.displayName);

                // Check admin access
                checkAdminAccess(user);

                // Reload data when auth state changes
                if (!colonyData.lunaris && !colonyData.tasks.length) {
                    initializeDashboard();
                }
            } else {
                console.log('No user authenticated');
            }
        });

        // Load custom display name from Firebase user-profiles
        async function loadCustomDisplayName(userId) {
            try {
                const userProfileRef = ref(database, `user-profiles/${userId}`);
                const snapshot = await get(userProfileRef);

                if (snapshot.exists() && snapshot.val().displayName) {
                    console.log('‚úÖ Loaded custom display name from Firebase:', snapshot.val().displayName);
                    return snapshot.val().displayName;
                }
            } catch (error) {
                console.error('Error loading custom display name:', error);
            }
            return null;
        }

        // ============================================
        // CUSTOM MODAL SYSTEM
        // Beautiful modals replacing alert/confirm
        // ============================================

        function showModal(type, title, message, callback) {
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalIcon = document.getElementById('modal-icon');
            const modalMessage = document.getElementById('modal-message');
            const modalButtons = document.getElementById('modal-buttons');

            modalTitle.textContent = title;
            modalMessage.textContent = message;

            // Set icon based on type
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è',
                confirm: '‚ùì'
            };
            modalIcon.textContent = icons[type] || 'üí¨';

            // Clear previous buttons
            modalButtons.innerHTML = '';

            // Add OK button
            const okBtn = document.createElement('button');
            okBtn.className = 'modal-btn modal-btn-primary';
            okBtn.textContent = 'OK';
            okBtn.onclick = () => {
                modal.style.display = 'none';
                if (callback) callback(true);
            };
            modalButtons.appendChild(okBtn);

            modal.style.display = 'block';

            // Close on outside click
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    if (callback) callback(false);
                }
            };
        }

        function showConfirm(title, message, onConfirm, onCancel) {
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalIcon = document.getElementById('modal-icon');
            const modalMessage = document.getElementById('modal-message');
            const modalButtons = document.getElementById('modal-buttons');

            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalIcon.textContent = '‚ùì';

            // Clear previous buttons
            modalButtons.innerHTML = '';

            // Add Cancel button
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'modal-btn modal-btn-secondary';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.onclick = () => {
                modal.style.display = 'none';
                if (onCancel) onCancel();
            };
            modalButtons.appendChild(cancelBtn);

            // Add Confirm button
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'modal-btn modal-btn-primary';
            confirmBtn.textContent = 'Confirm';
            confirmBtn.onclick = () => {
                modal.style.display = 'none';
                if (onConfirm) onConfirm();
            };
            modalButtons.appendChild(confirmBtn);

            modal.style.display = 'block';

            // Close on outside click = cancel
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    if (onCancel) onCancel();
                }
            };
        }

        // ============================================
        // ADMIN ACCESS CHECK
        // Shows admin button only for admins
        // ============================================

        async function checkAdminAccess(user) {
            if (!user) return false;

            try {
                const adminRef = ref(database, `admins/${user.uid}`);
                const snapshot = await get(adminRef);

                if (snapshot.exists()) {
                    // User is admin - show admin button
                    document.getElementById('admin-btn').style.display = 'flex';
                    console.log('Admin access granted');
                    return true;
                }
            } catch (error) {
                console.error('Error checking admin access:', error);
            }
            return false;
        }

        // Colony data
        let colonyData = {
            lunaris: 0,
            oxygen: 100,
            hydroponics: 100,
            energy: 100,
            streak: 0,
            lastCheckIn: null,
            tasks: [],
            completedToday: [],
            failedTasks: []
        };

        // Task types
        const TASK_TYPES = {
            hydration: {
                name: 'üíß Water Hydroponics',
                baseReward: 10,
                resources: { hydroponics: 5 },
                perkType: 'taskYield'
            },
            exploration: {
                name: 'üö∂ Collect Geological Samples',
                baseReward: 15,
                resources: { oxygen: 3, energy: -5 },
                perkType: 'earningBoost'
            },
            logging: {
                name: 'üìù File Colony Log',
                baseReward: 8,
                resources: { energy: 2 },
                perkType: 'taskYield'
            },
            energy: {
                name: 'üò¥ Restore Energy',
                baseReward: 12,
                resources: { energy: 10 },
                perkType: 'wellnessBonus'
            },
            maintenance: {
                name: 'üîß Base Maintenance',
                baseReward: 10,
                resources: { oxygen: 3, energy: -3 },
                perkType: 'efficiency'
            },
            research: {
                name: 'üî¨ Research Project',
                baseReward: 20,
                resources: { energy: -8 },
                perkType: 'earningBoost'
            },
            communication: {
                name: 'üì° Communications Check',
                baseReward: 12,
                resources: { energy: 2 },
                perkType: 'stakingBonus'
            },
            fitness: {
                name: 'üí™ Gravity Adaptation Training',
                baseReward: 15,
                resources: { energy: -10, oxygen: -3 },
                perkType: 'wellnessBonus'
            },
            custom: {
                name: '‚úèÔ∏è Custom Mission',
                baseReward: 10,
                resources: {},
                perkType: null
            }
        };

        // Initialize dashboard
        async function initializeDashboard() {
            // Try to load from Firebase first if user is authenticated
            if (userUID) {
                try {
                    const userDataRef = ref(database, `colony-data/${userUID}`);
                    const snapshot = await get(userDataRef);

                    if (snapshot.exists()) {
                        const firebaseData = snapshot.val();
                        colonyData = {
                            lunaris: firebaseData.lunaris || 0,
                            oxygen: firebaseData.oxygen || 100,
                            hydroponics: firebaseData.hydroponics || 100,
                            energy: firebaseData.energy || 100,
                            streak: firebaseData.streak || 0,
                            lastCheckIn: firebaseData.lastCheckIn || null,
                            tasks: firebaseData.tasks || [],
                            completedToday: firebaseData.completedToday || [],
                            failedTasks: firebaseData.failedTasks || []
                        };
                        console.log('Loaded colony data from Firebase:', colonyData);
                    } else {
                        console.log('No Firebase data found, using defaults');
                    }
                } catch (error) {
                    console.error('Error loading from Firebase:', error);
                    // Fallback to localStorage
                    const savedData = localStorage.getItem('colonyData');
                    if (savedData) {
                        colonyData = JSON.parse(savedData);
                    }
                }
            } else {
                // No user authenticated, use localStorage
                const savedData = localStorage.getItem('colonyData');
                if (savedData) {
                    colonyData = JSON.parse(savedData);
                }
            }

            checkAndUpdateStreak();
            updateResourceDisplays();
            checkDailyCheckInStatus();
            renderTasks();

            // Track daily login and award XP
            await trackDailyLogin();

            // Check and apply energy replenishment
            replenishEnergy();

            // Set up hourly energy replenishment
            setInterval(replenishEnergy, 3600000); // Every hour (3600000ms)
        }

        // ============================================
        // XP & LOGIN TRACKING SYSTEM
        // ============================================

        async function trackDailyLogin() {
            if (!userUID) return;

            try {
                const progressRef = ref(database, `user-progress/${userUID}`);
                const snapshot = await get(progressRef);

                const today = new Date().toDateString();
                let progressData = {
                    totalXP: 0,
                    level: 1,
                    loginDays: [],
                    lastLoginDate: null
                };

                if (snapshot.exists()) {
                    progressData = snapshot.val();
                }

                // Check if already logged in today
                if (progressData.lastLoginDate === today) {
                    console.log('Already logged in today');
                    return;
                }

                // Add today to login days
                if (!progressData.loginDays) {
                    progressData.loginDays = [];
                }
                progressData.loginDays.push(today);

                // Award daily login XP
                const dailyLoginXP = 10;
                progressData.totalXP = (progressData.totalXP || 0) + dailyLoginXP;
                progressData.lastLoginDate = today;

                // Save to Firebase
                await set(progressRef, progressData);

                console.log(`‚úÖ Daily login tracked! +${dailyLoginXP} XP awarded`);
                showModal('success', 'üéâ Daily Login!', `Welcome back, Colonist!\n\n+${dailyLoginXP} XP earned for logging in today!`);
            } catch (error) {
                console.error('Error tracking daily login:', error);
            }
        }

        async function awardXP(amount, reason = '') {
            if (!userUID) return;

            try {
                const progressRef = ref(database, `user-progress/${userUID}`);
                const snapshot = await get(progressRef);

                let progressData = {
                    totalXP: 0,
                    level: 1,
                    loginDays: [],
                    lastLoginDate: null
                };

                if (snapshot.exists()) {
                    progressData = snapshot.val();
                }

                progressData.totalXP = (progressData.totalXP || 0) + amount;

                await set(progressRef, progressData);

                console.log(`‚úÖ Awarded ${amount} XP${reason ? ` for ${reason}` : ''}`);
                return progressData.totalXP;
            } catch (error) {
                console.error('Error awarding XP:', error);
            }
        }

        // Make awardXP available globally
        window.awardXP = awardXP;

        // ============================================
        // ENERGY REPLENISHMENT SYSTEM
        // ============================================

        function replenishEnergy() {
            if (!userUID) return;

            try {
                const now = Date.now();
                const lastReplenish = localStorage.getItem('lastEnergyReplenish');
                const lastReplenishTime = lastReplenish ? parseInt(lastReplenish) : 0;

                // Calculate hours passed since last replenishment
                const hoursPassed = Math.floor((now - lastReplenishTime) / 3600000);

                if (hoursPassed >= 1) {
                    // Replenish 1% per hour, max 100%
                    const energyToAdd = Math.min(hoursPassed, 100 - colonyData.energy);

                    if (energyToAdd > 0) {
                        colonyData.energy = Math.min(100, colonyData.energy + energyToAdd);
                        updateResourceDisplays();
                        saveColonyData();

                        console.log(`‚úÖ Energy replenished: +${energyToAdd}% (${hoursPassed} hour(s) passed)`);

                        // Update last replenish time
                        localStorage.setItem('lastEnergyReplenish', now.toString());
                    }
                } else if (lastReplenishTime === 0) {
                    // First time - set the baseline
                    localStorage.setItem('lastEnergyReplenish', now.toString());
                }
            } catch (error) {
                console.error('Error replenishing energy:', error);
            }
        }

        initializeDashboard();

        // Check for focus mode result from notes app
        checkFocusModeReturn();

        function checkFocusModeReturn() {
            const focusResult = localStorage.getItem('focusModeResult');
            if (focusResult) {
                try {
                    const result = JSON.parse(focusResult);
                    localStorage.removeItem('focusModeResult');

                    const taskId = result.taskId;
                    const task = colonyData.tasks.find(t => t.id == taskId);

                    if (task) {
                        if (result.success && !result.tabChangeDetected) {
                            // Task completed successfully
                            completeTask(taskId);
                            showModal('success', 'üéâ Journal Complete!', `Great work on your journaling session!\n\n+${calculateReward(task)} Lunaris earned!`);
                        } else {
                            // Task failed - apply penalties
                            applyJournalPenalties(taskId);
                        }
                    }
                } catch (error) {
                    console.error('Error processing focus mode result:', error);
                }
            }
        }

        function applyJournalPenalties(taskId) {
            colonyData.lunaris = Math.max(0, colonyData.lunaris - 10);
            colonyData.streak = 0;
            colonyData.energy = Math.max(0, colonyData.energy - 10);

            const taskIndex = colonyData.tasks.findIndex(t => t.id == taskId);
            if (taskIndex !== -1) {
                const failedTask = { ...colonyData.tasks[taskIndex], failedAt: Date.now(), reason: 'Left focus mode early' };
                colonyData.failedTasks.push(failedTask);
                colonyData.tasks.splice(taskIndex, 1);
            }

            saveColonyData();
            updateResourceDisplays();
            renderTasks();

            showModal('error', '‚ùå Journal Failed', 'Penalties applied:\n‚Ä¢ -10 Lunaris\n‚Ä¢ Streak reset\n‚Ä¢ -10% Energy\n\nStay focused next time!');
        }

        // Daily check-in
        const dailyCheckInBtn = document.getElementById('daily-check-in-btn');
        const checkInStatus = document.getElementById('check-in-status');
        const checkInOptions = document.getElementById('check-in-options');
        const checkInMessage = document.getElementById('check-in-message');

        function checkDailyCheckInStatus() {
            const today = new Date().toDateString();
            if (colonyData.lastCheckIn === today) {
                dailyCheckInBtn.disabled = true;
                dailyCheckInBtn.textContent = '‚úÖ Daily Check-In Complete';
                checkInMessage.textContent = 'Come back tomorrow for your next check-in!';
            }
        }

        dailyCheckInBtn.addEventListener('click', () => {
            checkInStatus.style.display = 'none';
            checkInOptions.style.display = 'block';
        });

        document.querySelectorAll('.check-in-option').forEach(btn => {
            btn.addEventListener('click', () => {
                performDailyCheckIn(btn.dataset.resource);
            });
        });

        async function performDailyCheckIn(priorityResource) {
            const today = new Date().toDateString();
            colonyData.lastCheckIn = today;

            let bonus = 50;

            // Award XP for daily check-in
            const checkInXP = 15;
            await awardXP(checkInXP, 'daily check-in');

            if (currentRole && currentRole.perks.dailyBonus) {
                if (currentRole.perks.dailyBonus === 'oxygen' && priorityResource === 'oxygen') {
                    bonus += 25;
                    colonyData.oxygen = Math.min(100, colonyData.oxygen + 10);
                } else if (currentRole.perks.dailyBonus === 'hydroponics' && priorityResource === 'hydroponics') {
                    bonus += 25;
                    colonyData.hydroponics = Math.min(100, colonyData.hydroponics + 10);
                }
            }

            colonyData.lunaris += bonus;

            if (priorityResource === 'oxygen') {
                colonyData.oxygen = Math.min(100, colonyData.oxygen + 5);
            } else if (priorityResource === 'hydroponics') {
                colonyData.hydroponics = Math.min(100, colonyData.hydroponics + 5);
            } else if (priorityResource === 'energy') {
                colonyData.energy = Math.min(100, colonyData.energy + 5);
            }

            saveColonyData();
            updateResourceDisplays();

            checkInOptions.style.display = 'none';
            checkInStatus.style.display = 'block';
            dailyCheckInBtn.disabled = true;
            dailyCheckInBtn.textContent = '‚úÖ Daily Check-In Complete';
            checkInMessage.innerHTML = `<span style="color: #FFCC00; font-weight: bold;">+${bonus} Lunaris earned!</span><br>Priority resource boosted. Great work, colonist!`;
        }

        // Streak tracking
        function checkAndUpdateStreak() {
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();

            if (colonyData.lastCheckIn === today) {
                return;
            } else if (colonyData.lastCheckIn === yesterday) {
                colonyData.streak++;
            } else if (colonyData.lastCheckIn) {
                colonyData.streak = 0;
            }

            saveColonyData();
        }

        // Task management
        const taskTypeSelect = document.getElementById('task-type-select');
        const taskDescInput = document.getElementById('task-desc-input');
        const timeCommitment = document.getElementById('time-commitment');
        const createTaskBtn = document.getElementById('create-task-btn');
        const tasksList = document.getElementById('tasks-list');
        const completedTasksList = document.getElementById('completed-tasks-list');

        createTaskBtn.addEventListener('click', createTask);

        function createTask() {
            const taskType = taskTypeSelect.value;
            const customDesc = taskDescInput.value.trim();
            const minutes = parseInt(timeCommitment.value);

            if (!taskType) {
                showModal('warning', '‚ö†Ô∏è Missing Information', 'Please select a mission type!');
                return;
            }

            if (!minutes || minutes < 1) {
                showModal('warning', '‚ö†Ô∏è Invalid Time', 'Please set a valid time commitment!');
                return;
            }

            const taskTypeData = TASK_TYPES[taskType];
            const task = {
                id: Date.now(),
                type: taskType,
                name: taskTypeData.name,
                description: customDesc || 'Complete this mission to earn Lunaris tokens',
                baseReward: taskTypeData.baseReward,
                resources: taskTypeData.resources,
                perkType: taskTypeData.perkType,
                timeCommitment: minutes,
                createdAt: Date.now()
            };

            colonyData.tasks.push(task);
            saveColonyData();
            renderTasks();

            taskTypeSelect.value = '';
            taskDescInput.value = '';
            timeCommitment.value = '25';
        }

        function renderTasks() {
            if (colonyData.tasks.length === 0) {
                tasksList.innerHTML = '<p class="empty-message">No active missions. Create your first mission above!</p>';
            } else {
                tasksList.innerHTML = colonyData.tasks.map(task => `
                    <div class="task-card">
                        <div class="task-header">
                            <div class="task-info">
                                <h4>${task.name}</h4>
                                <p>${task.description}</p>
                                <p style="color: rgba(255,204,0,0.7);">‚è±Ô∏è ${task.timeCommitment} minutes</p>
                            </div>
                            <div class="task-reward">+${calculateReward(task)} üí∞</div>
                        </div>
                        <div class="task-actions">
                            <button onclick="startFocusMode(${task.id})" class="btn" style="flex: 1;">üîí Start Focus Mode</button>
                            <button onclick="deleteTask(${task.id})" class="btn btn-danger">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('');
            }

            const today = new Date().toDateString();
            const todayCompleted = colonyData.completedToday.filter(t => new Date(t.completedAt).toDateString() === today);

            if (todayCompleted.length === 0) {
                completedTasksList.innerHTML = '<p class="empty-message">No missions completed yet today.</p>';
            } else {
                completedTasksList.innerHTML = todayCompleted.map(task => `
                    <div class="completed-task">
                        <div>
                            <span class="task-name">${task.name}</span>
                            <span class="task-meta">Completed ‚Ä¢ ${task.timeCommitment} min</span>
                        </div>
                        <span class="reward">+${task.reward} üí∞</span>
                    </div>
                `).join('');
            }
        }

        // Focus Mode
        let focusModeTimer = null;
        let focusStartTime = null;
        let focusDuration = 0;
        let currentFocusTask = null;
        let tabChangeDetected = false;

        window.startFocusMode = function(taskId) {
            const task = colonyData.tasks.find(t => t.id === taskId);
            if (!task) return;

            showConfirm(
                'üîí Start Focus Mode?',
                `${task.name}\nDuration: ${task.timeCommitment} minutes\n\n‚ö†Ô∏è Leaving early = Penalties:\n‚Ä¢ -10 Lunaris\n‚Ä¢ Mission failed\n‚Ä¢ Streak reset`,
                () => {
                    // User confirmed - start focus mode
                    beginFocusMode(task);
                }
            );
        };

        function beginFocusMode(task) {
            // Special handling for journal/logging tasks - redirect to notes app
            if (task.type === 'logging') {
                const focusUrl = `/Learning JS/notes.html?focus=true&duration=${task.timeCommitment}&taskId=${task.id}`;
                window.location.href = focusUrl;
                return;
            }

            currentFocusTask = task;
            focusDuration = task.timeCommitment * 60;
            focusStartTime = Date.now();
            tabChangeDetected = false;

            document.getElementById('focus-mode-screen').style.display = 'block';
            document.getElementById('focus-task-name').textContent = task.name;

            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(() => {});
            }

            if ('wakeLock' in navigator) {
                navigator.wakeLock.request('screen').catch(() => {});
            }

            startFocusTimer();
            document.addEventListener('visibilitychange', handleVisibilityChange);
        };

        function startFocusTimer() {
            updateTimerDisplay();

            focusModeTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - focusStartTime) / 1000);
                const remaining = focusDuration - elapsed;

                if (remaining <= 0) {
                    completeFocusMode(true);
                } else {
                    updateTimerDisplay();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const elapsed = Math.floor((Date.now() - focusStartTime) / 1000);
            const remaining = Math.max(0, focusDuration - elapsed);

            const minutes = Math.floor(remaining / 60);
            const seconds = remaining % 60;

            document.getElementById('time-remaining').textContent =
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            const progress = ((focusDuration - remaining) / focusDuration) * 100;
            document.getElementById('progress-bar').style.width = progress + '%';
        }

        function handleVisibilityChange() {
            if (document.hidden && currentFocusTask) {
                tabChangeDetected = true;
                document.getElementById('focus-warning').style.display = 'block';
            }
        }

        async function completeFocusMode(success) {
            clearInterval(focusModeTimer);
            document.removeEventListener('visibilitychange', handleVisibilityChange);

            if (document.fullscreenElement) {
                document.exitFullscreen();
            }

            document.getElementById('focus-mode-screen').style.display = 'none';

            if (success && !tabChangeDetected) {
                await completeTask(currentFocusTask.id);

                // Bonus XP for completing focus mode (requires extra dedication)
                const focusBonusXP = 20;
                await awardXP(focusBonusXP, 'focus mode bonus');

                showModal('success', 'üéâ Mission Complete!', `+${calculateReward(currentFocusTask)} Lunaris earned!\n+${focusBonusXP} XP Focus Bonus!\n\nExcellent focus, colonist!`);
            } else {
                applyFocusPenalties();
            }

            currentFocusTask = null;
            tabChangeDetected = false;
        }

        function applyFocusPenalties() {
            colonyData.lunaris = Math.max(0, colonyData.lunaris - 10);
            colonyData.streak = 0;
            colonyData.energy = Math.max(0, colonyData.energy - 10);

            const failedTask = { ...currentFocusTask, failedAt: Date.now(), reason: 'Left Focus Mode early' };
            colonyData.failedTasks.push(failedTask);

            const taskIndex = colonyData.tasks.findIndex(t => t.id === currentFocusTask.id);
            if (taskIndex !== -1) {
                colonyData.tasks.splice(taskIndex, 1);
            }

            saveColonyData();
            updateResourceDisplays();
            renderTasks();

            showModal('error', '‚ùå Mission Failed', 'Penalties applied:\n‚Ä¢ -10 Lunaris\n‚Ä¢ Streak reset\n‚Ä¢ -10% Energy\n\nStay focused next time, colonist.');
        }

        document.getElementById('emergency-exit').addEventListener('click', () => {
            showConfirm(
                '‚ö†Ô∏è Emergency Exit?',
                'Are you sure? This will apply all penalties!',
                () => {
                    completeFocusMode(false);
                }
            );
        });

        window.completeTask = async function(taskId) {
            const taskIndex = colonyData.tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;

            const task = colonyData.tasks[taskIndex];
            const reward = calculateReward(task);

            colonyData.lunaris += reward;

            if (task.resources) {
                Object.entries(task.resources).forEach(([resource, amount]) => {
                    if (resource === 'oxygen') {
                        colonyData.oxygen = Math.max(0, Math.min(100, colonyData.oxygen + amount));
                    } else if (resource === 'hydroponics') {
                        colonyData.hydroponics = Math.max(0, Math.min(100, colonyData.hydroponics + amount));
                    } else if (resource === 'energy') {
                        colonyData.energy = Math.max(0, Math.min(100, colonyData.energy + amount));
                    }
                });
            }

            // Award XP based on task difficulty (time commitment)
            const taskXP = calculateTaskXP(task);
            await awardXP(taskXP, `completing ${task.name}`);

            const completedTask = { ...task, completedAt: Date.now(), reward, xpEarned: taskXP };
            colonyData.completedToday.push(completedTask);
            colonyData.tasks.splice(taskIndex, 1);

            saveColonyData();
            updateResourceDisplays();
            renderTasks();
        };

        function calculateTaskXP(task) {
            // Base XP scales with time commitment
            const timeMinutes = task.timeCommitment || 10;

            if (timeMinutes <= 5) return 5; // Quick tasks
            if (timeMinutes <= 15) return 10; // Short tasks
            if (timeMinutes <= 30) return 15; // Medium tasks
            if (timeMinutes <= 60) return 20; // Long tasks
            return 25; // Very long tasks (over 1 hour)
        }

        window.deleteTask = function(taskId) {
            showConfirm(
                'üóëÔ∏è Delete Mission?',
                'Are you sure you want to delete this mission?',
                () => {
                    const taskIndex = colonyData.tasks.findIndex(t => t.id === taskId);
                    if (taskIndex !== -1) {
                        colonyData.tasks.splice(taskIndex, 1);
                        saveColonyData();
                        renderTasks();
                    }
                }
            );
        };

        function calculateReward(task) {
            let reward = task.baseReward;

            if (currentRole && task.perkType && currentRole.perks[task.perkType]) {
                const multiplier = currentRole.perks[task.perkType];
                reward = Math.floor(reward * multiplier);
            }

            if (currentRole && currentRole.perks.streakBonus && colonyData.streak > 0) {
                reward = Math.floor(reward * currentRole.perks.streakBonus);
            }

            return reward;
        }

        function updateResourceDisplays() {
            document.getElementById('lunaris-display').textContent = colonyData.lunaris;
            document.getElementById('oxygen-display').textContent = colonyData.oxygen + '%';
            document.getElementById('hydroponics-display').textContent = colonyData.hydroponics + '%';
            document.getElementById('energy-display').textContent = colonyData.energy + '%';
            document.getElementById('streak-display').textContent = colonyData.streak + ' days';
        }

        async function saveColonyData() {
            // Save to localStorage as backup
            localStorage.setItem('colonyData', JSON.stringify(colonyData));

            // Save to Firebase if user is authenticated
            if (userUID) {
                try {
                    const userDataRef = ref(database, `colony-data/${userUID}`);
                    await set(userDataRef, {
                        lunaris: colonyData.lunaris,
                        oxygen: colonyData.oxygen,
                        hydroponics: colonyData.hydroponics,
                        energy: colonyData.energy,
                        streak: colonyData.streak,
                        lastCheckIn: colonyData.lastCheckIn,
                        tasks: colonyData.tasks || [],
                        completedToday: colonyData.completedToday || [],
                        failedTasks: colonyData.failedTasks || [],
                        lastUpdated: Date.now()
                    });
                    console.log('Data saved to Firebase successfully');
                } catch (error) {
                    console.error('Firebase save error:', error);
                }
            }
        }

        // ============================================
        // WALLET FUNCTIONALITY
        // ============================================

        const walletModal = document.getElementById('walletModal');
        const walletBtn = document.getElementById('walletBtn');
        const closeWallet = document.getElementById('closeWallet');
        let userWalletAddress = null;

        // Open wallet modal
        walletBtn.addEventListener('click', () => {
            loadWalletData();
            walletModal.classList.add('show');
        });

        // Close wallet modal
        closeWallet.addEventListener('click', () => {
            walletModal.classList.remove('show');
        });

        window.addEventListener('click', (e) => {
            if (e.target === walletModal) {
                walletModal.classList.remove('show');
            }
        });

        // Tab switching
        const walletTabs = document.querySelectorAll('.wallet-tab');
        walletTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');

                // Update active tab
                walletTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Show corresponding content
                document.getElementById('sendTab').classList.remove('active');
                document.getElementById('receiveTab').classList.remove('active');
                document.getElementById(tabName + 'Tab').classList.add('active');
            });
        });

        // Load wallet data
        async function loadWalletData() {
            try {
                const userData = JSON.parse(localStorage.getItem('currentUser'));

                if (userData) {
                    // Get wallet address - prioritize connected wallet, fallback to app-created
                    userWalletAddress = userData.walletAddress || userData.solanaWallet;

                    if (userWalletAddress) {
                        // Display wallet address
                        const shortAddress = userWalletAddress.substring(0, 6) + '...' + userWalletAddress.substring(38);
                        document.getElementById('walletAddressDisplay').textContent = shortAddress;
                        document.getElementById('receiveAddressDisplay').textContent = userWalletAddress;

                        // Fetch balance
                        await fetchBalance();

                        // Generate QR code
                        generateQRCode(userWalletAddress);
                    } else {
                        document.getElementById('walletAddressDisplay').textContent = 'No wallet found';
                        document.getElementById('receiveAddressDisplay').textContent = 'No wallet found';
                    }
                }
            } catch (error) {
                console.error('Error loading wallet data:', error);
            }
        }

        // Fetch SOL balance
        async function fetchBalance() {
            try {
                const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('devnet'));
                const publicKey = new solanaWeb3.PublicKey(userWalletAddress);
                const balance = await connection.getBalance(publicKey);
                const solBalance = (balance / solanaWeb3.LAMPORTS_PER_SOL).toFixed(4);

                document.getElementById('solBalanceDisplay').textContent = solBalance;
            } catch (error) {
                console.error('Error fetching balance:', error);
                document.getElementById('solBalanceDisplay').textContent = '0.00';
            }
        }

        // Refresh balance button
        document.getElementById('refreshBalanceBtn').addEventListener('click', async () => {
            await fetchBalance();
        });

        // Copy address buttons
        document.getElementById('copyAddressBtn').addEventListener('click', () => {
            copyToClipboard(userWalletAddress, 'Wallet address copied!');
        });

        document.getElementById('copyReceiveAddressBtn').addEventListener('click', () => {
            copyToClipboard(userWalletAddress, 'Receive address copied!');
        });

        function copyToClipboard(text, message) {
            navigator.clipboard.writeText(text).then(() => {
                showModal('success', '‚úÖ Copied!', message);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Generate QR Code
        function generateQRCode(address) {
            const qrContainer = document.getElementById('qrCodeContainer');
            qrContainer.innerHTML = `
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${address}"
                     alt="QR Code"
                     style="display: block; margin: 0 auto;">
            `;
        }

        // Send SOL functionality
        document.getElementById('sendTokenBtn').addEventListener('click', async () => {
            const recipientAddress = document.getElementById('recipientAddress').value.trim();
            const amount = parseFloat(document.getElementById('sendAmount').value);

            if (!recipientAddress) {
                showModal('error', '‚ùå Error', 'Please enter a recipient address');
                return;
            }

            if (!amount || amount <= 0) {
                showModal('error', '‚ùå Error', 'Please enter a valid amount');
                return;
            }

            try {
                // Check if user has a connected wallet
                if (typeof window.solana !== 'undefined' && window.solana.isPhantom) {
                    await sendWithPhantom(recipientAddress, amount);
                } else {
                    showModal('info', '‚ÑπÔ∏è Wallet Not Connected', 'Please connect a Phantom wallet to send transactions. App-created wallets can only receive funds.');
                }
            } catch (error) {
                console.error('Send error:', error);
                showModal('error', '‚ùå Transaction Failed', error.message);
            }
        });

        // Send with Phantom wallet
        async function sendWithPhantom(recipientAddress, amount) {
            try {
                const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('devnet'));
                const transaction = new solanaWeb3.Transaction().add(
                    solanaWeb3.SystemProgram.transfer({
                        fromPubkey: window.solana.publicKey,
                        toPubkey: new solanaWeb3.PublicKey(recipientAddress),
                        lamports: amount * solanaWeb3.LAMPORTS_PER_SOL
                    })
                );

                const { signature } = await window.solana.signAndSendTransaction(transaction);
                await connection.confirmTransaction(signature);

                showModal('success', '‚úÖ Success!', `Transaction completed!<br><small>Signature: ${signature.substring(0, 8)}...</small>`);

                // Refresh balance
                await fetchBalance();

                // Clear form
                document.getElementById('recipientAddress').value = '';
                document.getElementById('sendAmount').value = '';
            } catch (error) {
                throw error;
            }
        }
    </script>
</body>
</html>
