<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Colony Dashboard - Lunaris</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel="stylesheet" href="/Learning JS/dashboard.css">
</head>
<body>
    <div id="app-container">
        <!-- Header -->
        <div id="page-header">
            <h1 id="page-title">🚀 Colony Dashboard</h1>
            <div id="nav-buttons">
                <a href="/Learning JS/notes.html" class="nav-btn">📝 Notes</a>
                <a href="/Learning JS/console.html" class="nav-btn">⚙️ Console</a>
                <a href="/index.html" class="nav-btn secondary">← Home</a>
            </div>
        </div>

        <!-- User Role Display -->
        <div id="user-role-header" style="display: none;">
            <span>Your Role:</span>
            <span id="header-role-name"></span>
        </div>

        <!-- Resource Dashboard -->
        <div class="dashboard-section">
            <h2 class="section-title">🏠 Base Camp Alpha - Resource Status</h2>

            <div class="resource-grid">
                <div class="resource-card lunaris">
                    <div class="resource-icon">💰</div>
                    <div class="resource-label">Lunaris Tokens</div>
                    <div class="resource-value" id="lunaris-display">0</div>
                </div>

                <div class="resource-card oxygen">
                    <div class="resource-icon">💨</div>
                    <div class="resource-label">Oxygen</div>
                    <div class="resource-value" id="oxygen-display">100%</div>
                </div>

                <div class="resource-card hydroponics">
                    <div class="resource-icon">🌱</div>
                    <div class="resource-label">Hydroponics</div>
                    <div class="resource-value" id="hydroponics-display">100%</div>
                </div>

                <div class="resource-card energy">
                    <div class="resource-icon">⚡</div>
                    <div class="resource-label">Energy</div>
                    <div class="resource-value" id="energy-display">100%</div>
                </div>
            </div>

            <div class="streak-display">
                <span>🔥 Current Streak:</span>
                <span class="streak-value" id="streak-display">0 days</span>
            </div>
        </div>

        <!-- Daily Check-in -->
        <div class="dashboard-section">
            <h2 class="section-title">📋 Morning Colony Report</h2>

            <div id="check-in-status" style="text-align: center;">
                <button id="daily-check-in-btn" class="btn">🌅 Complete Daily Check-In</button>
                <p id="check-in-message" style="color: rgba(255,255,255,0.7); margin-top: 15px;">Start your day and earn bonus tokens!</p>
            </div>

            <div id="check-in-options">
                <p style="color: #FFCC00; text-align: center; margin-bottom: 15px;">Select your priority task for today:</p>
                <div class="check-in-grid">
                    <button class="check-in-option oxygen" data-resource="oxygen">💨 Check Oxygen Systems</button>
                    <button class="check-in-option hydroponics" data-resource="hydroponics">🌱 Water Hydroponics</button>
                    <button class="check-in-option energy" data-resource="energy">⚡ Inspect Energy Grid</button>
                </div>
            </div>
        </div>

        <!-- Task Management -->
        <div class="dashboard-section">
            <h2 class="section-title">🎯 Daily Colony Missions</h2>

            <!-- Create Task Form -->
            <div style="background: rgba(255,204,0,0.1); border-radius: 10px; padding: 25px; margin-bottom: 25px; border: 2px solid rgba(255,204,0,0.2);">
                <h3 style="color: #FFCC00; margin-bottom: 20px;">Create New Mission</h3>

                <div class="form-group">
                    <select id="task-type-select" class="form-select">
                        <option value="">-- Select Mission Type --</option>
                        <option value="hydration">💧 Water Hydroponics (Drink Water)</option>
                        <option value="exploration">🚶 Collect Geological Samples (Go for Walk)</option>
                        <option value="logging">📝 File Colony Log (Journal/Note)</option>
                        <option value="energy">😴 Restore Energy (Sleep Early)</option>
                        <option value="maintenance">🔧 Base Maintenance (Clean/Organize)</option>
                        <option value="research">🔬 Research Project (Study/Learn)</option>
                        <option value="communication">📡 Communications Check (Social Connection)</option>
                        <option value="fitness">💪 Gravity Adaptation Training (Gym/Exercise)</option>
                        <option value="custom">✏️ Custom Mission</option>
                    </select>
                </div>

                <div class="form-group">
                    <input type="text" id="task-desc-input" placeholder="Mission details (optional)" class="form-input">
                </div>

                <div class="form-group">
                    <label class="form-label">⏱️ Time Commitment (minutes):</label>
                    <input type="number" id="time-commitment" min="1" max="240" value="25" class="form-input">
                    <p class="form-hint">Focus Mode will activate for this duration. Leave early = penalties!</p>
                </div>

                <button id="create-task-btn" class="btn" style="width: 100%;">+ Create Mission</button>
            </div>

            <!-- Active Tasks -->
            <div>
                <h3 style="color: #FFCC00; margin-bottom: 15px;">Active Missions</h3>
                <div id="tasks-list" class="tasks-list">
                    <p class="empty-message">No active missions. Create your first mission above!</p>
                </div>
            </div>

            <!-- Completed Tasks -->
            <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid rgba(255,204,0,0.3);">
                <h3 style="color: #FFCC00; margin-bottom: 15px;">✅ Completed Today</h3>
                <div id="completed-tasks-list" class="tasks-list">
                    <p class="empty-message">No missions completed yet today.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Focus Mode Screen -->
    <div id="focus-mode-screen">
        <div class="focus-container">
            <h1 class="focus-title">🔒 FOCUS MODE ACTIVE</h1>

            <div id="focus-task-name" class="focus-task-name"></div>

            <div class="timer-display">
                <div class="time-remaining" id="time-remaining">00:00</div>
                <div class="timer-label">Time Remaining</div>
            </div>

            <div class="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>

            <div class="focus-warning" id="focus-warning">
                <p class="warning-title">⚠️ TAB CHANGE DETECTED!</p>
                <p class="warning-text">Return to this tab or face penalties!</p>
            </div>

            <p class="focus-instructions">
                Stay focused, colonist. Leaving early will result in:<br>
                <span class="penalty-text">-10 Lunaris | Mission Failed | Streak Reset</span>
            </p>

            <button id="emergency-exit" class="emergency-exit">❌ Emergency Exit (Penalties Apply)</button>
        </div>
    </div>

    <!-- Custom Modal -->
    <div id="custom-modal" class="custom-modal">
        <div class="modal-dialog">
            <div class="modal-content-custom">
                <div class="modal-header-custom">
                    <h2 class="modal-title-custom" id="modal-title"></h2>
                </div>
                <div class="modal-body-custom">
                    <div class="modal-icon" id="modal-icon"></div>
                    <div class="modal-message" id="modal-message"></div>
                    <div class="modal-buttons" id="modal-buttons"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Floating Button -->
    <a href="/Learning JS/admin.html" class="admin-float-btn" id="admin-btn" title="Admin Dashboard">
        ⚙️
    </a>

    <!-- Firebase & Dashboard Logic -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, update, get, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyClPgII54QDvJB3kiV1dWbqm1et_lHasvs",
            authDomain: "lunaris-45d84.firebaseapp.com",
            projectId: "lunaris-45d84",
            storageBucket: "lunaris-45d84.firebasestorage.app",
            messagingSenderId: "74359858445",
            appId: "1:74359858445:web:37772cebcbb0d71d707c44",
            measurementId: "G-ETRK2NL1N2",
            databaseURL: "https://lunaris-45d84-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Load user role and data
        let currentRole = null;
        let currentUser = null;
        let userUID = null;

        const savedRole = localStorage.getItem('userRole');
        if (savedRole) {
            currentRole = JSON.parse(savedRole);
            document.getElementById('user-role-header').style.display = 'block';
            document.getElementById('header-role-name').textContent = `${currentRole.emoji} ${currentRole.name}`;
        }

        // Get current authenticated user
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            userUID = currentUser.uid;
        }

        // Monitor auth state to ensure user is authenticated
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userUID = user.uid;
                currentUser = {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL
                };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                console.log('User authenticated:', user.email);

                // Check admin access
                checkAdminAccess(user);

                // Reload data when auth state changes
                if (!colonyData.lunaris && !colonyData.tasks.length) {
                    initializeDashboard();
                }
            } else {
                console.log('No user authenticated');
            }
        });

        // ============================================
        // CUSTOM MODAL SYSTEM
        // Beautiful modals replacing alert/confirm
        // ============================================

        function showModal(type, title, message, callback) {
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalIcon = document.getElementById('modal-icon');
            const modalMessage = document.getElementById('modal-message');
            const modalButtons = document.getElementById('modal-buttons');

            modalTitle.textContent = title;
            modalMessage.textContent = message;

            // Set icon based on type
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️',
                confirm: '❓'
            };
            modalIcon.textContent = icons[type] || '💬';

            // Clear previous buttons
            modalButtons.innerHTML = '';

            // Add OK button
            const okBtn = document.createElement('button');
            okBtn.className = 'modal-btn modal-btn-primary';
            okBtn.textContent = 'OK';
            okBtn.onclick = () => {
                modal.style.display = 'none';
                if (callback) callback(true);
            };
            modalButtons.appendChild(okBtn);

            modal.style.display = 'block';

            // Close on outside click
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    if (callback) callback(false);
                }
            };
        }

        function showConfirm(title, message, onConfirm, onCancel) {
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalIcon = document.getElementById('modal-icon');
            const modalMessage = document.getElementById('modal-message');
            const modalButtons = document.getElementById('modal-buttons');

            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalIcon.textContent = '❓';

            // Clear previous buttons
            modalButtons.innerHTML = '';

            // Add Cancel button
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'modal-btn modal-btn-secondary';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.onclick = () => {
                modal.style.display = 'none';
                if (onCancel) onCancel();
            };
            modalButtons.appendChild(cancelBtn);

            // Add Confirm button
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'modal-btn modal-btn-primary';
            confirmBtn.textContent = 'Confirm';
            confirmBtn.onclick = () => {
                modal.style.display = 'none';
                if (onConfirm) onConfirm();
            };
            modalButtons.appendChild(confirmBtn);

            modal.style.display = 'block';

            // Close on outside click = cancel
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    if (onCancel) onCancel();
                }
            };
        }

        // ============================================
        // ADMIN ACCESS CHECK
        // Shows admin button only for admins
        // ============================================

        async function checkAdminAccess(user) {
            if (!user) return false;

            try {
                const adminRef = ref(database, `admins/${user.uid}`);
                const snapshot = await get(adminRef);

                if (snapshot.exists()) {
                    // User is admin - show admin button
                    document.getElementById('admin-btn').style.display = 'flex';
                    console.log('Admin access granted');
                    return true;
                }
            } catch (error) {
                console.error('Error checking admin access:', error);
            }
            return false;
        }

        // Colony data
        let colonyData = {
            lunaris: 0,
            oxygen: 100,
            hydroponics: 100,
            energy: 100,
            streak: 0,
            lastCheckIn: null,
            tasks: [],
            completedToday: [],
            failedTasks: []
        };

        // Task types
        const TASK_TYPES = {
            hydration: {
                name: '💧 Water Hydroponics',
                baseReward: 10,
                resources: { hydroponics: 5 },
                perkType: 'taskYield'
            },
            exploration: {
                name: '🚶 Collect Geological Samples',
                baseReward: 15,
                resources: { oxygen: 3, energy: -5 },
                perkType: 'earningBoost'
            },
            logging: {
                name: '📝 File Colony Log',
                baseReward: 8,
                resources: { energy: 2 },
                perkType: 'taskYield'
            },
            energy: {
                name: '😴 Restore Energy',
                baseReward: 12,
                resources: { energy: 10 },
                perkType: 'wellnessBonus'
            },
            maintenance: {
                name: '🔧 Base Maintenance',
                baseReward: 10,
                resources: { oxygen: 3, energy: -3 },
                perkType: 'efficiency'
            },
            research: {
                name: '🔬 Research Project',
                baseReward: 20,
                resources: { energy: -8 },
                perkType: 'earningBoost'
            },
            communication: {
                name: '📡 Communications Check',
                baseReward: 12,
                resources: { energy: 2 },
                perkType: 'stakingBonus'
            },
            fitness: {
                name: '💪 Gravity Adaptation Training',
                baseReward: 15,
                resources: { energy: -10, oxygen: -3 },
                perkType: 'wellnessBonus'
            },
            custom: {
                name: '✏️ Custom Mission',
                baseReward: 10,
                resources: {},
                perkType: null
            }
        };

        // Initialize dashboard
        async function initializeDashboard() {
            // Try to load from Firebase first if user is authenticated
            if (userUID) {
                try {
                    const userDataRef = ref(database, `colony-data/${userUID}`);
                    const snapshot = await get(userDataRef);

                    if (snapshot.exists()) {
                        const firebaseData = snapshot.val();
                        colonyData = {
                            lunaris: firebaseData.lunaris || 0,
                            oxygen: firebaseData.oxygen || 100,
                            hydroponics: firebaseData.hydroponics || 100,
                            energy: firebaseData.energy || 100,
                            streak: firebaseData.streak || 0,
                            lastCheckIn: firebaseData.lastCheckIn || null,
                            tasks: firebaseData.tasks || [],
                            completedToday: firebaseData.completedToday || [],
                            failedTasks: firebaseData.failedTasks || []
                        };
                        console.log('Loaded colony data from Firebase:', colonyData);
                    } else {
                        console.log('No Firebase data found, using defaults');
                    }
                } catch (error) {
                    console.error('Error loading from Firebase:', error);
                    // Fallback to localStorage
                    const savedData = localStorage.getItem('colonyData');
                    if (savedData) {
                        colonyData = JSON.parse(savedData);
                    }
                }
            } else {
                // No user authenticated, use localStorage
                const savedData = localStorage.getItem('colonyData');
                if (savedData) {
                    colonyData = JSON.parse(savedData);
                }
            }

            checkAndUpdateStreak();
            updateResourceDisplays();
            checkDailyCheckInStatus();
            renderTasks();
        }

        initializeDashboard();

        // Daily check-in
        const dailyCheckInBtn = document.getElementById('daily-check-in-btn');
        const checkInStatus = document.getElementById('check-in-status');
        const checkInOptions = document.getElementById('check-in-options');
        const checkInMessage = document.getElementById('check-in-message');

        function checkDailyCheckInStatus() {
            const today = new Date().toDateString();
            if (colonyData.lastCheckIn === today) {
                dailyCheckInBtn.disabled = true;
                dailyCheckInBtn.textContent = '✅ Daily Check-In Complete';
                checkInMessage.textContent = 'Come back tomorrow for your next check-in!';
            }
        }

        dailyCheckInBtn.addEventListener('click', () => {
            checkInStatus.style.display = 'none';
            checkInOptions.style.display = 'block';
        });

        document.querySelectorAll('.check-in-option').forEach(btn => {
            btn.addEventListener('click', () => {
                performDailyCheckIn(btn.dataset.resource);
            });
        });

        function performDailyCheckIn(priorityResource) {
            const today = new Date().toDateString();
            colonyData.lastCheckIn = today;

            let bonus = 50;

            if (currentRole && currentRole.perks.dailyBonus) {
                if (currentRole.perks.dailyBonus === 'oxygen' && priorityResource === 'oxygen') {
                    bonus += 25;
                    colonyData.oxygen = Math.min(100, colonyData.oxygen + 10);
                } else if (currentRole.perks.dailyBonus === 'hydroponics' && priorityResource === 'hydroponics') {
                    bonus += 25;
                    colonyData.hydroponics = Math.min(100, colonyData.hydroponics + 10);
                }
            }

            colonyData.lunaris += bonus;

            if (priorityResource === 'oxygen') {
                colonyData.oxygen = Math.min(100, colonyData.oxygen + 5);
            } else if (priorityResource === 'hydroponics') {
                colonyData.hydroponics = Math.min(100, colonyData.hydroponics + 5);
            } else if (priorityResource === 'energy') {
                colonyData.energy = Math.min(100, colonyData.energy + 5);
            }

            saveColonyData();
            updateResourceDisplays();

            checkInOptions.style.display = 'none';
            checkInStatus.style.display = 'block';
            dailyCheckInBtn.disabled = true;
            dailyCheckInBtn.textContent = '✅ Daily Check-In Complete';
            checkInMessage.innerHTML = `<span style="color: #FFCC00; font-weight: bold;">+${bonus} Lunaris earned!</span><br>Priority resource boosted. Great work, colonist!`;
        }

        // Streak tracking
        function checkAndUpdateStreak() {
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();

            if (colonyData.lastCheckIn === today) {
                return;
            } else if (colonyData.lastCheckIn === yesterday) {
                colonyData.streak++;
            } else if (colonyData.lastCheckIn) {
                colonyData.streak = 0;
            }

            saveColonyData();
        }

        // Task management
        const taskTypeSelect = document.getElementById('task-type-select');
        const taskDescInput = document.getElementById('task-desc-input');
        const timeCommitment = document.getElementById('time-commitment');
        const createTaskBtn = document.getElementById('create-task-btn');
        const tasksList = document.getElementById('tasks-list');
        const completedTasksList = document.getElementById('completed-tasks-list');

        createTaskBtn.addEventListener('click', createTask);

        function createTask() {
            const taskType = taskTypeSelect.value;
            const customDesc = taskDescInput.value.trim();
            const minutes = parseInt(timeCommitment.value);

            if (!taskType) {
                showModal('warning', '⚠️ Missing Information', 'Please select a mission type!');
                return;
            }

            if (!minutes || minutes < 1) {
                showModal('warning', '⚠️ Invalid Time', 'Please set a valid time commitment!');
                return;
            }

            const taskTypeData = TASK_TYPES[taskType];
            const task = {
                id: Date.now(),
                type: taskType,
                name: taskTypeData.name,
                description: customDesc || 'Complete this mission to earn Lunaris tokens',
                baseReward: taskTypeData.baseReward,
                resources: taskTypeData.resources,
                perkType: taskTypeData.perkType,
                timeCommitment: minutes,
                createdAt: Date.now()
            };

            colonyData.tasks.push(task);
            saveColonyData();
            renderTasks();

            taskTypeSelect.value = '';
            taskDescInput.value = '';
            timeCommitment.value = '25';
        }

        function renderTasks() {
            if (colonyData.tasks.length === 0) {
                tasksList.innerHTML = '<p class="empty-message">No active missions. Create your first mission above!</p>';
            } else {
                tasksList.innerHTML = colonyData.tasks.map(task => `
                    <div class="task-card">
                        <div class="task-header">
                            <div class="task-info">
                                <h4>${task.name}</h4>
                                <p>${task.description}</p>
                                <p style="color: rgba(255,204,0,0.7);">⏱️ ${task.timeCommitment} minutes</p>
                            </div>
                            <div class="task-reward">+${calculateReward(task)} 💰</div>
                        </div>
                        <div class="task-actions">
                            <button onclick="startFocusMode(${task.id})" class="btn" style="flex: 1;">🔒 Start Focus Mode</button>
                            <button onclick="deleteTask(${task.id})" class="btn btn-danger">🗑️</button>
                        </div>
                    </div>
                `).join('');
            }

            const today = new Date().toDateString();
            const todayCompleted = colonyData.completedToday.filter(t => new Date(t.completedAt).toDateString() === today);

            if (todayCompleted.length === 0) {
                completedTasksList.innerHTML = '<p class="empty-message">No missions completed yet today.</p>';
            } else {
                completedTasksList.innerHTML = todayCompleted.map(task => `
                    <div class="completed-task">
                        <div>
                            <span class="task-name">${task.name}</span>
                            <span class="task-meta">Completed • ${task.timeCommitment} min</span>
                        </div>
                        <span class="reward">+${task.reward} 💰</span>
                    </div>
                `).join('');
            }
        }

        // Focus Mode
        let focusModeTimer = null;
        let focusStartTime = null;
        let focusDuration = 0;
        let currentFocusTask = null;
        let tabChangeDetected = false;

        window.startFocusMode = function(taskId) {
            const task = colonyData.tasks.find(t => t.id === taskId);
            if (!task) return;

            showConfirm(
                '🔒 Start Focus Mode?',
                `${task.name}\nDuration: ${task.timeCommitment} minutes\n\n⚠️ Leaving early = Penalties:\n• -10 Lunaris\n• Mission failed\n• Streak reset`,
                () => {
                    // User confirmed - start focus mode
                    beginFocusMode(task);
                }
            );
        };

        function beginFocusMode(task) {

            currentFocusTask = task;
            focusDuration = task.timeCommitment * 60;
            focusStartTime = Date.now();
            tabChangeDetected = false;

            document.getElementById('focus-mode-screen').style.display = 'block';
            document.getElementById('focus-task-name').textContent = task.name;

            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(() => {});
            }

            if ('wakeLock' in navigator) {
                navigator.wakeLock.request('screen').catch(() => {});
            }

            startFocusTimer();
            document.addEventListener('visibilitychange', handleVisibilityChange);
        };

        function startFocusTimer() {
            updateTimerDisplay();

            focusModeTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - focusStartTime) / 1000);
                const remaining = focusDuration - elapsed;

                if (remaining <= 0) {
                    completeFocusMode(true);
                } else {
                    updateTimerDisplay();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const elapsed = Math.floor((Date.now() - focusStartTime) / 1000);
            const remaining = Math.max(0, focusDuration - elapsed);

            const minutes = Math.floor(remaining / 60);
            const seconds = remaining % 60;

            document.getElementById('time-remaining').textContent =
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            const progress = ((focusDuration - remaining) / focusDuration) * 100;
            document.getElementById('progress-bar').style.width = progress + '%';
        }

        function handleVisibilityChange() {
            if (document.hidden && currentFocusTask) {
                tabChangeDetected = true;
                document.getElementById('focus-warning').style.display = 'block';
            }
        }

        function completeFocusMode(success) {
            clearInterval(focusModeTimer);
            document.removeEventListener('visibilitychange', handleVisibilityChange);

            if (document.fullscreenElement) {
                document.exitFullscreen();
            }

            document.getElementById('focus-mode-screen').style.display = 'none';

            if (success && !tabChangeDetected) {
                completeTask(currentFocusTask.id);
                showModal('success', '🎉 Mission Complete!', `+${calculateReward(currentFocusTask)} Lunaris earned!\n\nExcellent focus, colonist!`);
            } else {
                applyFocusPenalties();
            }

            currentFocusTask = null;
            tabChangeDetected = false;
        }

        function applyFocusPenalties() {
            colonyData.lunaris = Math.max(0, colonyData.lunaris - 10);
            colonyData.streak = 0;
            colonyData.energy = Math.max(0, colonyData.energy - 10);

            const failedTask = { ...currentFocusTask, failedAt: Date.now(), reason: 'Left Focus Mode early' };
            colonyData.failedTasks.push(failedTask);

            const taskIndex = colonyData.tasks.findIndex(t => t.id === currentFocusTask.id);
            if (taskIndex !== -1) {
                colonyData.tasks.splice(taskIndex, 1);
            }

            saveColonyData();
            updateResourceDisplays();
            renderTasks();

            showModal('error', '❌ Mission Failed', 'Penalties applied:\n• -10 Lunaris\n• Streak reset\n• -10% Energy\n\nStay focused next time, colonist.');
        }

        document.getElementById('emergency-exit').addEventListener('click', () => {
            showConfirm(
                '⚠️ Emergency Exit?',
                'Are you sure? This will apply all penalties!',
                () => {
                    completeFocusMode(false);
                }
            );
        });

        window.completeTask = function(taskId) {
            const taskIndex = colonyData.tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;

            const task = colonyData.tasks[taskIndex];
            const reward = calculateReward(task);

            colonyData.lunaris += reward;

            if (task.resources) {
                Object.entries(task.resources).forEach(([resource, amount]) => {
                    if (resource === 'oxygen') {
                        colonyData.oxygen = Math.max(0, Math.min(100, colonyData.oxygen + amount));
                    } else if (resource === 'hydroponics') {
                        colonyData.hydroponics = Math.max(0, Math.min(100, colonyData.hydroponics + amount));
                    } else if (resource === 'energy') {
                        colonyData.energy = Math.max(0, Math.min(100, colonyData.energy + amount));
                    }
                });
            }

            const completedTask = { ...task, completedAt: Date.now(), reward };
            colonyData.completedToday.push(completedTask);
            colonyData.tasks.splice(taskIndex, 1);

            saveColonyData();
            updateResourceDisplays();
            renderTasks();
        };

        window.deleteTask = function(taskId) {
            showConfirm(
                '🗑️ Delete Mission?',
                'Are you sure you want to delete this mission?',
                () => {
                    const taskIndex = colonyData.tasks.findIndex(t => t.id === taskId);
                    if (taskIndex !== -1) {
                        colonyData.tasks.splice(taskIndex, 1);
                        saveColonyData();
                        renderTasks();
                    }
                }
            );
        };

        function calculateReward(task) {
            let reward = task.baseReward;

            if (currentRole && task.perkType && currentRole.perks[task.perkType]) {
                const multiplier = currentRole.perks[task.perkType];
                reward = Math.floor(reward * multiplier);
            }

            if (currentRole && currentRole.perks.streakBonus && colonyData.streak > 0) {
                reward = Math.floor(reward * currentRole.perks.streakBonus);
            }

            return reward;
        }

        function updateResourceDisplays() {
            document.getElementById('lunaris-display').textContent = colonyData.lunaris;
            document.getElementById('oxygen-display').textContent = colonyData.oxygen + '%';
            document.getElementById('hydroponics-display').textContent = colonyData.hydroponics + '%';
            document.getElementById('energy-display').textContent = colonyData.energy + '%';
            document.getElementById('streak-display').textContent = colonyData.streak + ' days';
        }

        async function saveColonyData() {
            // Save to localStorage as backup
            localStorage.setItem('colonyData', JSON.stringify(colonyData));

            // Save to Firebase if user is authenticated
            if (userUID) {
                try {
                    const userDataRef = ref(database, `colony-data/${userUID}`);
                    await set(userDataRef, {
                        lunaris: colonyData.lunaris,
                        oxygen: colonyData.oxygen,
                        hydroponics: colonyData.hydroponics,
                        energy: colonyData.energy,
                        streak: colonyData.streak,
                        lastCheckIn: colonyData.lastCheckIn,
                        tasks: colonyData.tasks || [],
                        completedToday: colonyData.completedToday || [],
                        failedTasks: colonyData.failedTasks || [],
                        lastUpdated: Date.now()
                    });
                    console.log('Data saved to Firebase successfully');
                } catch (error) {
                    console.error('Firebase save error:', error);
                }
            }
        }
    </script>
</body>
</html>
