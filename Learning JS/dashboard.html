<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Colony Dashboard - Lunaris</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel="icon" type="image/jpeg" href="/Learning JS/images/Lunaris Icon.JPG">
    <link rel="stylesheet" href="/Learning JS/dashboard.css">
    <style>
        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: 280px;
            background: linear-gradient(180deg, #1e5128 0%, #2d6a4f 100%);
            border-right: 3px solid #FFCC00;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .sidebar.collapsed {
            transform: translateX(-280px);
        }

        .sidebar-header {
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 2px solid #FFCC00;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #FFCC00;
        }

        .sidebar-title {
            color: #FFCC00;
            font-size: 1.3em;
            font-weight: bold;
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-section {
            margin-bottom: 25px;
        }

        .nav-section-title {
            color: rgba(255, 204, 0, 0.7);
            font-size: 0.85em;
            text-transform: uppercase;
            padding: 10px 20px;
            letter-spacing: 1px;
            font-weight: bold;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: #fff;
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
            cursor: pointer;
        }

        .nav-item:hover {
            background: rgba(255, 204, 0, 0.1);
            border-left-color: #FFCC00;
            padding-left: 25px;
        }

        .nav-item.active {
            background: rgba(255, 204, 0, 0.2);
            border-left-color: #FFCC00;
            color: #FFCC00;
        }

        .nav-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-item.locked:hover {
            background: transparent;
            border-left-color: transparent;
            padding-left: 20px;
        }

        .nav-icon {
            font-size: 1.3em;
            width: 25px;
            text-align: center;
        }

        .nav-text {
            flex: 1;
        }

        .nav-badge {
            background: #FFCC00;
            color: #1e5128;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: bold;
        }

        .sidebar-toggle {
            position: fixed;
            left: 20px;
            top: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #1e5128 0%, #2d6a4f 100%);
            border: 3px solid #FFCC00;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1001;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .sidebar-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 0 25px rgba(255, 204, 0, 0.5);
        }

        .sidebar-toggle.sidebar-open {
            left: 300px;
        }

        .hamburger {
            width: 24px;
            height: 18px;
            position: relative;
            cursor: pointer;
        }

        .hamburger span {
            display: block;
            position: absolute;
            height: 3px;
            width: 100%;
            background: #FFCC00;
            border-radius: 3px;
            opacity: 1;
            left: 0;
            transition: 0.25s ease-in-out;
        }

        .hamburger span:nth-child(1) {
            top: 0;
        }

        .hamburger span:nth-child(2) {
            top: 7px;
        }

        .hamburger span:nth-child(3) {
            top: 14px;
        }

        .sidebar-toggle.sidebar-open .hamburger span:nth-child(1) {
            top: 7px;
            transform: rotate(135deg);
        }

        .sidebar-toggle.sidebar-open .hamburger span:nth-child(2) {
            opacity: 0;
            left: -30px;
        }

        .sidebar-toggle.sidebar-open .hamburger span:nth-child(3) {
            top: 7px;
            transform: rotate(-135deg);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        #app-container {
            margin-left: 280px;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #app-container.sidebar-collapsed {
            margin-left: 0;
        }

        #page-header {
            padding: 30px;
            background: linear-gradient(135deg, #1e5128 0%, #2d6a4f 100%);
            border: 3px solid #FFCC00;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                max-width: 280px;
            }

            .sidebar.collapsed {
                transform: translateX(-100%);
            }

            .sidebar-toggle.active {
                left: calc(100vw - 70px);
                max-width: 300px;
            }

            #app-container {
                margin-left: 0;
            }

            #app-container.sidebar-collapsed {
                margin-left: 0;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        ::-webkit-scrollbar-thumb {
            background: #FFCC00;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #FFD700;
        }

        /* Wallet Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            display: block;
            opacity: 1;
        }

        .wallet-modal-content {
            background: linear-gradient(135deg, #1e5128 0%, #2d6a4f 100%);
            margin: 5% auto;
            padding: 0;
            border: 3px solid #FFCC00;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-bottom: 2px solid #FFCC00;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            color: #FFCC00;
            margin: 0;
            font-size: 1.5em;
        }

        .close-btn {
            color: #FFCC00;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            line-height: 1;
        }

        .close-btn:hover {
            color: #FFD700;
            transform: scale(1.2);
        }

        .modal-body {
            padding: 25px;
        }

        .wallet-section {
            margin-bottom: 25px;
        }

        .form-label {
            color: #FFCC00;
            font-weight: bold;
            margin-bottom: 8px;
            display: block;
        }

        .address-display {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            border: 2px solid rgba(255, 204, 0, 0.3);
        }

        .address-display span {
            flex: 1;
            color: #fff;
            font-family: monospace;
            font-size: 0.9em;
        }

        .icon-btn {
            background: #FFCC00;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s;
        }

        .icon-btn:hover {
            background: #FFD700;
            transform: scale(1.1);
        }

        .balance-display {
            background: rgba(255, 204, 0, 0.1);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid rgba(255, 204, 0, 0.3);
            text-align: center;
        }

        .balance-label {
            color: rgba(255, 204, 0, 0.8);
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .balance-value {
            color: #FFCC00;
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .refresh-btn {
            background: #2d6a4f;
            color: #FFCC00;
            border: 2px solid #FFCC00;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            background: #1e5128;
            transform: scale(1.05);
        }

        .wallet-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .wallet-tab {
            flex: 1;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 204, 0, 0.3);
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .wallet-tab.active {
            background: rgba(255, 204, 0, 0.2);
            border-color: #FFCC00;
            color: #FFCC00;
        }

        .wallet-tab:hover {
            background: rgba(255, 204, 0, 0.15);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 204, 0, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #FFCC00;
            background: rgba(0, 0, 0, 0.5);
        }

        .confirm-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #FFCC00 0%, #FFD700 100%);
            border: none;
            border-radius: 8px;
            color: #1e5128;
            font-weight: bold;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 204, 0, 0.4);
        }

        .receive-section {
            text-align: center;
        }

        .modal-description {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 20px;
        }

        .qr-code-container {
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            margin: 20px auto;
            width: fit-content;
        }

        .address-display.large {
            margin-top: 20px;
            font-size: 0.85em;
        }
    </style>
</head>
<body>
    <!-- Sidebar Toggle Button -->
    <div class="sidebar-toggle sidebar-open" id="sidebarToggle">
        <div class="hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="/Learning JS/images/Lunaris Icon.JPG" alt="Lunaris" class="sidebar-logo">
            <div class="sidebar-title">Lunaris Colony</div>
        </div>

        <div class="sidebar-nav">
            <!-- Main Navigation -->
            <div class="nav-section">
                <div class="nav-section-title">Main</div>
                <a href="/index.html" class="nav-item">
                    <span class="nav-icon">üè†</span>
                    <span class="nav-text">Home</span>
                </a>
                <a href="/Learning JS/dashboard.html" class="nav-item active">
                    <span class="nav-icon">üìä</span>
                    <span class="nav-text">Dashboard</span>
                </a>
                <a href="/Learning JS/console.html" class="nav-item">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span class="nav-text">Console</span>
                </a>
                <div class="nav-item" id="wallet-nav-item">
                    <span class="nav-icon">üëõ</span>
                    <span class="nav-text">Wallet</span>
                </div>
            </div>

            <!-- Base Camp Alpha -->
            <div class="nav-section">
                <div class="nav-section-title">Base Camp Alpha</div>
                <a href="/Learning JS/chatroom.html" class="nav-item">
                    <span class="nav-icon">üí¨</span>
                    <span class="nav-text">Chatroom</span>
                </a>
                <a href="/Learning JS/notes.html" class="nav-item">
                    <span class="nav-icon">üìù</span>
                    <span class="nav-text">Notes</span>
                </a>
            </div>

            <!-- Nexus Crater -->
            <div class="nav-section" id="nexus-section">
                <div class="nav-section-title">Nexus Crater</div>
                <a href="/Learning JS/nexus-claim-station.html" id="sidebar-nexus-claim" class="nav-item" style="display: none;">
                    <span class="nav-icon">üéÅ</span>
                    <span class="nav-text">Daily Claims</span>
                </a>
                <a href="/Learning JS/nexus-marketplace.html" id="sidebar-nexus-market" class="nav-item" style="display: none;">
                    <span class="nav-icon">üí±</span>
                    <span class="nav-text">Marketplace</span>
                </a>
                <a href="/Learning JS/nexus-resource-rush.html" id="sidebar-nexus-rush" class="nav-item" style="display: none;">
                    <span class="nav-icon">‚ö°</span>
                    <span class="nav-text">Resource Rush</span>
                </a>
                <div id="sidebar-nexus-locked" class="nav-item locked">
                    <span class="nav-icon">üîí</span>
                    <span class="nav-text">Locked</span>
                </div>
            </div>

            <!-- Red Dunes Outpost -->
            <div class="nav-section" id="red-dunes-section">
                <div class="nav-section-title">Red Dunes Outpost</div>
                <a href="/Learning JS/red-dunes-dashboard.html" id="sidebar-red-dunes" class="nav-item" style="display: none;">
                    <span class="nav-icon">üèúÔ∏è</span>
                    <span class="nav-text">Exploration Hub</span>
                </a>
                <a href="/Learning JS/red-dunes-achievements.html" id="sidebar-achievements" class="nav-item" style="display: none;">
                    <span class="nav-icon">üèÜ</span>
                    <span class="nav-text">Achievements</span>
                </a>
                <a href="/Learning JS/dune-racer.html" id="sidebar-dune-racer" class="nav-item" style="display: none;">
                    <span class="nav-icon">üèéÔ∏è</span>
                    <span class="nav-text">Dune Racer</span>
                </a>
                <a href="/Learning JS/expedition-tasks.html" id="sidebar-expeditions" class="nav-item" style="display: none;">
                    <span class="nav-icon">‚è≥</span>
                    <span class="nav-text">Expeditions</span>
                </a>
                <a href="/Learning JS/discovery-log.html" id="sidebar-discovery" class="nav-item" style="display: none;">
                    <span class="nav-icon">üìú</span>
                    <span class="nav-text">Discovery Log</span>
                </a>
                <div id="sidebar-red-dunes-locked" class="nav-item locked">
                    <span class="nav-icon">üîí</span>
                    <span class="nav-text">Locked</span>
                </div>
            </div>

            <!-- Resources -->
            <div class="nav-section">
                <div class="nav-section-title">Resources</div>
                <a href="/Learning JS/features-guide.html" class="nav-item">
                    <span class="nav-icon">üìò</span>
                    <span class="nav-text">Features Guide</span>
                </a>
                <a href="/Learning JS/roadmap.html" class="nav-item">
                    <span class="nav-icon">üó∫Ô∏è</span>
                    <span class="nav-text">Roadmap</span>
                </a>
            </div>
        </div>
    </nav>

    <div id="app-container">
        <!-- Header -->
        <div id="page-header">
            <h1 id="page-title">üöÄ Colony Dashboard</h1>
        </div>

        <!-- User Role Display -->
        <div id="user-role-header" style="display: none;">
            <span>Your Role:</span>
            <span id="header-role-name"></span>
        </div>

        <!-- Resource Dashboard -->
        <div class="dashboard-section">
            <h2 class="section-title">üè† Base Camp Alpha - Resource Status</h2>

            <div class="resource-grid">
                <div class="resource-card lunaris">
                    <div class="resource-icon">üí∞</div>
                    <div class="resource-label">Lunaris Tokens</div>
                    <div class="resource-value" id="lunaris-display">0</div>
                </div>

                <div class="resource-card oxygen">
                    <div class="resource-icon">üí®</div>
                    <div class="resource-label">Oxygen</div>
                    <div class="resource-value" id="oxygen-display">100%</div>
                </div>

                <div class="resource-card hydroponics">
                    <div class="resource-icon">üå±</div>
                    <div class="resource-label">Hydroponics</div>
                    <div class="resource-value" id="hydroponics-display">100%</div>
                </div>

                <div class="resource-card energy">
                    <div class="resource-icon">‚ö°</div>
                    <div class="resource-label">Energy</div>
                    <div class="resource-value" id="energy-display">100%</div>
                </div>
            </div>

            <div class="streak-display">
                <span>üî• Current Streak:</span>
                <span class="streak-value" id="streak-display">0 days</span>
            </div>
        </div>

        <!-- Daily Check-in -->
        <div class="dashboard-section">
            <h2 class="section-title">üìã Morning Colony Report</h2>

            <div id="check-in-status" style="text-align: center;">
                <button id="daily-check-in-btn" class="btn">üåÖ Complete Daily Check-In</button>
                <p id="check-in-message" style="color: rgba(255,255,255,0.7); margin-top: 15px;">Start your day and earn bonus tokens!</p>
            </div>

            <div id="check-in-options">
                <p style="color: #FFCC00; text-align: center; margin-bottom: 15px;">Select your priority task for today:</p>
                <div class="check-in-grid">
                    <button class="check-in-option oxygen" data-resource="oxygen">üí® Check Oxygen Systems</button>
                    <button class="check-in-option hydroponics" data-resource="hydroponics">üå± Water Hydroponics</button>
                    <button class="check-in-option energy" data-resource="energy">‚ö° Inspect Energy Grid</button>
                </div>
            </div>
        </div>

        <!-- Task Management -->
        <div class="dashboard-section">
            <h2 class="section-title">üéØ Daily Colony Missions</h2>

            <!-- Create Task Form -->
            <div style="background: rgba(255,204,0,0.1); border-radius: 10px; padding: 25px; margin-bottom: 25px; border: 2px solid rgba(255,204,0,0.2);">
                <h3 style="color: #FFCC00; margin-bottom: 20px;">Create New Mission</h3>

                <div class="form-group">
                    <select id="task-type-select" class="form-select">
                        <option value="">-- Select Mission Type --</option>
                        <option value="hydration">üíß Water Hydroponics (Drink Water)</option>
                        <option value="exploration">üö∂ Collect Geological Samples (Go for Walk)</option>
                        <option value="logging">üìù File Colony Log (Journal/Note)</option>
                        <option value="energy">üò¥ Restore Energy (Sleep Early)</option>
                        <option value="maintenance">üîß Base Maintenance (Clean/Organize)</option>
                        <option value="research">üî¨ Research Project (Study/Learn)</option>
                        <option value="communication">üì° Communications Check (Social Connection)</option>
                        <option value="fitness">üí™ Gravity Adaptation Training (Gym/Exercise)</option>
                        <option value="custom">‚úèÔ∏è Custom Mission</option>
                    </select>
                </div>

                <div class="form-group">
                    <input type="text" id="task-desc-input" placeholder="Mission details (optional)" class="form-input">
                </div>

                <div class="form-group">
                    <label class="form-label">‚è±Ô∏è Time Commitment (minutes):</label>
                    <input type="number" id="time-commitment" min="1" max="240" value="25" class="form-input">
                    <p class="form-hint">Focus Mode will activate for this duration. Leave early = penalties!</p>
                </div>

                <button id="create-task-btn" class="btn" style="width: 100%;">+ Create Mission</button>
            </div>

            <!-- Active Tasks -->
            <div>
                <h3 style="color: #FFCC00; margin-bottom: 15px;">Active Missions</h3>
                <div id="tasks-list" class="tasks-list">
                    <p class="empty-message">No active missions. Create your first mission above!</p>
                </div>
            </div>

            <!-- Completed Tasks -->
            <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid rgba(255,204,0,0.3);">
                <h3 style="color: #FFCC00; margin-bottom: 15px;">‚úÖ Completed Today</h3>
                <div id="completed-tasks-list" class="tasks-list">
                    <p class="empty-message">No missions completed yet today.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Focus Mode Screen -->
    <div id="focus-mode-screen">
        <div class="focus-container">
            <h1 class="focus-title">üîí FOCUS MODE ACTIVE</h1>

            <div id="focus-task-name" class="focus-task-name"></div>

            <div class="timer-display">
                <div class="time-remaining" id="time-remaining">00:00</div>
                <div class="timer-label">Time Remaining</div>
            </div>

            <div class="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>

            <div class="focus-warning" id="focus-warning">
                <p class="warning-title">‚ö†Ô∏è TAB CHANGE DETECTED!</p>
                <p class="warning-text">Return to this tab or face penalties!</p>
            </div>

            <p class="focus-instructions">
                Stay focused, colonist. Leaving early will result in:<br>
                <span class="penalty-text">-10 Lunaris | Mission Failed | Streak Reset</span>
            </p>

            <button id="emergency-exit" class="emergency-exit">‚ùå Emergency Exit (Penalties Apply)</button>
        </div>
    </div>

    <!-- Custom Modal -->
    <div id="custom-modal" class="custom-modal">
        <div class="modal-dialog">
            <div class="modal-content-custom">
                <div class="modal-header-custom">
                    <h2 class="modal-title-custom" id="modal-title"></h2>
                </div>
                <div class="modal-body-custom">
                    <div class="modal-icon" id="modal-icon"></div>
                    <div class="modal-message" id="modal-message"></div>
                    <div class="modal-buttons" id="modal-buttons"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Wallet Modal -->
    <div id="walletModal" class="modal">
        <div class="modal-content wallet-modal-content">
            <div class="modal-header">
                <span class="close-btn" id="closeWallet">&times;</span>
                <h2>üëõ Your Wallet</h2>
            </div>
            <div class="modal-body">
                <!-- Wallet Address Section -->
                <div class="wallet-section">
                    <div class="wallet-address-container">
                        <label class="form-label">Wallet Address:</label>
                        <div class="address-display">
                            <span id="walletAddressDisplay">Loading...</span>
                            <button id="copyAddressBtn" class="icon-btn" title="Copy Address">üìã</button>
                        </div>
                    </div>

                    <!-- Generate Wallet Button (shown only if no wallet exists) -->
                    <div id="generateWalletSection" style="display: none; margin-top: 15px; padding: 15px; background: rgba(255, 204, 0, 0.1); border-radius: 8px; border: 2px solid rgba(255, 204, 0, 0.3);">
                        <p style="color: #FFCC00; margin-bottom: 10px; text-align: center;">‚ö†Ô∏è No Solana wallet found for your account</p>
                        <button id="generateWalletBtn" class="confirm-btn" style="width: 100%;">üîë Generate Solana Wallet</button>
                        <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.85rem; margin-top: 10px; text-align: center;">This will create a new Solana address for receiving tokens</p>
                    </div>
                </div>

                <!-- Balance Section -->
                <div class="wallet-section">
                    <div class="balance-display">
                        <div class="balance-label">SOL Balance</div>
                        <div class="balance-value" id="solBalanceDisplay">0.00</div>
                        <button id="refreshBalanceBtn" class="refresh-btn">üîÑ Refresh</button>
                    </div>
                </div>

                <!-- Tabs for Send/Receive -->
                <div class="wallet-tabs">
                    <button class="wallet-tab active" data-tab="send">üì§ Send</button>
                    <button class="wallet-tab" data-tab="receive">üì• Receive</button>
                </div>

                <!-- Send Tab Content -->
                <div id="sendTab" class="tab-content active">
                    <div class="form-group">
                        <label class="form-label">Recipient Address:</label>
                        <input type="text" id="recipientAddress" placeholder="Enter Solana address" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount (SOL):</label>
                        <input type="number" id="sendAmount" placeholder="0.00" step="0.01" min="0" class="form-input">
                    </div>
                    <button id="sendTokenBtn" class="confirm-btn">üì§ Send SOL</button>
                </div>

                <!-- Receive Tab Content -->
                <div id="receiveTab" class="tab-content">
                    <div class="receive-section">
                        <p class="modal-description">Share this address to receive SOL and tokens</p>
                        <div class="qr-code-container" id="qrCodeContainer">
                            <!-- QR code will be generated here -->
                        </div>
                        <div class="address-display large">
                            <span id="receiveAddressDisplay">Loading...</span>
                            <button id="copyReceiveAddressBtn" class="icon-btn" title="Copy Address">üìã</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Floating Button -->
    <a href="/Learning JS/admin.html" class="admin-float-btn" id="admin-btn" title="Admin Dashboard">
        ‚öôÔ∏è
    </a>

    <!-- Solana Web3.js -->
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@latest/lib/index.iife.min.js"></script>

    <!-- Firebase & Dashboard Logic -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, update, get, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyClPgII54QDvJB3kiV1dWbqm1et_lHasvs",
            authDomain: "lunaris-45d84.firebaseapp.com",
            projectId: "lunaris-45d84",
            storageBucket: "lunaris-45d84.firebasestorage.app",
            messagingSenderId: "74359858445",
            appId: "1:74359858445:web:37772cebcbb0d71d707c44",
            measurementId: "G-ETRK2NL1N2",
            databaseURL: "https://lunaris-45d84-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Load user role and data
        let currentRole = null;
        let currentUser = null;
        let userUID = null;

        const savedRole = localStorage.getItem('userRole');
        if (savedRole) {
            currentRole = JSON.parse(savedRole);
            document.getElementById('user-role-header').style.display = 'block';
            document.getElementById('header-role-name').textContent = `${currentRole.emoji} ${currentRole.name}`;
        }

        // Get current authenticated user
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            userUID = currentUser.uid;
        }

        // Monitor auth state to ensure user is authenticated
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userUID = user.uid;

                // Load custom display name from Firebase
                const customName = await loadCustomDisplayName(user.uid);

                currentUser = {
                    uid: user.uid,
                    email: user.email,
                    displayName: customName || user.displayName,
                    photoURL: user.photoURL
                };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                console.log('User authenticated:', user.email);
                console.log('Display name:', currentUser.displayName);

                // Check admin access
                checkAdminAccess(user);

                // Reload data when auth state changes
                if (!colonyData.lunaris && !colonyData.tasks.length) {
                    initializeDashboard();
                }
            } else {
                console.log('No user authenticated');
            }
        });

        // Load custom display name from Firebase user-profiles
        async function loadCustomDisplayName(userId) {
            try {
                const userProfileRef = ref(database, `user-profiles/${userId}`);
                const snapshot = await get(userProfileRef);

                if (snapshot.exists() && snapshot.val().displayName) {
                    console.log('‚úÖ Loaded custom display name from Firebase:', snapshot.val().displayName);
                    return snapshot.val().displayName;
                }
            } catch (error) {
                console.error('Error loading custom display name:', error);
            }
            return null;
        }

        // ============================================
        // CUSTOM MODAL SYSTEM
        // Beautiful modals replacing alert/confirm
        // ============================================

        function showModal(type, title, message, callback) {
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalIcon = document.getElementById('modal-icon');
            const modalMessage = document.getElementById('modal-message');
            const modalButtons = document.getElementById('modal-buttons');

            modalTitle.textContent = title;
            modalMessage.textContent = message;

            // Set icon based on type
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è',
                confirm: '‚ùì'
            };
            modalIcon.textContent = icons[type] || 'üí¨';

            // Clear previous buttons
            modalButtons.innerHTML = '';

            // Add OK button
            const okBtn = document.createElement('button');
            okBtn.className = 'modal-btn modal-btn-primary';
            okBtn.textContent = 'OK';
            okBtn.onclick = () => {
                modal.style.display = 'none';
                if (callback) callback(true);
            };
            modalButtons.appendChild(okBtn);

            modal.style.display = 'block';

            // Close on outside click
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    if (callback) callback(false);
                }
            };
        }

        function showConfirm(title, message, onConfirm, onCancel) {
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalIcon = document.getElementById('modal-icon');
            const modalMessage = document.getElementById('modal-message');
            const modalButtons = document.getElementById('modal-buttons');

            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalIcon.textContent = '‚ùì';

            // Clear previous buttons
            modalButtons.innerHTML = '';

            // Add Cancel button
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'modal-btn modal-btn-secondary';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.onclick = () => {
                modal.style.display = 'none';
                if (onCancel) onCancel();
            };
            modalButtons.appendChild(cancelBtn);

            // Add Confirm button
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'modal-btn modal-btn-primary';
            confirmBtn.textContent = 'Confirm';
            confirmBtn.onclick = () => {
                modal.style.display = 'none';
                if (onConfirm) onConfirm();
            };
            modalButtons.appendChild(confirmBtn);

            modal.style.display = 'block';

            // Close on outside click = cancel
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    if (onCancel) onCancel();
                }
            };
        }

        // ============================================
        // ADMIN ACCESS CHECK
        // Shows admin button only for admins
        // ============================================

        let isUserAdmin = false; // Track admin status globally

        async function checkAdminAccess(user) {
            if (!user) return false;

            try {
                const adminRef = ref(database, `admins/${user.uid}`);
                const snapshot = await get(adminRef);

                if (snapshot.exists()) {
                    // User is admin - show admin button
                    isUserAdmin = true;
                    document.getElementById('admin-btn').style.display = 'flex';
                    console.log('üîì Admin access granted - Phase unlocking bypassed for testing');
                    return true;
                }
            } catch (error) {
                console.error('Error checking admin access:', error);
            }
            isUserAdmin = false;
            return false;
        }

        // Colony data
        let colonyData = {
            lunaris: 0,
            oxygen: 100,
            hydroponics: 100,
            energy: 100,
            streak: 0,
            lastCheckIn: null,
            tasks: [],
            completedToday: [],
            failedTasks: []
        };

        // Task types
        const TASK_TYPES = {
            hydration: {
                name: 'üíß Water Hydroponics',
                baseReward: 10,
                resources: { hydroponics: 5 },
                perkType: 'taskYield'
            },
            exploration: {
                name: 'üö∂ Collect Geological Samples',
                baseReward: 15,
                resources: { oxygen: 3, energy: -5 },
                perkType: 'earningBoost'
            },
            logging: {
                name: 'üìù File Colony Log',
                baseReward: 8,
                resources: { energy: 2 },
                perkType: 'taskYield'
            },
            energy: {
                name: 'üò¥ Restore Energy',
                baseReward: 12,
                resources: { energy: 10 },
                perkType: 'wellnessBonus'
            },
            maintenance: {
                name: 'üîß Base Maintenance',
                baseReward: 10,
                resources: { oxygen: 3, energy: -3 },
                perkType: 'efficiency'
            },
            research: {
                name: 'üî¨ Research Project',
                baseReward: 20,
                resources: { energy: -8 },
                perkType: 'earningBoost'
            },
            communication: {
                name: 'üì° Communications Check',
                baseReward: 12,
                resources: { energy: 2 },
                perkType: 'stakingBonus'
            },
            fitness: {
                name: 'üí™ Gravity Adaptation Training',
                baseReward: 15,
                resources: { energy: -10, oxygen: -3 },
                perkType: 'wellnessBonus'
            },
            custom: {
                name: '‚úèÔ∏è Custom Mission',
                baseReward: 10,
                resources: {},
                perkType: null
            }
        };

        // Initialize dashboard - SUPER OPTIMIZED FOR INSTANT LOAD
        async function initializeDashboard() {
            // INSTANT UI: Show cached data immediately (no waiting!)
            loadCachedDataInstantly();
            updateResourceDisplays();
            checkDailyCheckInStatus();
            renderTasks();

            if (!userUID) {
                console.log('No user authenticated - cannot load data');
                return;
            }

            // Background refresh: Update from Firebase without blocking UI
            refreshFromFirebase();

            // Set up hourly energy replenishment
            setInterval(replenishEnergy, 3600000);
        }

        // Load cached data instantly (synchronous, no await)
        function loadCachedDataInstantly() {
            try {
                const cached = localStorage.getItem('colonyData');
                if (cached) {
                    const parsedData = JSON.parse(cached);
                    // Only use cache if it's less than 10 seconds old
                    const now = Date.now();
                    if (parsedData._cacheTime && (now - parsedData._cacheTime < 10000)) {
                        colonyData = parsedData;
                        console.log('‚ö° Instant load from cache');
                        return;
                    }
                }
            } catch (error) {
                console.error('Cache load error:', error);
            }
        }

        // Refresh from Firebase in background
        async function refreshFromFirebase() {
            try {
                // PARALLEL LOADING: Fetch all Firebase data at once
                const [colonySnapshot, progressSnapshot] = await Promise.all([
                    get(ref(database, `colony-data/${userUID}`)),
                    get(ref(database, `user-progress/${userUID}`))
                ]);

                // Load colony data
                if (colonySnapshot.exists()) {
                    const firebaseData = colonySnapshot.val();
                    colonyData = {
                        lunaris: firebaseData.lunaris || 0,
                        oxygen: firebaseData.oxygen || 100,
                        hydroponics: firebaseData.hydroponics || 100,
                        energy: firebaseData.energy || 100,
                        streak: firebaseData.streak || 0,
                        lastCheckIn: firebaseData.lastCheckIn || null,
                        tasks: firebaseData.tasks || [],
                        completedToday: firebaseData.completedToday || [],
                        failedTasks: firebaseData.failedTasks || []
                    };

                    console.log('‚úÖ Refreshed from Firebase:', colonyData);

                    // Update UI with fresh data
                    updateResourceDisplays();
                    renderTasks();
                    checkDailyCheckInStatus();
                } else {
                    console.log('‚ö†Ô∏è No colony data in Firebase, using defaults');
                }

                // Track daily login silently (no popup)
                await trackDailyLoginSilent(progressSnapshot);

                // Update replenish
                replenishEnergy();
                checkAndUpdateStreak();

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // CHECK NEXUS CRATER UNLOCK STATUS
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                await checkNexusCraterUnlock(progressSnapshot);

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // CHECK RED DUNES OUTPOST UNLOCK STATUS
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                await checkRedDunesUnlock(progressSnapshot);

            } catch (error) {
                console.error('Error refreshing from Firebase:', error);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // NEXUS CRATER UNLOCK CHECK
        // Requirements: Level 10 + 30 Total Login Days (BYPASSED FOR ADMINS)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function checkNexusCraterUnlock(progressSnapshot) {
            try {
                let progressData = {
                    totalXP: 0,
                    level: 1,
                    loginDays: []
                };

                if (progressSnapshot && progressSnapshot.exists()) {
                    progressData = progressSnapshot.val();
                }

                // Calculate level from XP
                const xp = progressData.totalXP || 0;
                const level = calculateLevel(xp);
                const totalLoginDays = (progressData.loginDays || []).length;

                // Unlock requirements
                const REQUIRED_LEVEL = 10;
                const REQUIRED_DAYS = 30;

                const hasRequiredLevel = level >= REQUIRED_LEVEL;
                const hasRequiredDays = totalLoginDays >= REQUIRED_DAYS;

                // üîì ADMIN BYPASS: Admins can access all phases for testing
                const isUnlocked = isUserAdmin || (hasRequiredLevel && hasRequiredDays);

                console.log('üìä Nexus Crater Status:', {
                    level,
                    totalLoginDays,
                    hasRequiredLevel,
                    hasRequiredDays,
                    isAdminBypass: isUserAdmin,
                    isUnlocked
                });

                // Update UI
                const claimLink = document.getElementById('sidebar-nexus-claim');
                const marketLink = document.getElementById('sidebar-nexus-market');
                const rushLink = document.getElementById('sidebar-nexus-rush');
                const lockedBtn = document.getElementById('sidebar-nexus-locked');

                if (isUnlocked) {
                    // Show unlocked buttons
                    claimLink.style.display = 'flex';
                    marketLink.style.display = 'flex';
                    rushLink.style.display = 'flex';
                    lockedBtn.style.display = 'none';

                    if (isUserAdmin && (!hasRequiredLevel || !hasRequiredDays)) {
                        console.log('üîì Nexus Crater UNLOCKED (Admin Bypass Active)');
                    } else {
                        console.log('‚úÖ Nexus Crater UNLOCKED!');
                    }
                } else {
                    // Show locked button with progress
                    const missingLevel = hasRequiredLevel ? '' : `Level ${REQUIRED_LEVEL}`;
                    const missingDays = hasRequiredDays ? '' : `${REQUIRED_DAYS} Login Days`;
                    const missing = [missingLevel, missingDays].filter(x => x).join(' + ');

                    lockedBtn.textContent = `üîí Locked (Need: ${missing})`;
                    lockedBtn.style.display = 'flex';
                    claimLink.style.display = 'none';
                    marketLink.style.display = 'none';
                    rushLink.style.display = 'none';

                    // Add click handler to show requirements
                    lockedBtn.onclick = () => {
                        showModal('info', 'üîí Nexus Crater Locked',
                            `Unlock Requirements:\n\n` +
                            `${hasRequiredLevel ? '‚úÖ' : '‚ùå'} Level ${REQUIRED_LEVEL} (Current: ${level})\n` +
                            `${hasRequiredDays ? '‚úÖ' : '‚ùå'} ${REQUIRED_DAYS} Login Days (Current: ${totalLoginDays})\n\n` +
                            `Keep playing to unlock the Trade & Social Hub!`
                        );
                    };

                    console.log(`üîí Nexus Crater LOCKED - Need: ${missing}`);
                }
            } catch (error) {
                console.error('Error checking Nexus unlock:', error);
            }
        }

        // Calculate level from XP (same formula used in console)
        function calculateLevel(xp) {
            const levels = [
                { level: 1, xpRequired: 0 },
                { level: 2, xpRequired: 100 },
                { level: 3, xpRequired: 250 },
                { level: 4, xpRequired: 450 },
                { level: 5, xpRequired: 700 },
                { level: 6, xpRequired: 1000 },
                { level: 7, xpRequired: 1350 },
                { level: 8, xpRequired: 1750 },
                { level: 9, xpRequired: 2200 },
                { level: 10, xpRequired: 2700 }, // Crater Nexus unlock
                { level: 11, xpRequired: 3250 },
                { level: 12, xpRequired: 3850 },
                { level: 13, xpRequired: 4500 },
                { level: 14, xpRequired: 5200 },
                { level: 15, xpRequired: 5950 },
                { level: 16, xpRequired: 6750 },
                { level: 17, xpRequired: 7600 },
                { level: 18, xpRequired: 8500 },
                { level: 19, xpRequired: 9450 },
                { level: 20, xpRequired: 10450 },
                { level: 21, xpRequired: 11500 },
                { level: 22, xpRequired: 12600 },
                { level: 23, xpRequired: 13750 },
                { level: 24, xpRequired: 14950 },
                { level: 25, xpRequired: 16200 } // Red Dunes Outpost unlock
            ];

            for (let i = levels.length - 1; i >= 0; i--) {
                if (xp >= levels[i].xpRequired) {
                    return levels[i].level;
                }
            }
            return 1;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // RED DUNES OUTPOST UNLOCK CHECK
        // Requirements: Level 25 + 60 Total Login Days (BYPASSED FOR ADMINS)
        // Special: Exploratory Engineer can unlock with only Level 25 + 60 days
        // Other roles: Level 25 + 100 days
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function checkRedDunesUnlock(progressSnapshot) {
            try {
                let progressData = {
                    totalXP: 0,
                    level: 1,
                    loginDays: []
                };

                if (progressSnapshot && progressSnapshot.exists()) {
                    progressData = progressSnapshot.val();
                }

                // Calculate level from XP
                const xp = progressData.totalXP || 0;
                const level = calculateLevel(xp);
                const totalLoginDays = (progressData.loginDays || []).length;

                // Check user role for special unlock conditions
                const userRole = currentRole?.name || '';
                const isExploratoryEngineer = userRole.includes('Exploratory Engineer');

                // Unlock requirements
                const REQUIRED_LEVEL = 25;
                const REQUIRED_DAYS = isExploratoryEngineer ? 60 : 100;

                const hasRequiredLevel = level >= REQUIRED_LEVEL;
                const hasRequiredDays = totalLoginDays >= REQUIRED_DAYS;

                // üîì ADMIN BYPASS: Admins can access all phases for testing
                const isUnlocked = isUserAdmin || (hasRequiredLevel && hasRequiredDays);

                console.log('üèúÔ∏è Red Dunes Outpost Status:', {
                    level,
                    totalLoginDays,
                    role: userRole,
                    isExploratoryEngineer,
                    requiredDays: REQUIRED_DAYS,
                    hasRequiredLevel,
                    hasRequiredDays,
                    isAdminBypass: isUserAdmin,
                    isUnlocked
                });

                // Update UI
                const redDunesLink = document.getElementById('sidebar-red-dunes');
                const achievementsLink = document.getElementById('sidebar-achievements');
                const racerLink = document.getElementById('sidebar-dune-racer');
                const expeditionsLink = document.getElementById('sidebar-expeditions');
                const discoveryLink = document.getElementById('sidebar-discovery');
                const lockedBtn = document.getElementById('sidebar-red-dunes-locked');

                if (isUnlocked) {
                    // Show unlocked buttons
                    redDunesLink.style.display = 'flex';
                    achievementsLink.style.display = 'flex';
                    racerLink.style.display = 'flex';
                    expeditionsLink.style.display = 'flex';
                    discoveryLink.style.display = 'flex';
                    lockedBtn.style.display = 'none';

                    if (isUserAdmin && (!hasRequiredLevel || !hasRequiredDays)) {
                        console.log('üîì Red Dunes Outpost UNLOCKED (Admin Bypass Active)');
                    } else {
                        console.log('‚úÖ Red Dunes Outpost UNLOCKED!');
                    }
                } else {
                    // Show locked button with progress
                    const missingLevel = hasRequiredLevel ? '' : `Level ${REQUIRED_LEVEL}`;
                    const missingDays = hasRequiredDays ? '' : `${REQUIRED_DAYS} Login Days`;
                    const missing = [missingLevel, missingDays].filter(x => x).join(' + ');

                    lockedBtn.textContent = `üîí Locked (Need: ${missing})`;
                    lockedBtn.style.display = 'flex';
                    redDunesLink.style.display = 'none';
                    achievementsLink.style.display = 'none';
                    racerLink.style.display = 'none';
                    expeditionsLink.style.display = 'none';
                    discoveryLink.style.display = 'none';

                    // Add click handler to show requirements
                    lockedBtn.onclick = () => {
                        const roleBonus = isExploratoryEngineer
                            ? '\n\nüéñÔ∏è Exploratory Engineer Bonus: Only 60 days required!'
                            : '\n\nNote: Exploratory Engineers only need 60 days instead of 100.';

                        showModal('info', 'üîí Red Dunes Outpost Locked',
                            `Unlock Requirements:\n\n` +
                            `${hasRequiredLevel ? '‚úÖ' : '‚ùå'} Level ${REQUIRED_LEVEL} (Current: ${level})\n` +
                            `${hasRequiredDays ? '‚úÖ' : '‚ùå'} ${REQUIRED_DAYS} Login Days (Current: ${totalLoginDays})` +
                            roleBonus +
                            `\n\nKeep exploring to unlock the Explorer's Domain!`
                        );
                    };

                    console.log(`üîí Red Dunes Outpost LOCKED - Need: ${missing}`);
                }
            } catch (error) {
                console.error('Error checking Red Dunes unlock:', error);
            }
        }

        // ============================================
        // XP & LOGIN TRACKING SYSTEM - OPTIMIZED
        // ============================================

        // Silent login tracker - no modal popup, uses pre-loaded data
        async function trackDailyLoginSilent(progressSnapshot) {
            if (!userUID) return;

            try {
                const today = new Date().toDateString();
                let progressData = {
                    totalXP: 0,
                    level: 1,
                    loginDays: [],
                    lastLoginDate: null
                };

                if (progressSnapshot && progressSnapshot.exists()) {
                    progressData = progressSnapshot.val();
                }

                // Check if already logged in today
                if (progressData.lastLoginDate === today) {
                    console.log('‚úÖ Already logged in today');
                    return;
                }

                // Add today to login days
                if (!progressData.loginDays) {
                    progressData.loginDays = [];
                }
                progressData.loginDays.push(today);

                // Award daily login XP
                const dailyLoginXP = 10;
                progressData.totalXP = (progressData.totalXP || 0) + dailyLoginXP;
                progressData.lastLoginDate = today;

                // Save to Firebase (async, non-blocking)
                const progressRef = ref(database, `user-progress/${userUID}`);
                set(progressRef, progressData).catch(error => {
                    console.error('Error saving login:', error);
                });

                console.log(`‚úÖ Daily login tracked silently! +${dailyLoginXP} XP`);
            } catch (error) {
                console.error('Error tracking daily login:', error);
            }
        }

        async function awardXP(amount, reason = '') {
            if (!userUID) {
                console.error('‚ùå Cannot award XP: No user ID');
                return;
            }

            try {
                const progressRef = ref(database, `user-progress/${userUID}`);
                const snapshot = await get(progressRef);

                let progressData = {
                    totalXP: 0,
                    level: 1,
                    loginDays: [],
                    lastLoginDate: null
                };

                if (snapshot.exists()) {
                    progressData = snapshot.val();
                }

                const oldXP = progressData.totalXP || 0;
                progressData.totalXP = oldXP + amount;

                await set(progressRef, progressData);

                console.log(`‚úÖ XP Updated: ${oldXP} ‚Üí ${progressData.totalXP} (+${amount})${reason ? ` for ${reason}` : ''}`);

                // Show in-game notification
                showModal('success', '‚ú® XP Earned!', `+${amount} XP${reason ? ` for ${reason}` : ''}!\n\nTotal XP: ${progressData.totalXP}`);

                return progressData.totalXP;
            } catch (error) {
                console.error('‚ùå Error awarding XP:', error);
                showModal('error', '‚ö†Ô∏è XP Error', `Failed to award XP: ${error.message}`);
            }
        }

        // Make awardXP available globally
        window.awardXP = awardXP;

        // ============================================
        // ENERGY REPLENISHMENT SYSTEM
        // ============================================

        function replenishEnergy() {
            if (!userUID) return;

            try {
                const now = Date.now();
                const lastReplenish = localStorage.getItem('lastEnergyReplenish');
                const lastReplenishTime = lastReplenish ? parseInt(lastReplenish) : 0;

                // Calculate hours passed since last replenishment
                const hoursPassed = Math.floor((now - lastReplenishTime) / 3600000);

                if (hoursPassed >= 1) {
                    // Replenish 1% per hour, max 100%
                    const energyToAdd = Math.min(hoursPassed, 100 - colonyData.energy);

                    if (energyToAdd > 0) {
                        colonyData.energy = Math.min(100, colonyData.energy + energyToAdd);
                        updateResourceDisplays();
                        saveColonyData();

                        console.log(`‚úÖ Energy replenished: +${energyToAdd}% (${hoursPassed} hour(s) passed)`);

                        // Update last replenish time
                        localStorage.setItem('lastEnergyReplenish', now.toString());
                    }
                } else if (lastReplenishTime === 0) {
                    // First time - set the baseline
                    localStorage.setItem('lastEnergyReplenish', now.toString());
                }
            } catch (error) {
                console.error('Error replenishing energy:', error);
            }
        }

        initializeDashboard();

        // Check for focus mode result from notes app
        checkFocusModeReturn();

        function checkFocusModeReturn() {
            const focusResult = localStorage.getItem('focusModeResult');
            if (focusResult) {
                try {
                    const result = JSON.parse(focusResult);
                    localStorage.removeItem('focusModeResult');

                    const taskId = result.taskId;
                    const task = colonyData.tasks.find(t => t.id == taskId);

                    if (task) {
                        if (result.success && !result.tabChangeDetected) {
                            // Task completed successfully
                            completeTask(taskId);
                            showModal('success', 'üéâ Journal Complete!', `Great work on your journaling session!\n\n+${calculateReward(task)} Lunaris earned!`);
                        } else {
                            // Task failed - apply penalties
                            applyJournalPenalties(taskId);
                        }
                    }
                } catch (error) {
                    console.error('Error processing focus mode result:', error);
                }
            }
        }

        function applyJournalPenalties(taskId) {
            colonyData.lunaris = Math.max(0, colonyData.lunaris - 10);
            colonyData.streak = 0;
            colonyData.energy = Math.max(0, colonyData.energy - 10);

            const taskIndex = colonyData.tasks.findIndex(t => t.id == taskId);
            if (taskIndex !== -1) {
                const failedTask = { ...colonyData.tasks[taskIndex], failedAt: Date.now(), reason: 'Left focus mode early' };
                colonyData.failedTasks.push(failedTask);
                colonyData.tasks.splice(taskIndex, 1);
            }

            saveColonyData();
            updateResourceDisplays();
            renderTasks();

            showModal('error', '‚ùå Journal Failed', 'Penalties applied:\n‚Ä¢ -10 Lunaris\n‚Ä¢ Streak reset\n‚Ä¢ -10% Energy\n\nStay focused next time!');
        }

        // Daily check-in
        const dailyCheckInBtn = document.getElementById('daily-check-in-btn');
        const checkInStatus = document.getElementById('check-in-status');
        const checkInOptions = document.getElementById('check-in-options');
        const checkInMessage = document.getElementById('check-in-message');

        function checkDailyCheckInStatus() {
            const today = new Date().toDateString();
            if (colonyData.lastCheckIn === today) {
                dailyCheckInBtn.disabled = true;
                dailyCheckInBtn.textContent = '‚úÖ Daily Check-In Complete';
                checkInMessage.textContent = 'Come back tomorrow for your next check-in!';
            }
        }

        dailyCheckInBtn.addEventListener('click', () => {
            checkInStatus.style.display = 'none';
            checkInOptions.style.display = 'block';
        });

        document.querySelectorAll('.check-in-option').forEach(btn => {
            btn.addEventListener('click', () => {
                performDailyCheckIn(btn.dataset.resource);
            });
        });

        async function performDailyCheckIn(priorityResource) {
            const today = new Date().toDateString();

            // OPTIMIZED: Check local data first (fast), then validate with Firebase
            if (colonyData.lastCheckIn === today) {
                showModal('error', '‚ùå Already Checked In', 'You have already completed your daily check-in today!\n\nCome back tomorrow for your next check-in.');
                checkInOptions.style.display = 'none';
                checkInStatus.style.display = 'block';
                dailyCheckInBtn.disabled = true;
                dailyCheckInBtn.textContent = '‚úÖ Daily Check-In Complete';
                return;
            }

            // Update UI immediately for snappy response
            colonyData.lastCheckIn = today;
            let bonus = 50;

            if (currentRole && currentRole.perks.dailyBonus) {
                if (currentRole.perks.dailyBonus === 'oxygen' && priorityResource === 'oxygen') {
                    bonus += 25;
                    colonyData.oxygen = Math.min(100, colonyData.oxygen + 10);
                } else if (currentRole.perks.dailyBonus === 'hydroponics' && priorityResource === 'hydroponics') {
                    bonus += 25;
                    colonyData.hydroponics = Math.min(100, colonyData.hydroponics + 10);
                }
            }

            colonyData.lunaris += bonus;

            if (priorityResource === 'oxygen') {
                colonyData.oxygen = Math.min(100, colonyData.oxygen + 5);
            } else if (priorityResource === 'hydroponics') {
                colonyData.hydroponics = Math.min(100, colonyData.hydroponics + 5);
            } else if (priorityResource === 'energy') {
                colonyData.energy = Math.min(100, colonyData.energy + 5);
            }

            // Update UI instantly
            updateResourceDisplays();
            checkInOptions.style.display = 'none';
            checkInStatus.style.display = 'block';
            dailyCheckInBtn.disabled = true;
            dailyCheckInBtn.textContent = '‚úÖ Daily Check-In Complete';
            checkInMessage.innerHTML = `<span style="color: #FFCC00; font-weight: bold;">+${bonus} Lunaris earned!</span><br>Priority resource boosted. Great work, colonist!`;

            // Save to Firebase in background (non-blocking)
            const checkInXP = 15;
            Promise.all([
                awardXP(checkInXP, 'daily check-in'),
                saveColonyData()
            ]).catch(error => {
                console.error('Error saving check-in:', error);
            });
        }

        // Streak tracking
        function checkAndUpdateStreak() {
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();

            if (colonyData.lastCheckIn === today) {
                return;
            } else if (colonyData.lastCheckIn === yesterday) {
                colonyData.streak++;
            } else if (colonyData.lastCheckIn) {
                colonyData.streak = 0;
            }

            saveColonyData();
        }

        // Task management
        const taskTypeSelect = document.getElementById('task-type-select');
        const taskDescInput = document.getElementById('task-desc-input');
        const timeCommitment = document.getElementById('time-commitment');
        const createTaskBtn = document.getElementById('create-task-btn');
        const tasksList = document.getElementById('tasks-list');
        const completedTasksList = document.getElementById('completed-tasks-list');

        createTaskBtn.addEventListener('click', createTask);

        function createTask() {
            const taskType = taskTypeSelect.value;
            const customDesc = taskDescInput.value.trim();
            const minutes = parseInt(timeCommitment.value);

            if (!taskType) {
                showModal('warning', '‚ö†Ô∏è Missing Information', 'Please select a mission type!');
                return;
            }

            if (!minutes || minutes < 1) {
                showModal('warning', '‚ö†Ô∏è Invalid Time', 'Please set a valid time commitment!');
                return;
            }

            const taskTypeData = TASK_TYPES[taskType];
            const task = {
                id: Date.now(),
                type: taskType,
                name: taskTypeData.name,
                description: customDesc || 'Complete this mission to earn Lunaris tokens',
                baseReward: taskTypeData.baseReward,
                resources: taskTypeData.resources,
                perkType: taskTypeData.perkType,
                timeCommitment: minutes,
                createdAt: Date.now()
            };

            colonyData.tasks.push(task);
            saveColonyData();
            renderTasks();

            taskTypeSelect.value = '';
            taskDescInput.value = '';
            timeCommitment.value = '25';
        }

        function renderTasks() {
            if (colonyData.tasks.length === 0) {
                tasksList.innerHTML = '<p class="empty-message">No active missions. Create your first mission above!</p>';
            } else {
                tasksList.innerHTML = colonyData.tasks.map(task => `
                    <div class="task-card">
                        <div class="task-header">
                            <div class="task-info">
                                <h4>${task.name}</h4>
                                <p>${task.description}</p>
                                <p style="color: rgba(255,204,0,0.7);">‚è±Ô∏è ${task.timeCommitment} minutes</p>
                            </div>
                            <div class="task-reward">+${calculateReward(task)} üí∞</div>
                        </div>
                        <div class="task-actions">
                            <button onclick="startFocusMode(${task.id})" class="btn" style="flex: 1;">üîí Start Focus Mode</button>
                            <button onclick="deleteTask(${task.id})" class="btn btn-danger">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('');
            }

            const today = new Date().toDateString();
            const todayCompleted = colonyData.completedToday.filter(t => new Date(t.completedAt).toDateString() === today);

            if (todayCompleted.length === 0) {
                completedTasksList.innerHTML = '<p class="empty-message">No missions completed yet today.</p>';
            } else {
                completedTasksList.innerHTML = todayCompleted.map(task => `
                    <div class="completed-task">
                        <div>
                            <span class="task-name">${task.name}</span>
                            <span class="task-meta">Completed ‚Ä¢ ${task.timeCommitment} min</span>
                        </div>
                        <span class="reward">+${task.reward} üí∞</span>
                    </div>
                `).join('');
            }
        }

        // Focus Mode
        let focusModeTimer = null;
        let focusStartTime = null;
        let focusDuration = 0;
        let currentFocusTask = null;
        let tabChangeDetected = false;

        window.startFocusMode = function(taskId) {
            const task = colonyData.tasks.find(t => t.id === taskId);
            if (!task) return;

            showConfirm(
                'üîí Start Focus Mode?',
                `${task.name}\nDuration: ${task.timeCommitment} minutes\n\n‚ö†Ô∏è Leaving early = Penalties:\n‚Ä¢ -10 Lunaris\n‚Ä¢ Mission failed\n‚Ä¢ Streak reset`,
                () => {
                    // User confirmed - start focus mode
                    beginFocusMode(task);
                }
            );
        };

        function beginFocusMode(task) {
            // Special handling for journal/logging tasks - redirect to notes app
            if (task.type === 'logging') {
                const focusUrl = `/Learning JS/notes.html?focus=true&duration=${task.timeCommitment}&taskId=${task.id}`;
                window.location.href = focusUrl;
                return;
            }

            currentFocusTask = task;
            focusDuration = task.timeCommitment * 60;
            focusStartTime = Date.now();
            tabChangeDetected = false;

            document.getElementById('focus-mode-screen').style.display = 'block';
            document.getElementById('focus-task-name').textContent = task.name;

            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(() => {});
            }

            if ('wakeLock' in navigator) {
                navigator.wakeLock.request('screen').catch(() => {});
            }

            startFocusTimer();
            document.addEventListener('visibilitychange', handleVisibilityChange);
        };

        function startFocusTimer() {
            updateTimerDisplay();

            focusModeTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - focusStartTime) / 1000);
                const remaining = focusDuration - elapsed;

                if (remaining <= 0) {
                    completeFocusMode(true);
                } else {
                    updateTimerDisplay();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const elapsed = Math.floor((Date.now() - focusStartTime) / 1000);
            const remaining = Math.max(0, focusDuration - elapsed);

            const minutes = Math.floor(remaining / 60);
            const seconds = remaining % 60;

            document.getElementById('time-remaining').textContent =
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            const progress = ((focusDuration - remaining) / focusDuration) * 100;
            document.getElementById('progress-bar').style.width = progress + '%';
        }

        function handleVisibilityChange() {
            if (document.hidden && currentFocusTask) {
                tabChangeDetected = true;
                document.getElementById('focus-warning').style.display = 'block';
            }
        }

        async function completeFocusMode(success) {
            clearInterval(focusModeTimer);
            document.removeEventListener('visibilitychange', handleVisibilityChange);

            if (document.fullscreenElement) {
                document.exitFullscreen();
            }

            document.getElementById('focus-mode-screen').style.display = 'none';

            if (success && !tabChangeDetected) {
                await completeTask(currentFocusTask.id);

                // Bonus XP for completing focus mode (requires extra dedication)
                const focusBonusXP = 20;
                await awardXP(focusBonusXP, 'focus mode bonus');

                showModal('success', 'üéâ Mission Complete!', `+${calculateReward(currentFocusTask)} Lunaris earned!\n+${focusBonusXP} XP Focus Bonus!\n\nExcellent focus, colonist!`);
            } else {
                applyFocusPenalties();
            }

            currentFocusTask = null;
            tabChangeDetected = false;
        }

        function applyFocusPenalties() {
            colonyData.lunaris = Math.max(0, colonyData.lunaris - 10);
            colonyData.streak = 0;
            colonyData.energy = Math.max(0, colonyData.energy - 10);

            const failedTask = { ...currentFocusTask, failedAt: Date.now(), reason: 'Left Focus Mode early' };
            colonyData.failedTasks.push(failedTask);

            const taskIndex = colonyData.tasks.findIndex(t => t.id === currentFocusTask.id);
            if (taskIndex !== -1) {
                colonyData.tasks.splice(taskIndex, 1);
            }

            saveColonyData();
            updateResourceDisplays();
            renderTasks();

            showModal('error', '‚ùå Mission Failed', 'Penalties applied:\n‚Ä¢ -10 Lunaris\n‚Ä¢ Streak reset\n‚Ä¢ -10% Energy\n\nStay focused next time, colonist.');
        }

        document.getElementById('emergency-exit').addEventListener('click', () => {
            showConfirm(
                '‚ö†Ô∏è Emergency Exit?',
                'Are you sure? This will apply all penalties!',
                () => {
                    completeFocusMode(false);
                }
            );
        });

        window.completeTask = async function(taskId) {
            const taskIndex = colonyData.tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;

            const task = colonyData.tasks[taskIndex];
            const reward = calculateReward(task);

            colonyData.lunaris += reward;

            if (task.resources) {
                Object.entries(task.resources).forEach(([resource, amount]) => {
                    if (resource === 'oxygen') {
                        colonyData.oxygen = Math.max(0, Math.min(100, colonyData.oxygen + amount));
                    } else if (resource === 'hydroponics') {
                        colonyData.hydroponics = Math.max(0, Math.min(100, colonyData.hydroponics + amount));
                    } else if (resource === 'energy') {
                        colonyData.energy = Math.max(0, Math.min(100, colonyData.energy + amount));
                    }
                });
            }

            // Award XP based on task difficulty (time commitment)
            const taskXP = calculateTaskXP(task);
            await awardXP(taskXP, `completing ${task.name}`);

            const completedTask = { ...task, completedAt: Date.now(), reward, xpEarned: taskXP };
            colonyData.completedToday.push(completedTask);
            colonyData.tasks.splice(taskIndex, 1);

            saveColonyData();
            updateResourceDisplays();
            renderTasks();
        };

        function calculateTaskXP(task) {
            // Base XP scales with time commitment
            const timeMinutes = task.timeCommitment || 10;

            if (timeMinutes <= 5) return 5; // Quick tasks
            if (timeMinutes <= 15) return 10; // Short tasks
            if (timeMinutes <= 30) return 15; // Medium tasks
            if (timeMinutes <= 60) return 20; // Long tasks
            return 25; // Very long tasks (over 1 hour)
        }

        window.deleteTask = function(taskId) {
            showConfirm(
                'üóëÔ∏è Delete Mission?',
                'Are you sure you want to delete this mission?',
                () => {
                    const taskIndex = colonyData.tasks.findIndex(t => t.id === taskId);
                    if (taskIndex !== -1) {
                        colonyData.tasks.splice(taskIndex, 1);
                        saveColonyData();
                        renderTasks();
                    }
                }
            );
        };

        function calculateReward(task) {
            let reward = task.baseReward;

            if (currentRole && task.perkType && currentRole.perks[task.perkType]) {
                const multiplier = currentRole.perks[task.perkType];
                reward = Math.floor(reward * multiplier);
            }

            if (currentRole && currentRole.perks.streakBonus && colonyData.streak > 0) {
                reward = Math.floor(reward * currentRole.perks.streakBonus);
            }

            return reward;
        }

        function updateResourceDisplays() {
            document.getElementById('lunaris-display').textContent = colonyData.lunaris;
            document.getElementById('oxygen-display').textContent = colonyData.oxygen + '%';
            document.getElementById('hydroponics-display').textContent = colonyData.hydroponics + '%';
            document.getElementById('energy-display').textContent = colonyData.energy + '%';
            document.getElementById('streak-display').textContent = colonyData.streak + ' days';
        }

        async function saveColonyData() {
            // ANTI-CHEAT VALIDATION: Enforce valid ranges
            // Prevent negative Lunaris
            colonyData.lunaris = Math.max(0, colonyData.lunaris);

            // Prevent resources from exceeding 100% or going negative
            colonyData.oxygen = Math.max(0, Math.min(100, colonyData.oxygen));
            colonyData.hydroponics = Math.max(0, Math.min(100, colonyData.hydroponics));
            colonyData.energy = Math.max(0, Math.min(100, colonyData.energy));

            // Prevent negative streak
            colonyData.streak = Math.max(0, colonyData.streak);

            // Ensure arrays exist
            colonyData.tasks = colonyData.tasks || [];
            colonyData.completedToday = colonyData.completedToday || [];
            colonyData.failedTasks = colonyData.failedTasks || [];

            console.log('üíæ Saving colony data:', {
                lunaris: colonyData.lunaris,
                oxygen: colonyData.oxygen,
                hydroponics: colonyData.hydroponics,
                energy: colonyData.energy
            });

            // INSTANT CACHE: Save to localStorage immediately (instant feedback)
            const cachedData = {
                ...colonyData,
                _cacheTime: Date.now() // Add timestamp for cache validation
            };
            localStorage.setItem('colonyData', JSON.stringify(cachedData));

            // Save to Firebase if user is authenticated (PRIMARY source) - in background
            if (userUID) {
                try {
                    const userDataRef = ref(database, `colony-data/${userUID}`);
                    await set(userDataRef, {
                        lunaris: colonyData.lunaris,
                        oxygen: colonyData.oxygen,
                        hydroponics: colonyData.hydroponics,
                        energy: colonyData.energy,
                        streak: colonyData.streak,
                        lastCheckIn: colonyData.lastCheckIn,
                        tasks: colonyData.tasks,
                        completedToday: colonyData.completedToday,
                        failedTasks: colonyData.failedTasks,
                        lastUpdated: Date.now()
                    });
                    console.log('‚úÖ Data saved to Firebase successfully');
                } catch (error) {
                    console.error('‚ùå Firebase save error:', error);
                }
            }
        }

        // ============================================
        // WALLET FUNCTIONALITY
        // ============================================

        const walletModal = document.getElementById('walletModal');
        const closeWallet = document.getElementById('closeWallet');
        let userWalletAddress = null;

        // Close wallet modal
        closeWallet.addEventListener('click', () => {
            walletModal.classList.remove('show');
        });

        // Close modal when clicking outside
        walletModal.addEventListener('click', (e) => {
            if (e.target === walletModal) {
                walletModal.classList.remove('show');
            }
        });

        // Tab switching
        const walletTabs = document.querySelectorAll('.wallet-tab');
        walletTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');

                // Update active tab
                walletTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Show corresponding content
                document.getElementById('sendTab').classList.remove('active');
                document.getElementById('receiveTab').classList.remove('active');
                document.getElementById(tabName + 'Tab').classList.add('active');
            });
        });

        // Load wallet data
        async function loadWalletData() {
            try {
                const userData = JSON.parse(localStorage.getItem('currentUser'));

                if (userData) {
                    // Check localStorage first
                    userWalletAddress = userData.walletAddress || userData.solanaWallet;

                    // If not in localStorage, check Firebase
                    if (!userWalletAddress && userData.uid) {
                        console.log('No wallet in localStorage, checking Firebase...');
                        const walletRef = ref(database, `user-wallets/${userData.uid}`);
                        const snapshot = await get(walletRef);

                        if (snapshot.exists()) {
                            const walletData = snapshot.val();
                            userWalletAddress = walletData.address;

                            // Update localStorage with Firebase wallet
                            userData.solanaWallet = userWalletAddress;
                            localStorage.setItem('currentUser', JSON.stringify(userData));
                            console.log('‚úÖ Loaded wallet from Firebase:', userWalletAddress);
                        }
                    }

                    if (userWalletAddress) {
                        // Display wallet address
                        const shortAddress = userWalletAddress.substring(0, 6) + '...' + userWalletAddress.substring(38);
                        document.getElementById('walletAddressDisplay').textContent = shortAddress;
                        document.getElementById('receiveAddressDisplay').textContent = userWalletAddress;

                        // Hide generate button
                        document.getElementById('generateWalletSection').style.display = 'none';

                        // Fetch balance
                        await fetchBalance();

                        // Generate QR code
                        generateQRCode(userWalletAddress);
                    } else {
                        document.getElementById('walletAddressDisplay').textContent = 'No wallet found';
                        document.getElementById('receiveAddressDisplay').textContent = 'Click below to generate';

                        // Show generate button
                        document.getElementById('generateWalletSection').style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error loading wallet data:', error);
            }
        }

        // Generate Solana wallet
        document.getElementById('generateWalletBtn').addEventListener('click', async () => {
            try {
                const userData = JSON.parse(localStorage.getItem('currentUser'));
                if (!userData || !userData.uid) {
                    showModal('error', '‚ùå Error', 'User ID not found. Please sign out and sign in again.');
                    return;
                }

                const userId = userData.uid;

                showModal('info', '‚è≥ Generating...', 'Creating your Solana wallet address...');

                // Check if wallet already exists in Firebase
                const walletRef = ref(database, `user-wallets/${userId}`);
                const snapshot = await get(walletRef);

                let walletData;

                if (snapshot.exists()) {
                    // Wallet exists in Firebase, use it
                    walletData = snapshot.val();
                    console.log('Wallet already exists in Firebase, using existing wallet');
                } else {
                    // Create new Solana wallet
                    const keypair = solanaWeb3.Keypair.generate();
                    const walletAddress = keypair.publicKey.toString();
                    const privateKey = Buffer.from(keypair.secretKey).toString('base64');

                    walletData = {
                        address: walletAddress,
                        privateKey: privateKey, // IMPORTANT: In production, encrypt this!
                        createdAt: Date.now(),
                        type: 'generated'
                    };

                    // Store wallet in Firebase
                    await set(walletRef, walletData);
                    console.log('‚úÖ New wallet created and saved to Firebase');
                }

                // Update localStorage
                userData.solanaWallet = walletData.address;
                localStorage.setItem('currentUser', JSON.stringify(userData));

                // Reload wallet display
                await loadWalletData();

                showModal('success', '‚úÖ Success!', `Wallet generated successfully!\n\nAddress: ${walletData.address.substring(0, 6)}...${walletData.address.substring(38)}\n\nYou can now receive SOL and tokens!`);

            } catch (error) {
                console.error('Error generating wallet:', error);
                showModal('error', '‚ùå Generation Failed', `Failed to generate wallet: ${error.message}`);
            }
        });

        // Fetch SOL balance
        async function fetchBalance() {
            try {
                const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('devnet'));
                const publicKey = new solanaWeb3.PublicKey(userWalletAddress);
                const balance = await connection.getBalance(publicKey);
                const solBalance = (balance / solanaWeb3.LAMPORTS_PER_SOL).toFixed(4);

                document.getElementById('solBalanceDisplay').textContent = solBalance;
            } catch (error) {
                console.error('Error fetching balance:', error);
                document.getElementById('solBalanceDisplay').textContent = '0.00';
            }
        }

        // Refresh balance button
        document.getElementById('refreshBalanceBtn').addEventListener('click', async () => {
            await fetchBalance();
        });

        // Copy address buttons
        document.getElementById('copyAddressBtn').addEventListener('click', () => {
            copyToClipboard(userWalletAddress, 'Wallet address copied!');
        });

        document.getElementById('copyReceiveAddressBtn').addEventListener('click', () => {
            copyToClipboard(userWalletAddress, 'Receive address copied!');
        });

        function copyToClipboard(text, message) {
            navigator.clipboard.writeText(text).then(() => {
                showModal('success', '‚úÖ Copied!', message);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Generate QR Code
        function generateQRCode(address) {
            const qrContainer = document.getElementById('qrCodeContainer');
            qrContainer.innerHTML = `
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${address}"
                     alt="QR Code"
                     style="display: block; margin: 0 auto;">
            `;
        }

        // Send SOL functionality - supports both Phantom and app-created wallets
        document.getElementById('sendTokenBtn').addEventListener('click', async () => {
            const recipientAddress = document.getElementById('recipientAddress').value.trim();
            const amount = parseFloat(document.getElementById('sendAmount').value);

            if (!recipientAddress) {
                showModal('error', '‚ùå Error', 'Please enter a recipient address');
                return;
            }

            if (!amount || amount <= 0) {
                showModal('error', '‚ùå Error', 'Please enter a valid amount');
                return;
            }

            try {
                // Validate recipient address
                try {
                    new solanaWeb3.PublicKey(recipientAddress);
                } catch (e) {
                    showModal('error', '‚ùå Invalid Address', 'Please enter a valid Solana address');
                    return;
                }

                // Check if user has Phantom wallet connected
                if (typeof window.solana !== 'undefined' && window.solana.isPhantom && userWalletAddress === window.solana.publicKey.toString()) {
                    await sendWithPhantom(recipientAddress, amount);
                } else {
                    // Use app-created wallet
                    await sendWithAppWallet(recipientAddress, amount);
                }
            } catch (error) {
                console.error('Send error:', error);
                showModal('error', '‚ùå Transaction Failed', error.message);
            }
        });

        // Send with Phantom wallet
        async function sendWithPhantom(recipientAddress, amount) {
            try {
                const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('devnet'));
                const transaction = new solanaWeb3.Transaction().add(
                    solanaWeb3.SystemProgram.transfer({
                        fromPubkey: window.solana.publicKey,
                        toPubkey: new solanaWeb3.PublicKey(recipientAddress),
                        lamports: amount * solanaWeb3.LAMPORTS_PER_SOL
                    })
                );

                const { signature } = await window.solana.signAndSendTransaction(transaction);
                await connection.confirmTransaction(signature);

                showModal('success', '‚úÖ Success!', `Transaction completed!<br><small>Signature: ${signature.substring(0, 8)}...</small>`);

                // Refresh balance
                await fetchBalance();

                // Clear form
                document.getElementById('recipientAddress').value = '';
                document.getElementById('sendAmount').value = '';
            } catch (error) {
                throw error;
            }
        }

        // Send with app-created wallet (Google login wallets)
        async function sendWithAppWallet(recipientAddress, amount) {
            try {
                const userData = JSON.parse(localStorage.getItem('currentUser'));
                if (!userData || !userData.uid) {
                    showModal('error', '‚ùå Error', 'User not found. Please sign in again.');
                    return;
                }

                // Retrieve private key from Firebase
                const walletRef = ref(database, `user-wallets/${userData.uid}`);
                const snapshot = await get(walletRef);

                if (!snapshot.exists() || !snapshot.val().privateKey) {
                    showModal('error', '‚ùå Error', 'Wallet private key not found. This wallet cannot send transactions.');
                    return;
                }

                const walletData = snapshot.val();

                // ‚ö†Ô∏è SECURITY NOTE: Retrieving private key from Firebase
                // In production, this should be encrypted at rest and decrypted here
                const privateKeyBuffer = Buffer.from(walletData.privateKey, 'base64');
                const keypair = solanaWeb3.Keypair.fromSecretKey(privateKeyBuffer);

                // Verify the keypair matches the displayed wallet
                if (keypair.publicKey.toString() !== userWalletAddress) {
                    showModal('error', '‚ùå Error', 'Wallet mismatch. Please refresh and try again.');
                    return;
                }

                // Connect to devnet (change to mainnet-beta for production)
                const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('devnet'));

                // Check balance
                const balance = await connection.getBalance(keypair.publicKey);
                const balanceInSOL = balance / solanaWeb3.LAMPORTS_PER_SOL;

                if (balanceInSOL < amount) {
                    showModal('error', '‚ùå Insufficient Balance', `You only have ${balanceInSOL.toFixed(4)} SOL`);
                    return;
                }

                // Create and send transaction
                const transaction = new solanaWeb3.Transaction().add(
                    solanaWeb3.SystemProgram.transfer({
                        fromPubkey: keypair.publicKey,
                        toPubkey: new solanaWeb3.PublicKey(recipientAddress),
                        lamports: amount * solanaWeb3.LAMPORTS_PER_SOL
                    })
                );

                // Sign and send
                const signature = await solanaWeb3.sendAndConfirmTransaction(
                    connection,
                    transaction,
                    [keypair]
                );

                showModal('success', '‚úÖ Transaction Successful!',
                    `Sent ${amount} SOL to ${recipientAddress.substring(0, 4)}...${recipientAddress.substring(40)}\n\n` +
                    `Signature: ${signature.substring(0, 8)}...\n\n` +
                    `View on Solana Explorer: https://explorer.solana.com/tx/${signature}?cluster=devnet`
                );

                // Refresh balance
                await fetchBalance();

                // Clear form
                document.getElementById('recipientAddress').value = '';
                document.getElementById('sendAmount').value = '';
            } catch (error) {
                console.error('App wallet send error:', error);
                throw error;
            }
        }

        // ============================================
        // LUNARIS SPL TOKEN FUNCTIONS (Future Integration)
        // ============================================

        // Send Lunaris SPL tokens (to be implemented when token is deployed)
        async function sendLunarisToken(recipientAddress, amount) {
            try {
                const userData = JSON.parse(localStorage.getItem('currentUser'));
                if (!userData || !userData.uid) {
                    showModal('error', '‚ùå Error', 'User not found. Please sign in again.');
                    return;
                }

                // Retrieve private key from Firebase
                const walletRef = ref(database, `user-wallets/${userData.uid}`);
                const snapshot = await get(walletRef);

                if (!snapshot.exists() || !snapshot.val().privateKey) {
                    showModal('error', '‚ùå Error', 'Wallet private key not found.');
                    return;
                }

                const walletData = snapshot.val();
                const privateKeyBuffer = Buffer.from(walletData.privateKey, 'base64');
                const keypair = solanaWeb3.Keypair.fromSecretKey(privateKeyBuffer);

                const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('devnet'));

                // TODO: Replace with actual Lunaris token mint address when deployed
                const LUNARIS_TOKEN_MINT = 'YOUR_TOKEN_MINT_ADDRESS_HERE';

                // This will use @solana/spl-token library
                // Example code structure (uncomment when token is deployed):
                /*
                const { Token, TOKEN_PROGRAM_ID } = require('@solana/spl-token');

                const mintPublicKey = new solanaWeb3.PublicKey(LUNARIS_TOKEN_MINT);
                const recipientPublicKey = new solanaWeb3.PublicKey(recipientAddress);

                // Get or create associated token accounts
                const fromTokenAccount = await Token.getAssociatedTokenAddress(
                    ASSOCIATED_TOKEN_PROGRAM_ID,
                    TOKEN_PROGRAM_ID,
                    mintPublicKey,
                    keypair.publicKey
                );

                const toTokenAccount = await Token.getAssociatedTokenAddress(
                    ASSOCIATED_TOKEN_PROGRAM_ID,
                    TOKEN_PROGRAM_ID,
                    mintPublicKey,
                    recipientPublicKey
                );

                // Create transfer instruction
                const transaction = new solanaWeb3.Transaction().add(
                    Token.createTransferInstruction(
                        TOKEN_PROGRAM_ID,
                        fromTokenAccount,
                        toTokenAccount,
                        keypair.publicKey,
                        [],
                        amount * Math.pow(10, 9) // Assuming 9 decimals
                    )
                );

                const signature = await solanaWeb3.sendAndConfirmTransaction(
                    connection,
                    transaction,
                    [keypair]
                );

                showModal('success', '‚úÖ Lunaris Sent!',
                    `Sent ${amount} LUNARIS\n\nSignature: ${signature.substring(0, 8)}...`
                );
                */

                showModal('info', '‚ÑπÔ∏è Coming Soon',
                    'Lunaris SPL token integration is ready for deployment!\n\n' +
                    'Once the token is minted on Solana, this function will enable transfers.'
                );

            } catch (error) {
                console.error('Lunaris token send error:', error);
                showModal('error', '‚ùå Error', error.message);
            }
        }

        // Make Lunaris token function globally available
        window.sendLunarisToken = sendLunarisToken;

        // ============================================
        // SIDEBAR FUNCTIONALITY
        // ============================================

        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const appContainer = document.getElementById('app-container');

        // Toggle sidebar
        function toggleSidebar() {
            const isCurrentlyOpen = !sidebar.classList.contains('collapsed');

            sidebar.classList.toggle('collapsed');
            sidebarToggle.classList.toggle('sidebar-open');
            sidebarOverlay.classList.toggle('active');
            appContainer.classList.toggle('sidebar-collapsed');

            // Save state to localStorage
            const isCollapsed = sidebar.classList.contains('collapsed');
            localStorage.setItem('sidebarCollapsed', isCollapsed);
        }

        // Event listeners
        sidebarToggle.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);

        // Wallet nav item trigger
        document.getElementById('wallet-nav-item').addEventListener('click', () => {
            loadWalletData();
            walletModal.classList.add('show');
            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
                if (!sidebar.classList.contains('collapsed')) {
                    toggleSidebar();
                }
            }
        });

        // Load saved sidebar state - start with sidebar OPEN by default
        const savedState = localStorage.getItem('sidebarCollapsed');
        if (savedState === 'true') {
            // Only collapse if user explicitly collapsed it before
            sidebar.classList.add('collapsed');
            sidebarToggle.classList.remove('sidebar-open');
            appContainer.classList.add('sidebar-collapsed');
            sidebarOverlay.classList.remove('active');
        }

        // Close sidebar on mobile when clicking nav links
        document.querySelectorAll('.sidebar .nav-item[href]').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768 && !sidebar.classList.contains('collapsed')) {
                    toggleSidebar();
                }
            });
        });

        // Update sidebar items based on phase unlocks (called from unlock functions)
        function updateSidebarNexusCrater(isUnlocked) {
            const sidebarClaim = document.getElementById('sidebar-nexus-claim');
            const sidebarMarket = document.getElementById('sidebar-nexus-market');
            const sidebarRush = document.getElementById('sidebar-nexus-rush');
            const sidebarLocked = document.getElementById('sidebar-nexus-locked');

            if (isUnlocked) {
                sidebarClaim.style.display = 'flex';
                sidebarMarket.style.display = 'flex';
                sidebarRush.style.display = 'flex';
                sidebarLocked.style.display = 'none';
            } else {
                sidebarClaim.style.display = 'none';
                sidebarMarket.style.display = 'none';
                sidebarRush.style.display = 'none';
                sidebarLocked.style.display = 'flex';
            }
        }

        function updateSidebarRedDunes(isUnlocked) {
            const sidebarHub = document.getElementById('sidebar-red-dunes');
            const sidebarAchievements = document.getElementById('sidebar-achievements');
            const sidebarRacer = document.getElementById('sidebar-dune-racer');
            const sidebarExpeditions = document.getElementById('sidebar-expeditions');
            const sidebarDiscovery = document.getElementById('sidebar-discovery');
            const sidebarLocked = document.getElementById('sidebar-red-dunes-locked');

            if (isUnlocked) {
                sidebarHub.style.display = 'flex';
                sidebarAchievements.style.display = 'flex';
                sidebarRacer.style.display = 'flex';
                sidebarExpeditions.style.display = 'flex';
                sidebarDiscovery.style.display = 'flex';
                sidebarLocked.style.display = 'none';
            } else {
                sidebarHub.style.display = 'none';
                sidebarAchievements.style.display = 'none';
                sidebarRacer.style.display = 'none';
                sidebarExpeditions.style.display = 'none';
                sidebarDiscovery.style.display = 'none';
                sidebarLocked.style.display = 'flex';
            }
        }
    </script>
</body>
</html>
