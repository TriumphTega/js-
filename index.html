<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Welcome to Lunaris</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel="stylesheet" href="/Learning JS/index.css">
</head>
<body>
    <div id="app-container">
        <!-- Main Title -->
        <h1 id="main-title">Lunaris</h1>
        <div id="beta-badge">Beta Version</div>

        <!-- Story Section -->
        <div class="content-section">
            <h2 class="section-title">üöÄ Humans have reached Mars</h2>
            <p class="story-text">The Starship rocket successfully landed on the red planet this morning.</p>
            <p class="story-text">After a 115 days long journey, the crew of 12 finally arrived at their destination. This is the first time humans have set foot on a planet other than Earth.</p>
        </div>

        <!-- Sign In Section -->
        <div class="content-section" id="signin-section">
            <h2 class="section-title">Sign up to join the first colony!</h2>

            <button id="googleSignIn" class="google-signin-btn">
                <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                    <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                    <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                    <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                    <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                    <path fill="none" d="M0 0h48v48H0z"/>
                </svg>
                <span>Sign in with Google</span>
            </button>

            <div class="divider">OR</div>

            <button id="walletSignInBtn" class="wallet-signin-btn">
                <span>üîê</span>
                <span>Sign in with Wallet </span>
            </button>
        </div>

        <!-- User Info (shown after sign-in) -->
        <div class="content-section" id="user-info">
            <h2 class="section-title">Welcome!</h2>
            <img id="userPhoto" src="" alt="Profile" id="user-avatar" style="display: none;">
            <div class="user-name" id="userName"></div>

            <div class="btn-grid">
                <button id="goToDashboard" class="btn">üöÄ Colony Dashboard</button>
                <button id="goToNotes" class="btn">üìù My Notes</button>
            </div>

            <button id="signOut" class="btn btn-secondary" style="margin-top: 15px;">Sign Out</button>
        </div>
    </div>

    <!-- Wallet Sign In Modal -->
    <div id="walletModal" class="wallet-modal">
        <div class="wallet-modal-content">
            <div class="wallet-modal-header">
                <h2>üîê Connect Your Wallet</h2>
                <span class="wallet-close" id="walletClose">&times;</span>
            </div>
            <div class="wallet-modal-body">
                <p style="color: rgba(255, 255, 255, 0.8); text-align: center; margin-bottom: 25px;">
                    Choose your preferred wallet to sign in
                </p>
                <div class="wallet-options">
                    <button class="wallet-option-btn" id="phantomBtn">
                        <div class="wallet-icon">
                            <svg width="40" height="40" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M64 0C28.6538 0 0 28.6538 0 64C0 99.3462 28.6538 128 64 128C99.3462 128 128 99.3462 128 64C128 28.6538 99.3462 0 64 0Z" fill="url(#phantom-gradient)"/>
                                <path d="M95.9998 56.7273C95.9998 80.5455 77.4544 100 53.818 100C47.6362 100 41.8907 98.5455 36.8725 95.9091C35.2362 95.0909 33.8544 94.0909 32.7271 92.7273C31.8544 91.6364 32.2362 90 33.5453 89.4545C38.0544 87.4545 48.3635 82.7273 50.3635 81.4545C51.6725 80.6364 53.2362 80.1818 54.8725 80.1818H73.818C82.8725 80.1818 90.1816 72.8727 90.1816 63.8182V60.9091C90.1816 52.7273 83.3635 46.1818 75.2726 46.1818H70.1816C68.8725 46.1818 68 45.0909 68.5453 43.8182C69.9998 40.3636 70.8725 36.5455 70.8725 32.5455C70.8725 21.2727 61.6362 12 50.3635 12C38.9998 12 29.818 21.2727 29.818 32.5455V72.7273C29.818 74.1818 28.5453 75.4545 27.0907 75.4545H23.4544C22 75.4545 20.7271 74.1818 20.7271 72.7273V32.5455C20.7271 16.3636 33.818 3.27273 50 3.27273C66.1816 3.27273 79.2726 16.3636 79.2726 32.5455C79.2726 34.5455 79.0907 36.5455 78.7271 38.5455H75.2726C78.3635 38.5455 81.2726 39.6364 83.6362 41.4545C88.5453 45.2727 91.4544 51.0909 91.4544 57.4545V63.8182C91.4544 77.7273 80.1816 88.9091 66.1816 88.9091H54.8725C54.1816 88.9091 53.4907 89.0909 52.8725 89.4545L42.5453 95.0909C48.1816 97.2727 54.2726 98.5455 60.5453 98.5455C82.5453 98.5455 100.545 80.5455 100.545 58.5455V56.7273H95.9998Z" fill="white"/>
                                <defs>
                                    <linearGradient id="phantom-gradient" x1="0" y1="0" x2="128" y2="128" gradientUnits="userSpaceOnUse">
                                        <stop stop-color="#534BB1"/>
                                        <stop offset="1" stop-color="#551BF9"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                        </div>
                        <div class="wallet-info">
                            <div class="wallet-name">Phantom</div>
                            <div class="wallet-description">Connect with Phantom wallet</div>
                        </div>
                    </button>

                    <button class="wallet-option-btn" id="solflareBtn">
                        <div class="wallet-icon">
                            <svg width="40" height="40" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect width="512" height="512" rx="256" fill="url(#solflare-gradient)"/>
                                <path d="M169.5 278.5C171.333 276.667 173.7 275.75 176.6 275.75H335.4C339.667 275.75 341.8 280.583 338.833 283.55L342.5 279.883L338.833 283.55L286.833 335.55C285 337.383 282.633 338.3 279.733 338.3H120.933C116.667 338.3 114.533 333.467 117.5 330.5L169.5 278.5Z" fill="white"/>
                                <path d="M169.5 233.5C171.4 231.6 173.767 230.65 176.6 230.65H335.4C339.667 230.65 341.8 235.483 338.833 238.45L286.833 290.45C285 292.283 282.633 293.2 279.733 293.2H120.933C116.667 293.2 114.533 288.367 117.5 285.4L169.5 233.5Z" fill="white"/>
                                <path d="M286.833 176.45C285 178.283 282.633 179.2 279.733 179.2H120.933C116.667 179.2 114.533 174.367 117.5 171.4L169.5 119.4C171.333 117.567 173.7 116.65 176.6 116.65H335.4C339.667 116.65 341.8 121.483 338.833 124.45L286.833 176.45Z" fill="white"/>
                                <defs>
                                    <linearGradient id="solflare-gradient" x1="0" y1="0" x2="512" y2="512" gradientUnits="userSpaceOnUse">
                                        <stop stop-color="#FC8F38"/>
                                        <stop offset="1" stop-color="#FEDB37"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                        </div>
                        <div class="wallet-info">
                            <div class="wallet-name">Solflare</div>
                            <div class="wallet-description">Connect with Solflare wallet</div>
                        </div>
                    </button>

                    <button class="wallet-option-btn" id="jupiterBtn">
                        <div class="wallet-icon">
                            <svg width="40" height="40" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="100" cy="100" r="100" fill="#FCC82B"/>
                                <path d="M100 40C66.8629 40 40 66.8629 40 100C40 133.137 66.8629 160 100 160C133.137 160 160 133.137 160 100C160 66.8629 133.137 40 100 40ZM100 150C72.3858 150 50 127.614 50 100C50 72.3858 72.3858 50 100 50C127.614 50 150 72.3858 150 100C150 127.614 127.614 150 100 150Z" fill="#0E0E0E"/>
                                <circle cx="100" cy="100" r="45" fill="#FCC82B"/>
                                <ellipse cx="100" cy="100" rx="80" ry="20" fill="#0E0E0E" opacity="0.3"/>
                                <ellipse cx="100" cy="100" rx="20" ry="80" fill="#0E0E0E" opacity="0.3"/>
                                <path d="M78 92C81.866 92 85 88.866 85 85C85 81.134 81.866 78 78 78C74.134 78 71 81.134 71 85C71 88.866 74.134 92 78 92Z" fill="#0E0E0E"/>
                                <path d="M122 92C125.866 92 129 88.866 129 85C129 81.134 125.866 78 122 78C118.134 78 115 81.134 115 85C115 88.866 118.134 92 122 92Z" fill="#0E0E0E"/>
                            </svg>
                        </div>
                        <div class="wallet-info">
                            <div class="wallet-name">Jupiter</div>
                            <div class="wallet-description">Connect with Jupiter wallet</div>
                        </div>
                    </button>

                    <button class="wallet-option-btn" id="walletConnectBtn">
                        <div class="wallet-icon">
                            <svg width="40" height="40" viewBox="0 0 300 185" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M61.439 36.256c48.91-47.888 128.212-47.888 177.123 0l5.886 5.764a6.041 6.041 0 0 1 0 8.67l-20.136 19.716a3.179 3.179 0 0 1-4.428 0l-8.101-7.931c-34.122-33.408-89.444-33.408-123.566 0l-8.675 8.494a3.179 3.179 0 0 1-4.428 0L54.978 51.253a6.041 6.041 0 0 1 0-8.67l6.46-6.327ZM280.206 77.03l17.922 17.547a6.041 6.041 0 0 1 0 8.67l-80.81 79.122c-2.446 2.394-6.41 2.394-8.856 0l-57.354-56.155a1.59 1.59 0 0 0-2.214 0L91.54 182.37c-2.446 2.394-6.411 2.394-8.857 0L1.872 103.247a6.041 6.041 0 0 1 0-8.671l17.922-17.547c2.445-2.394 6.41-2.394 8.856 0l57.355 56.155a1.59 1.59 0 0 0 2.214 0L145.57 77.03c2.446-2.394 6.41-2.394 8.856 0l57.355 56.155a1.59 1.59 0 0 0 2.214 0L271.35 77.03c2.446-2.394 6.41-2.394 8.856 0Z" fill="#3B99FC"/>
                            </svg>
                        </div>
                        <div class="wallet-info">
                            <div class="wallet-name">WalletConnect</div>
                            <div class="wallet-description">Scan QR with mobile wallet app</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Solana Web3.js -->
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@latest/lib/index.iife.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, push, set, serverTimestamp, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyClPgII54QDvJB3kiV1dWbqm1et_lHasvs",
            authDomain: "lunaris-45d84.firebaseapp.com",
            projectId: "lunaris-45d84",
            storageBucket: "lunaris-45d84.firebasestorage.app",
            messagingSenderId: "74359858445",
            appId: "1:74359858445:web:37772cebcbb0d71d707c44",
            measurementId: "G-ETRK2NL1N2",
            databaseURL: "https://lunaris-45d84-default-rtdb.firebaseio.com"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const provider = new GoogleAuthProvider();

        // ============================================
        // SOLANA WALLET CREATION FOR GOOGLE USERS
        // ============================================

        async function createOrGetSolanaWallet(userId) {
            try {
                // Check if wallet already exists in Firebase
                const walletRef = ref(database, `user-wallets/${userId}`);
                const snapshot = await get(walletRef);

                if (snapshot.exists()) {
                    // Wallet exists, return it
                    return snapshot.val();
                } else {
                    // Create new Solana wallet
                    const keypair = solanaWeb3.Keypair.generate();
                    const walletAddress = keypair.publicKey.toString();
                    const privateKey = Buffer.from(keypair.secretKey).toString('base64');

                    // Store wallet in Firebase
                    const walletData = {
                        address: walletAddress,
                        privateKey: privateKey, // IMPORTANT: In production, encrypt this!
                        createdAt: serverTimestamp(),
                        type: 'generated'
                    };

                    await set(walletRef, walletData);

                    return walletData;
                }
            } catch (error) {
                console.error('Error creating/getting Solana wallet:', error);
                throw error;
            }
        }

        // Google Sign In
        document.getElementById('googleSignIn').addEventListener('click', async () => {
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                console.log('User signed in:', user);

                // Create or get Solana wallet for this user
                const solanaWallet = await createOrGetSolanaWallet(user.uid);
                console.log('Solana wallet:', solanaWallet.address);

                // Set flag to allow auto-redirect to dashboard
                sessionStorage.setItem('justSignedIn', 'true');
            } catch (error) {
                console.error('Error signing in:', error);
                alert('Sign in failed: ' + error.message);
            }
        });

        // Sign Out
        document.getElementById('signOut').addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log('User signed out');
            } catch (error) {
                console.error('Error signing out:', error);
            }
        });

        // Monitor auth state and handle redirects
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                document.getElementById('userName').textContent = user.displayName || user.email;
                document.getElementById('user-info').style.display = 'block';
                document.getElementById('signin-section').style.display = 'none';

                // Show user photo if available
                if (user.photoURL) {
                    const userPhoto = document.getElementById('userPhoto');
                    userPhoto.src = user.photoURL;
                    userPhoto.style.display = 'block';
                }

                // Get or create Solana wallet for Google users
                const solanaWallet = await createOrGetSolanaWallet(user.uid);

                // Store user in localStorage with Solana wallet
                localStorage.setItem('currentUser', JSON.stringify({
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    solanaWallet: solanaWallet.address
                }));

                // Only auto-redirect if this is a fresh sign-in (not navigating back to home)
                const justSignedIn = sessionStorage.getItem('justSignedIn');
                const userRole = localStorage.getItem('userRole');

                if (userRole && justSignedIn === 'true') {
                    // Returning user with role - redirect to dashboard only on fresh sign-in
                    console.log('Returning user detected, redirecting to dashboard...');
                    sessionStorage.removeItem('justSignedIn');
                    setTimeout(() => {
                        window.location.href = '/Learning JS/dashboard.html';
                    }, 1500);
                }
            } else {
                // User is signed out
                document.getElementById('user-info').style.display = 'none';
                document.getElementById('signin-section').style.display = 'block';
                localStorage.removeItem('currentUser');
            }
        });

        // Navigate to dashboard
        document.getElementById('goToDashboard').addEventListener('click', () => {
            const userRole = localStorage.getItem('userRole');
            if (userRole) {
                window.location.href = '/Learning JS/dashboard.html';
            } else {
                window.location.href = '/Learning JS/console.html';
            }
        });

        // Navigate to notes
        document.getElementById('goToNotes').addEventListener('click', () => {
            window.location.href = '/Learning JS/notes.html';
        });

        // ============================================
        // WALLET SIGN IN MODAL
        // ============================================

        const walletModal = document.getElementById('walletModal');
        const walletSignInBtn = document.getElementById('walletSignInBtn');
        const walletClose = document.getElementById('walletClose');

        // Open wallet modal
        walletSignInBtn.addEventListener('click', () => {
            walletModal.style.display = 'block';
        });

        // Close wallet modal
        walletClose.addEventListener('click', () => {
            walletModal.style.display = 'none';
        });

        // Close on outside click
        window.addEventListener('click', (e) => {
            if (e.target === walletModal) {
                walletModal.style.display = 'none';
            }
        });

        // Wallet connection handlers
        document.getElementById('phantomBtn').addEventListener('click', async () => {
            await connectWallet('Phantom');
        });

        document.getElementById('solflareBtn').addEventListener('click', async () => {
            await connectWallet('Solflare');
        });

        document.getElementById('jupiterBtn').addEventListener('click', async () => {
            await connectWallet('Jupiter');
        });

        document.getElementById('walletConnectBtn').addEventListener('click', async () => {
            await connectWallet('WalletConnect');
        });

        async function connectWallet(walletType) {
            try {
                // Check if wallet is available
                if (walletType === 'Phantom') {
                    if (typeof window.solana !== 'undefined' && window.solana.isPhantom) {
                        const resp = await window.solana.connect();
                        const walletAddress = resp.publicKey.toString();
                        await handleWalletSignIn(walletAddress, walletType);
                    } else {
                        alert('Phantom wallet is not installed. Please install Phantom extension.');
                        window.open('https://phantom.app/', '_blank');
                    }
                } else if (walletType === 'Solflare') {
                    if (typeof window.solflare !== 'undefined') {
                        await window.solflare.connect();
                        const walletAddress = window.solflare.publicKey.toString();
                        await handleWalletSignIn(walletAddress, walletType);
                    } else {
                        alert('Solflare wallet is not installed. Please install Solflare extension.');
                        window.open('https://solflare.com/', '_blank');
                    }
                } else if (walletType === 'Jupiter') {
                    // Jupiter uses the standard Solana wallet adapter
                    if (typeof window.jupiter !== 'undefined') {
                        await window.jupiter.connect();
                        const walletAddress = window.jupiter.publicKey.toString();
                        await handleWalletSignIn(walletAddress, walletType);
                    } else {
                        alert('Jupiter wallet is not installed. Please visit Jupiter website.');
                        window.open('https://jup.ag/', '_blank');
                    }
                } else if (walletType === 'WalletConnect') {
                    alert('WalletConnect integration coming soon! Please use Phantom, Solflare, or Jupiter for now.');
                }
            } catch (error) {
                console.error('Wallet connection error:', error);
                alert('Failed to connect wallet: ' + error.message);
            }
        }

        async function handleWalletSignIn(walletAddress, walletType) {
            try {
                // Store wallet info in Firebase and localStorage
                const walletUserRef = ref(database, `wallet-users/${walletAddress}`);
                await set(walletUserRef, {
                    walletAddress: walletAddress,
                    walletType: walletType,
                    signedInAt: serverTimestamp(),
                    lastActive: serverTimestamp()
                });

                // Store in localStorage
                localStorage.setItem('currentUser', JSON.stringify({
                    uid: walletAddress,
                    walletAddress: walletAddress,
                    walletType: walletType,
                    displayName: `${walletType} User`,
                    email: null,
                    photoURL: null
                }));

                // Set flag for redirect
                sessionStorage.setItem('justSignedIn', 'true');

                // Close modal
                walletModal.style.display = 'none';

                // Show success message
                alert(`‚úÖ Connected with ${walletType}!\n\nWallet: ${walletAddress.substring(0, 6)}...${walletAddress.substring(38)}`);

                // Check if user has role, if not redirect to console
                const userRole = localStorage.getItem('userRole');
                if (!userRole) {
                    setTimeout(() => {
                        window.location.href = '/Learning JS/console.html';
                    }, 1500);
                } else {
                    setTimeout(() => {
                        window.location.href = '/Learning JS/dashboard.html';
                    }, 1500);
                }
            } catch (error) {
                console.error('Error saving wallet user:', error);
                alert('Failed to complete sign in. Please try again.');
            }
        }
    </script>

    <!-- Typing Animation -->
    <script>
        function typeWriter(element, text, speed = 100) {
            let i = 0;
            element.textContent = '';

            function type() {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                }
            }
            type();
        }

        // Initialize typing animation
        window.addEventListener('DOMContentLoaded', () => {
            const typingElement = document.getElementById('main-title');
            typeWriter(typingElement, 'Lunaris', 120);
        });
    </script>
</body>
</html>
