<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Welcome to Lunaris</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel="stylesheet" href="/Learning JS/index.css">
</head>
<body>
    <div id="app-container">
        <!-- Main Title -->
        <h1 id="main-title">Lunaris</h1>
        <div id="beta-badge">Beta Version</div>

        <!-- Story Section -->
        <div class="content-section">
            <h2 class="section-title">üöÄ Humans have reached Mars</h2>
            <p class="story-text">The Starship rocket successfully landed on the red planet this morning.</p>
            <p class="story-text">After a 115 days long journey, the crew of 12 finally arrived at their destination. This is the first time humans have set foot on a planet other than Earth.</p>
        </div>

        <!-- Sign In Section -->
        <div class="content-section" id="signin-section">
            <h2 class="section-title">Sign up to join the first colony!</h2>

            <button id="googleSignIn" class="google-signin-btn">
                <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                    <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                    <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                    <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                    <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                    <path fill="none" d="M0 0h48v48H0z"/>
                </svg>
                <span>Sign in with Google</span>
            </button>

            <div class="divider">OR</div>

            <button id="walletSignInBtn" class="wallet-signin-btn">
                <span>üîê</span>
                <span>Sign in with Wallet </span>
            </button>
        </div>

        <!-- User Info (shown after sign-in) -->
        <div class="content-section" id="user-info">
            <h2 class="section-title">Welcome!</h2>
            <img id="userPhoto" src="" alt="Profile" id="user-avatar" style="display: none;">
            <div class="user-name" id="userName"></div>

            <div class="btn-grid">
                <button id="goToDashboard" class="btn">üöÄ Colony Dashboard</button>
                <button id="goToNotes" class="btn">üìù My Notes</button>
            </div>

            <button id="signOut" class="btn btn-secondary" style="margin-top: 15px;">Sign Out</button>
        </div>
    </div>

    <!-- Wallet Sign In Modal -->
    <div id="walletModal" class="wallet-modal">
        <div class="wallet-modal-content">
            <div class="wallet-modal-header">
                <h2>üîê Connect Your Wallet</h2>
                <span class="wallet-close" id="walletClose">&times;</span>
            </div>
            <div class="wallet-modal-body">
                <p style="color: rgba(255, 255, 255, 0.8); text-align: center; margin-bottom: 25px;">
                    Choose your preferred wallet to sign in
                </p>
                <div class="wallet-options">
                    <button class="wallet-option-btn" id="phantomBtn">
                        <div class="wallet-icon">
                            <svg width="40" height="40" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect width="80" height="80" rx="16" fill="#AB9FF2"/>
                                <path d="M20.7 25.9C20.7 20.6 24.9 16.3 30.2 16.3H50.1C55.4 16.3 59.6 20.6 59.6 25.9V46.8C59.6 52.1 55.4 56.3 50.1 56.3C50.1 56.3 49.9 56.3 49.8 56.3C48.3 56.2 47.1 54.9 47.1 53.4C47.1 51.8 48.4 50.5 50 50.5C51.9 50.5 53.5 48.9 53.5 47C53.5 45.1 51.9 43.5 50 43.5H30.2C24.9 43.5 20.7 39.2 20.7 34V25.9Z" fill="white"/>
                                <circle cx="31" cy="31" r="2.5" fill="#AB9FF2"/>
                                <circle cx="43" cy="31" r="2.5" fill="#AB9FF2"/>
                            </svg>
                        </div>
                        <div class="wallet-info">
                            <div class="wallet-name">Phantom</div>
                            <div class="wallet-description">Connect with Phantom wallet</div>
                        </div>
                    </button>

                    <button class="wallet-option-btn" id="solflareBtn">
                        <div class="wallet-icon">
                            <svg width="40" height="40" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect width="100" height="100" rx="20" fill="url(#solflare-grad)"/>
                                <path d="M33.5 55.8C34.2 55.1 35.1 54.7 36.1 54.7H63.9C65.9 54.7 67 57.2 65.7 58.5L56.7 67.5C56 68.2 55.1 68.6 54.1 68.6H26.3C24.3 68.6 23.2 66.1 24.5 64.8L33.5 55.8Z" fill="white"/>
                                <path d="M33.5 46.8C34.3 46 35.2 45.6 36.1 45.6H63.9C65.9 45.6 67 48.1 65.7 49.4L56.7 58.4C56 59.1 55.1 59.5 54.1 59.5H26.3C24.3 59.5 23.2 57 24.5 55.7L33.5 46.8Z" fill="white"/>
                                <path d="M56.7 35.4C56 36.1 55.1 36.5 54.1 36.5H26.3C24.3 36.5 23.2 34 24.5 32.7L33.5 23.7C34.2 23 35.1 22.6 36.1 22.6H63.9C65.9 22.6 67 25.1 65.7 26.4L56.7 35.4Z" fill="white"/>
                                <defs>
                                    <linearGradient id="solflare-grad" x1="0" y1="0" x2="100" y2="100" gradientUnits="userSpaceOnUse">
                                        <stop stop-color="#FC8F38"/>
                                        <stop offset="1" stop-color="#FEDB37"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                        </div>
                        <div class="wallet-info">
                            <div class="wallet-name">Solflare</div>
                            <div class="wallet-description">Connect with Solflare wallet</div>
                        </div>
                    </button>

                    <button class="wallet-option-btn" id="jupiterBtn">
                        <div class="wallet-icon">
                            <svg width="40" height="40" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect width="100" height="100" rx="20" fill="#0D111C"/>
                                <circle cx="50" cy="48" r="18" fill="url(#jupiter-teal-grad)"/>
                                <ellipse cx="50" cy="48" rx="25" ry="6" fill="#19FB9B" opacity="0.3"/>
                                <path d="M42 44C43.1 44 44 43.1 44 42C44 40.9 43.1 40 42 40C40.9 40 40 40.9 40 42C40 43.1 40.9 44 42 44Z" fill="#0D111C"/>
                                <path d="M58 44C59.1 44 60 43.1 60 42C60 40.9 59.1 40 58 40C56.9 40 56 40.9 56 42C56 43.1 56.9 44 58 44Z" fill="#0D111C"/>
                                <path d="M38 34L32 30L34 36L38 34Z" fill="#19FB9B"/>
                                <path d="M62 34L68 30L66 36L62 34Z" fill="#19FB9B"/>
                                <ellipse cx="50" cy="68" rx="8" ry="3" fill="url(#jupiter-teal-grad)" opacity="0.6"/>
                                <rect x="45" y="56" width="10" height="12" rx="2" fill="url(#jupiter-teal-grad)"/>
                                <circle cx="50" cy="78" r="8" fill="#19FB9B" opacity="0.2"/>
                                <defs>
                                    <linearGradient id="jupiter-teal-grad" x1="30" y1="30" x2="70" y2="70" gradientUnits="userSpaceOnUse">
                                        <stop stop-color="#19FB9B"/>
                                        <stop offset="1" stop-color="#0FD689"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                        </div>
                        <div class="wallet-info">
                            <div class="wallet-name">Jupiter</div>
                            <div class="wallet-description">Connect with Jupiter wallet</div>
                        </div>
                    </button>

                    <button class="wallet-option-btn" id="walletConnectBtn">
                        <div class="wallet-icon">
                            <svg width="40" height="40" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect width="100" height="100" rx="20" fill="#3B99FC"/>
                                <path d="M28.5 35.2C38.8 24.9 55.2 24.9 65.5 35.2L66.8 36.5C67.3 37 67.3 37.8 66.8 38.3L62.6 42.5C62.3 42.8 61.8 42.8 61.5 42.5L59.8 40.8C52.8 33.8 41.2 33.8 34.2 40.8L32.4 42.6C32.1 42.9 31.6 42.9 31.3 42.6L27.1 38.4C26.6 37.9 26.6 37.1 27.1 36.6L28.5 35.2ZM75.2 45.2L78.8 48.8C79.3 49.3 79.3 50.1 78.8 50.6L62.3 67.1C61.8 67.6 61 67.6 60.5 67.1L48.5 55.1C48.3 54.9 48 54.9 47.8 55.1L35.8 67.1C35.3 67.6 34.5 67.6 34 67.1L17.5 50.6C17 50.1 17 49.3 17.5 48.8L21.1 45.2C21.6 44.7 22.4 44.7 22.9 45.2L34.9 57.2C35.1 57.4 35.4 57.4 35.6 57.2L47.6 45.2C48.1 44.7 48.9 44.7 49.4 45.2L61.4 57.2C61.6 57.4 61.9 57.4 62.1 57.2L74.1 45.2C74.6 44.7 75.4 44.7 75.9 45.2H75.2Z" fill="white"/>
                            </svg>
                        </div>
                        <div class="wallet-info">
                            <div class="wallet-name">WalletConnect</div>
                            <div class="wallet-description">Scan QR with mobile wallet app</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Solana Web3.js -->
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@latest/lib/index.iife.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, push, set, serverTimestamp, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyClPgII54QDvJB3kiV1dWbqm1et_lHasvs",
            authDomain: "lunaris-45d84.firebaseapp.com",
            projectId: "lunaris-45d84",
            storageBucket: "lunaris-45d84.firebasestorage.app",
            messagingSenderId: "74359858445",
            appId: "1:74359858445:web:37772cebcbb0d71d707c44",
            measurementId: "G-ETRK2NL1N2",
            databaseURL: "https://lunaris-45d84-default-rtdb.firebaseio.com"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const provider = new GoogleAuthProvider();

        // ============================================
        // SOLANA WALLET CREATION FOR GOOGLE USERS
        // ============================================

        async function createOrGetSolanaWallet(userId) {
            try {
                // Check if wallet already exists in Firebase
                const walletRef = ref(database, `user-wallets/${userId}`);
                const snapshot = await get(walletRef);

                if (snapshot.exists()) {
                    // Wallet exists, return it
                    return snapshot.val();
                } else {
                    // Create new Solana wallet
                    const keypair = solanaWeb3.Keypair.generate();
                    const walletAddress = keypair.publicKey.toString();
                    const privateKey = Buffer.from(keypair.secretKey).toString('base64');

                    // Store wallet in Firebase
                    const walletData = {
                        address: walletAddress,
                        privateKey: privateKey, // IMPORTANT: In production, encrypt this!
                        createdAt: serverTimestamp(),
                        type: 'generated'
                    };

                    await set(walletRef, walletData);

                    return walletData;
                }
            } catch (error) {
                console.error('Error creating/getting Solana wallet:', error);
                throw error;
            }
        }

        // Google Sign In
        document.getElementById('googleSignIn').addEventListener('click', async () => {
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                console.log('User signed in:', user);

                // Create or get Solana wallet for this user
                const solanaWallet = await createOrGetSolanaWallet(user.uid);
                console.log('Solana wallet:', solanaWallet.address);

                // Set flag to allow auto-redirect to dashboard
                sessionStorage.setItem('justSignedIn', 'true');
            } catch (error) {
                console.error('Error signing in:', error);
                alert('Sign in failed: ' + error.message);
            }
        });

        // Sign Out
        document.getElementById('signOut').addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log('User signed out');
            } catch (error) {
                console.error('Error signing out:', error);
            }
        });

        // Monitor auth state and handle redirects
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                document.getElementById('userName').textContent = user.displayName || user.email;
                document.getElementById('user-info').style.display = 'block';
                document.getElementById('signin-section').style.display = 'none';

                // Show user photo if available
                if (user.photoURL) {
                    const userPhoto = document.getElementById('userPhoto');
                    userPhoto.src = user.photoURL;
                    userPhoto.style.display = 'block';
                }

                // Get or create Solana wallet for Google users
                const solanaWallet = await createOrGetSolanaWallet(user.uid);

                // Store user in localStorage with Solana wallet
                localStorage.setItem('currentUser', JSON.stringify({
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    solanaWallet: solanaWallet.address
                }));

                // Only auto-redirect if this is a fresh sign-in (not navigating back to home)
                const justSignedIn = sessionStorage.getItem('justSignedIn');
                const userRole = localStorage.getItem('userRole');

                if (userRole && justSignedIn === 'true') {
                    // Returning user with role - redirect to dashboard only on fresh sign-in
                    console.log('Returning user detected, redirecting to dashboard...');
                    sessionStorage.removeItem('justSignedIn');
                    setTimeout(() => {
                        window.location.href = '/Learning JS/dashboard.html';
                    }, 1500);
                }
            } else {
                // User is signed out
                document.getElementById('user-info').style.display = 'none';
                document.getElementById('signin-section').style.display = 'block';
                localStorage.removeItem('currentUser');
            }
        });

        // Navigate to dashboard
        document.getElementById('goToDashboard').addEventListener('click', () => {
            const userRole = localStorage.getItem('userRole');
            if (userRole) {
                window.location.href = '/Learning JS/dashboard.html';
            } else {
                window.location.href = '/Learning JS/console.html';
            }
        });

        // Navigate to notes
        document.getElementById('goToNotes').addEventListener('click', () => {
            window.location.href = '/Learning JS/notes.html';
        });

        // ============================================
        // WALLET SIGN IN MODAL
        // ============================================

        const walletModal = document.getElementById('walletModal');
        const walletSignInBtn = document.getElementById('walletSignInBtn');
        const walletClose = document.getElementById('walletClose');

        // Open wallet modal
        walletSignInBtn.addEventListener('click', () => {
            walletModal.style.display = 'block';
        });

        // Close wallet modal
        walletClose.addEventListener('click', () => {
            walletModal.style.display = 'none';
        });

        // Close on outside click
        window.addEventListener('click', (e) => {
            if (e.target === walletModal) {
                walletModal.style.display = 'none';
            }
        });

        // Wallet connection handlers
        document.getElementById('phantomBtn').addEventListener('click', async () => {
            await connectWallet('Phantom');
        });

        document.getElementById('solflareBtn').addEventListener('click', async () => {
            await connectWallet('Solflare');
        });

        document.getElementById('jupiterBtn').addEventListener('click', async () => {
            await connectWallet('Jupiter');
        });

        document.getElementById('walletConnectBtn').addEventListener('click', async () => {
            await connectWallet('WalletConnect');
        });

        async function connectWallet(walletType) {
            try {
                // Check if wallet is available
                if (walletType === 'Phantom') {
                    if (typeof window.solana !== 'undefined' && window.solana.isPhantom) {
                        const resp = await window.solana.connect();
                        const walletAddress = resp.publicKey.toString();
                        await handleWalletSignIn(walletAddress, walletType);
                    } else {
                        alert('Phantom wallet is not installed. Please install Phantom extension.');
                        window.open('https://phantom.app/', '_blank');
                    }
                } else if (walletType === 'Solflare') {
                    if (typeof window.solflare !== 'undefined') {
                        await window.solflare.connect();
                        const walletAddress = window.solflare.publicKey.toString();
                        await handleWalletSignIn(walletAddress, walletType);
                    } else {
                        alert('Solflare wallet is not installed. Please install Solflare extension.');
                        window.open('https://solflare.com/', '_blank');
                    }
                } else if (walletType === 'Jupiter') {
                    // Jupiter uses the standard Solana wallet adapter
                    if (typeof window.jupiter !== 'undefined') {
                        await window.jupiter.connect();
                        const walletAddress = window.jupiter.publicKey.toString();
                        await handleWalletSignIn(walletAddress, walletType);
                    } else {
                        alert('Jupiter wallet is not installed. Please visit Jupiter website.');
                        window.open('https://jup.ag/', '_blank');
                    }
                } else if (walletType === 'WalletConnect') {
                    alert('WalletConnect integration coming soon! Please use Phantom, Solflare, or Jupiter for now.');
                }
            } catch (error) {
                console.error('Wallet connection error:', error);
                alert('Failed to connect wallet: ' + error.message);
            }
        }

        async function handleWalletSignIn(walletAddress, walletType) {
            try {
                // Store wallet info in Firebase and localStorage
                const walletUserRef = ref(database, `wallet-users/${walletAddress}`);
                await set(walletUserRef, {
                    walletAddress: walletAddress,
                    walletType: walletType,
                    signedInAt: serverTimestamp(),
                    lastActive: serverTimestamp()
                });

                // Store in localStorage
                localStorage.setItem('currentUser', JSON.stringify({
                    uid: walletAddress,
                    walletAddress: walletAddress,
                    walletType: walletType,
                    displayName: `${walletType} User`,
                    email: null,
                    photoURL: null
                }));

                // Set flag for redirect
                sessionStorage.setItem('justSignedIn', 'true');

                // Close modal
                walletModal.style.display = 'none';

                // Show success message
                alert(`‚úÖ Connected with ${walletType}!\n\nWallet: ${walletAddress.substring(0, 6)}...${walletAddress.substring(38)}`);

                // Check if user has role, if not redirect to console
                const userRole = localStorage.getItem('userRole');
                if (!userRole) {
                    setTimeout(() => {
                        window.location.href = '/Learning JS/console.html';
                    }, 1500);
                } else {
                    setTimeout(() => {
                        window.location.href = '/Learning JS/dashboard.html';
                    }, 1500);
                }
            } catch (error) {
                console.error('Error saving wallet user:', error);
                alert('Failed to complete sign in. Please try again.');
            }
        }
    </script>

    <!-- Typing Animation -->
    <script>
        function typeWriter(element, text, speed = 100) {
            let i = 0;
            element.textContent = '';

            function type() {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                }
            }
            type();
        }

        // Initialize typing animation
        window.addEventListener('DOMContentLoaded', () => {
            const typingElement = document.getElementById('main-title');
            typeWriter(typingElement, 'Lunaris', 120);
        });
    </script>
</body>
</html>
